<div class="modal-dialog modal-lg" role="document">
    <div class="modal-content border-0 shadow roboto-condensed-regular">
        <div class="modal-header bg-gradient-primary text-white border-0">
            <h5 class="modal-title">
                <i class="fas fa-calendar-plus mr-2"></i>Nuevo Per칤odo de Pago
            </h5>
            <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
        </div>

        <form id="form-payment-period-create" method="POST" action="{% url 'apps.hrm:create_payment_period' %}">
            {% csrf_token %}
            <div class="modal-body p-4">
                <div class="row">
                    <!-- Selecci칩n de Empleado -->
                    <div class="col-md-6 mb-3">
                        <label for="employee" class="form-label">
                            <i class="fas fa-user mr-2"></i>Empleado <span class="text-danger">*</span>
                        </label>
                        <select class="form-control select2" id="employee" name="employee" required>
                            <option value="">Seleccionar empleado</option>
                            {% for template in employees %}
                                <option value="{{ template.employee.id }}"
                                        data-daily-rate="{{ template.daily_rate }}">
                                    {{ template.employee.first_name }} {{ template.employee.last_name }}
                                    (S/ {{ template.daily_rate|safe }})
                                </option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Tarifa Diaria -->
                    <div class="col-md-6 mb-3">
                        <label for="daily_rate" class="form-label">
                            <i class="fas fa-money-bill mr-2"></i>Tarifa Diaria (S/) <span class="text-danger">*</span>
                        </label>
                        <input type="number" class="form-control" id="daily_rate" name="daily_rate"
                               step="0.01" min="0" required readonly>
                        <small class="form-text text-muted">Se obtiene autom치ticamente de la plantilla del
                            empleado</small>
                    </div>
                </div>

                <div class="row">
                    <!-- Fecha de Inicio (Lunes) -->
                    <div class="col-md-6 mb-3">
                        <label for="start_date" class="form-label">
                            <i class="fas fa-calendar-day mr-2"></i>Fecha de Inicio (Lunes) <span
                                class="text-danger">*</span>
                        </label>
                        <input type="date" class="form-control" id="start_date" name="start_date"
                               value="{{ monday_date }}" required>
                        <small class="form-text text-muted">Debe ser un lunes</small>
                    </div>

                    <!-- Fecha de Fin (S치bado) -->
                    <div class="col-md-6 mb-3">
                        <label for="end_date" class="form-label">
                            <i class="fas fa-calendar-day mr-2"></i>Fecha de Fin (S치bado) <span
                                class="text-danger">*</span>
                        </label>
                        <input type="date" class="form-control" id="end_date" name="end_date"
                               value="{{ saturday_date }}" required>
                        <small class="form-text text-muted">Debe ser un s치bado</small>
                    </div>
                </div>

                <!-- Observaciones -->
                <div class="row">
                    <div class="col-12 mb-3">
                        <label for="notes" class="form-label">
                            <i class="fas fa-sticky-note mr-2"></i>Observaciones
                        </label>
                        <textarea class="form-control" id="notes" name="notes" rows="3"
                                  placeholder="Observaciones adicionales sobre el per칤odo de pago..."></textarea>
                    </div>
                </div>

                <!-- Vista Previa del Per칤odo -->
                <div class="row">
                    <div class="col-12">
                        <div class="card border-info">
                            <div class="card-header bg-gradient-primary">
                                <h6 class="mb-0 text-white">
                                    <i class="fas fa-eye mr-2"></i>Vista Previa del Per칤odo
                                </h6>
                            </div>
                            <div class="card-body">
                                <div id="period-preview">
                                    <p class="text-muted text-center">Selecciona un empleado y fechas para ver la vista
                                        previa</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            f

            <div class="modal-footer border-0 bg-light">
                <button type="button" class="btn btn-secondary rounded-pill" data-dismiss="modal">
                    <i class="fas fa-times mr-2"></i>Cancelar
                </button>
                <button type="submit" class="btn btn-primary rounded-pill" id="btn-create-period">
                    <i class="fas fa-save mr-2"></i>Crear Per칤odo
                </button>
            </div>
        </form>
    </div>
</div>

<style>
    .bg-gradient-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .modal-content {
        border-radius: 15px;
        overflow: hidden;
    }

    .form-control, .select2-container--default .select2-selection--single {
        border-radius: 10px;
        border: 2px solid #e9ecef;
        transition: all 0.3s ease;
    }

    .form-control:focus, .select2-container--default.select2-container--focus .select2-selection--single {
        border-color: #667eea;
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
    }

    .btn {
        border-radius: 25px !important;
        font-weight: 500;
        transition: all 0.3s ease;
    }

    .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    }

    .card {
        border-radius: 10px;
    }

    .form-label {
        font-weight: 600;
        color: #495057;
    }

    .select2-container--default .select2-selection--single {
        height: 38px;
        line-height: 38px;
    }

    .select2-container--default .select2-selection--single .select2-selection__rendered {
        line-height: 36px;
        padding-left: 15px;
    }

    .select2-container--default .select2-selection--single .select2-selection__arrow {
        height: 36px;
    }
</style>

<script>
    $(document).ready(function () {
        // Inicializar Select2
        $('.select2').select2({
            theme: 'bootstrap4',
            width: '100%'
        });

        // Actualizar tarifa diaria cuando se selecciona empleado
        $('#employee').on('change', function () {
            let selectedOption = $(this).find('option:selected');
            let dailyRate = parseFloat(selectedOption.attr('data-daily-rate'));
            console.log("dailyRate", dailyRate)
            console.log("dailyRate", parseFloat(dailyRate))

            if (dailyRate) {
                $('#daily_rate').val(dailyRate);
                updatePeriodPreview();
            } else {
                $('#daily_rate').val('');
                $('#period-preview').html('<p class="text-muted text-center">Selecciona un empleado y fechas para ver la vista previa</p>');
            }
        });

        // Actualizar vista previa cuando cambien las fechas
        $('#start_date, #end_date').on('change', function () {
            updatePeriodPreview();
        });

        // Funci칩n para actualizar vista previa
        function updatePeriodPreview() {
            let employee = $('#employee option:selected').text();
            let startDate = parseLocalDate($('#start_date').val());
            let endDate = parseLocalDate($('#end_date').val());
            let dailyRate = $('#daily_rate').val();

            if (employee && startDate && endDate && dailyRate) {
                let start = new Date(startDate);
                let end = new Date(endDate);
                let days = Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;

                if (days === 6 && start.getDay() === 1 && end.getDay() === 6) {
                    let totalAmount = days * parseFloat(dailyRate);

                    // 游댳 Formatear fechas a dd-mm-yyyy
                    let formatDate = (date) => {
                        let d = date.getDate().toString().padStart(2, '0');
                        let m = (date.getMonth() + 1).toString().padStart(2, '0');
                        let y = date.getFullYear();
                        return `${d}-${m}-${y}`;
                    };

                    let previewHtml = `
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Empleado:</strong> ${employee}</p>
                        <p><strong>Per칤odo:</strong> ${formatDate(start)} a ${formatDate(end)}</p>
                        <p><strong>D칤as:</strong> ${days} d칤as (Lunes a S치bado)</p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Tarifa diaria:</strong> S/ ${dailyRate}</p>
                        <p><strong>Total estimado:</strong> S/ ${totalAmount.toFixed(2)}</p>
                        <p><strong>Estado:</strong> <span class="badge badge-warning">Pendiente</span></p>
                    </div>
                </div>
            `;

                    $('#period-preview').html(previewHtml);
                } else {
                    $('#period-preview').html('<p class="text-danger text-center"><i class="fas fa-exclamation-triangle mr-2"></i>Las fechas deben ser de lunes a s치bado (6 d칤as)</p>');
                }
            }
        }

        function parseLocalDate(value) {
            let parts = value.split("-"); // ["2025","08","25"]
            return new Date(parts[0], parts[1] - 1, parts[2]); // a침o, mes-1, d칤a
        }

        // Validaci칩n del formulario
        $('#form-payment-period-create').on('submit', function (e) {
            e.preventDefault();

            let startDate = parseLocalDate($('#start_date').val());
            let endDate = parseLocalDate($('#end_date').val());
            // Validar que sea lunes
            if (startDate.getDay() !== 1) {
                toastr.error('La fecha de inicio debe ser un lunes', 'Error de Validaci칩n');
                return;
            }

            // Validar que sea s치bado
            if (endDate.getDay() !== 6) {
                toastr.error('La fecha de fin debe ser un s치bado', 'Error de Validaci칩n');
                return;
            }

            // Validar que el rango sea exactamente de lunes a s치bado (6 d칤as)
            let days = Math.floor((endDate - startDate) / (1000 * 60 * 60 * 24));
            if (days !== 5) {
                toastr.error('El per칤odo debe ser exactamente de 6 d칤as (lunes a s치bado)', 'Error de Validaci칩n');
                return;
            }
            // Enviar formulario
            submitForm();
        });

        function submitForm() {
            let formData = new FormData($('#form-payment-period-create')[0]);

            $.ajax({
                url: $('#form-payment-period-create').attr('action'),
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                beforeSend: function () {
                    $('#btn-create-period').prop('disabled', true).html('<i class="fas fa-spinner fa-spin mr-2"></i>Creando...');
                },
                success: function (response) {
                    if (response.success) {
                        toastr.success(response.message, '춰칄xito!');
                        $('#modal-payment-period-create').modal('hide');

                        // Recargar la p치gina para mostrar el nuevo per칤odo
                        setTimeout(function () {
                            location.reload();
                        }, 1500);
                    } else {
                        toastr.error(response.message, 'Error');
                    }
                },
                error: function (xhr) {
                    let message = 'Error al crear el per칤odo de pago';
                    if (xhr.responseJSON && xhr.responseJSON.message) {
                        message = xhr.responseJSON.message;
                    }
                    toastr.error(message, 'Error');
                },
                complete: function () {
                    $('#btn-create-period').prop('disabled', false).html('<i class="fas fa-save mr-2"></i>Crear Per칤odo');
                }
            });
        }
    });
</script>
