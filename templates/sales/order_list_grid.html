{% load sales_tags %}
{% if orders %}
    <div class="table-responsive">
        <table class="table table-striped table-hover table-sm align-middle">
            <thead class="thead-light">
                <tr>
                    <th style="width: 2%; font-size: 10px">#</th>
                    <th style="width: 6%; font-size: 10px">Fecha Creación</th>
                    <th style="width: 6%; font-size: 10px">Fecha Entrega</th>
                    <th style="width: 6%; font-size: 10px">Comprobante</th>
                    <th style="width: 17%; font-size: 10px">Cliente</th>
                    <th style="width: 5%; font-size: 10px">Cantidad</th>
                    <th style="width: 20%; font-size: 10px">Descripción</th>
                    <th style="width: 6%; font-size: 10px">A Cuenta</th>
                    <th style="width: 6%; font-size: 10px">Saldo</th>
                    <th style="width: 6%; font-size: 10px">Total</th>
                    <th style="width: 5%; font-size: 10px">Vendedor</th>
                    <th style="width: 5%; font-size: 10px">Estado Pago</th>
                    <th style="width: 5%; font-size: 10px">Estado Entrega</th>
                    <th style="width: 5%; font-size: 10px">Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for order in orders %}
                    <tr>
                        <td class="text-center">{{ forloop.counter }}</td>
                        <td class="text-center">
                            <small class="text-muted">
                                {{ order.register_date|date:"d/m/Y" }}
                            </small>
                        </td>
                        <td class="text-center">
                            {% if order.delivery_date %}
                                <small class="text-info">
                                    {{ order.delivery_date|date:"d/m/Y" }}
                                </small>
                            {% else %}
                                <small class="text-muted">-</small>
                            {% endif %}
                        </td>
                        <td class="text-center">
                            <span class="badge badge-success">
                                {{ order.subsidiary.serial }}-{{ order.correlative|stringformat:"03d" }}
                            </span>
                        </td>
                        <td>
                            <strong>{{ order.client.full_name }}</strong>
                            <br><small class="text-muted">
                                {% if order.client.document == '01' %}DNI{% else %}RUC{% endif %}: {{ order.client.number }}
                            </small>
                        </td>
                        <td class="text-center">
                            <span class="badge badge-info">
                                {{ order.orderdetail_set.count }}
                            </span>
                        </td>
                        <td>
                            {% for detail in order.orderdetail_set.all|slice:":2" %}
                                <small class="d-block text-primary font-weight-bold">
                                    {% if detail.product %}
                                        {{ detail.product.name }}
                                    {% else %}
                                        {{ detail.product_name|default:"Producto Manual" }}
                                    {% endif %}
                                    <br>
                                    {% if detail.observation %}
                                        Obs: ({{ detail.observation|upper|default:'' }})
                                    {% endif %}
                                </small>
                            {% endfor %}
                            {% if order.orderdetail_set.count > 2 %}
                                <small class="text-muted">+{{ order.orderdetail_set.count|add:"-2" }} más</small>
                            {% endif %}
                        </td>
                        <td class="text-right">
                            <span class="text-success font-weight-bold">
                                S/ {{ order.cash_advance|floatformat:2 }}
                            </span>
                        </td>
                        <td class="text-right">
                            {% if order.cash_advance > 0 %}
                                <span class="text-danger font-weight-bold">
                                    {{ order|calculate_balance|format_currency }}
                                </span>
                            {% elif order|calculate_balance < 0 %}
                                <span class="text-success font-weight-bold">
                                    {{ order|calculate_balance|format_currency|slice:"3:" }} (Excedente)
                                </span>
                            {% else %}
                                <span class="text-success font-weight-bold">
                                    S/ 0.00
                                </span>
                            {% endif %}
                        </td>
                        <td class="text-right">
                            <span class="font-weight-bold">
                                S/ {{ order.total|floatformat:2 }}
                            </span>
                        </td>
                        <td class="text-center">
                            <small class="text-muted text-center">
                                {{ order.user.first_name }}
                            </small>
                        </td>
                        <td class="text-center">
                            <div class="d-flex flex-column align-items-center">
                                <select class="form-control form-control-sm status-select mb-1" 
                                        data-order-id="{{ order.id }}" 
                                        data-status="{{ order.status }}"
                                        {% if order.status == 'C' %}disabled{% endif %}>
                                    <option value="P" {% if order.status == 'P' %}selected{% endif %}>PENDIENTE</option>
                                    <option value="C" {% if order.status == 'C' %}selected{% endif %}>COMPLETADO</option>
                                    <option value="A" {% if order.status == 'A' %}selected{% endif %}>ANULADO</option>
                                </select>
                            </div>
                        </td>
                        <td class="text-center">
                            <div class="d-flex flex-column align-items-center">
                                <select class="form-control form-control-sm delivery-select mb-1"
                                        data-order-id="{{ order.id }}"
                                        data-delivery-status="{{ order.delivery_status }}"
                                        onchange="updateOrderDeliveryStatus({{ order.id }}, this.value)"
                                        {% if order.delivery_status == 'E' or order.delivery_status == 'C' %}disabled{% endif %}>
                                    <option value="P" {% if order.delivery_status == 'P' %}selected{% endif %}>PENDIENTE</option>
                                    <option value="E" {% if order.delivery_status == 'E' %}selected{% endif %}>ENTREGADO</option>
                                    <option value="C" {% if order.delivery_status == 'C' %}selected{% endif %}>CANCELADO</option>
                                </select>
                            </div>
                        </td>
                        <td class="text-center">
                            <div class="btn-group" role="group">
                                <button type="button" class="btn btn-outline-info btn-sm" 
                                        onclick="showOrderDetail({{ order.id }})" 
                                        title="Ver Detalles">
                                    <i class="fas fa-eye fa-xs"></i>
                                </button>
                                <button type="button" class="btn btn-outline-primary btn-sm" 
                                        onclick="editOrder({{ order.id }})" 
                                        title="Editar">
                                    <i class="fas fa-edit fa-xs"></i>
                                </button>
                                <button type="button" class="btn btn-outline-success btn-sm" 
                                        onclick="downloadTicketPDF({{ order.id }})" 
                                        title="Descargar PDF del Ticket">
                                    <i class="fas fa-file-pdf fa-xs"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    <!-- Totales del Período -->
    {% if orders %}
        <div class="card mt-5">
            <div class="row ">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header bg-primary text-white">
                            <h6 class="card-title mb-0 text-white">
                                <i class="fas fa-calculator mr-2"></i>
                                RESUMEN DE TOTALES DEL PERÍODO
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <!-- Columna A Cuenta -->
                                <div class="col-md-3 text-center">
                                    <h6 class="text-muted mb-2">Total Ingreso</h6>
                                    <h4 class="text-success font-weight-bold">
                                        S/ {{ total_cash_advance|default:0|floatformat:2 }}
                                    </h4>
                                    <small class="text-muted">Total Real</small>
                                </div>

                                <!-- Columna Saldo -->
                                <div class="col-md-3 text-center">
                                    <h6 class="text-muted mb-2">Total Saldo Pendiente</h6>
                                    <h4 class="text-danger font-weight-bold">
                                        S/ {{ total_balance|default:0|floatformat:2 }}
                                    </h4>
                                    <small class="text-muted">Pendiente de cobro</small>
                                </div>

                                <!-- Columna Total -->
                                <div class="col-md-3 text-center">
                                    <h6 class="text-muted mb-2">Total Ventas</h6>
                                    <h4 class="text-primary font-weight-bold">
                                        S/ {{ total_sales|default:0|floatformat:2 }}
                                    </h4>
                                    <small class="text-muted">Ventas totales</small>
                                </div>

                                <!-- Columna Cantidad de Órdenes -->
                                <div class="col-md-3 text-center">
                                    <h6 class="text-muted mb-2">Cantidad de Órdenes</h6>
                                    <h4 class="text-info font-weight-bold">
                                        {{ orders|length }}
                                    </h4>
                                    <small class="text-muted">Órdenes del período</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    {% endif %}
    
{% else %}
    <div class="text-center py-5">
        <div class="text-muted">
            <i class="fas fa-calendar-day fa-3x mb-3 text-info"></i>
            <h5>No hay órdenes para el día de hoy</h5>
            <p class="mb-3">
                {% if date_from and date_to %}
                    No se encontraron órdenes del {{ date_from|date:"d/m/Y" }} al {{ date_to|date:"d/m/Y" }}.
                {% else %}
                    No hay órdenes registradas para el día de hoy ({{ date_now|date:"d/m/Y" }}).
                {% endif %}
            </p>
            <div class="d-flex justify-content-center gap-2">
                <button type="button" class="btn btn-success" onclick="openCreateOrderModal()">
                    <i class="fas fa-plus mr-1"></i>Crear Nueva Orden
                </button>
                <button type="button" class="btn btn-outline-info" onclick="loadOrders()">
                    <i class="fas fa-refresh mr-1"></i>Actualizar
                </button>
            </div>
        </div>
    </div>
{% endif %}



<style>
.badge {
    font-size: 0.75em;
    padding: 0.375em 0.75em;
}

.table td {
    vertical-align: middle;
    font-size: 0.775rem;
}

.table th {
    font-size: 0.875rem;
}

.order-detail-modal {
    z-index: 9999;
}

.btn-sm {
    padding: 0.25rem 0.5rem;
    font-size: 0.75rem;
}

.text-muted {
    font-size: 0.75rem;
}

.font-weight-bold {
    font-weight: 600;
}

/* Mejora visual ligera para apariencia más profesional */
table.table {
    border-radius: 0;
    overflow: hidden;
    width: 100%;
    margin-bottom: 0;
    border: none;
}

.table-responsive {
    border-radius: 0;
    box-shadow: none;
    border: 1px solid #dee2e6;
}

.table thead th {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border-bottom: 2px solid #dee2e6;
    font-weight: 600;
    color: #495057;
    padding: 0.75rem 0.5rem;
    vertical-align: middle;
}

.table tbody td {
    padding: 0.75rem 0.5rem;
    border-top: 1px solid #f1f3f4;
}

.table tbody tr:hover {
    background-color: #f8f9fa;
    transition: all 0.2s ease;
}

.table tbody tr:nth-child(even) {
    background-color: #fafbfc;
}

.table tbody tr:nth-child(even):hover {
    background-color: #f0f2f5;
}

.badge {
    font-size: 0.75rem;
    padding: 0.5rem 0.75rem;
    border-radius: 0.5rem;
    font-weight: 500;
}

.badge-primary {
    background-color: #007bff;
    color: white;
}

.badge-info {
    background-color: #17a2b8;
    color: white;
}

.btn-outline-primary {
    border-radius: 0.5rem;
    padding: 0.375rem 0.75rem;
    font-size: 0.875rem;
    transition: all 0.2s ease;
}

.btn-outline-primary:hover {
    background-color: #007bff;
    border-color: #007bff;
    color: white;
    transform: scale(1.05);
    transition: all 0.2s ease;
}

/* Estilos para los botones de acción */
.btn-group {
    box-shadow: none;
}

.btn-group .btn {
    margin: 0;
    border-radius: 0;
}

.btn-group .btn:first-child {
    border-top-left-radius: 0.5rem;
    border-bottom-left-radius: 0.5rem;
}

.btn-group .btn:last-child {
    border-top-right-radius: 0.5rem;
    border-bottom-right-radius: 0.5rem;
}

.btn-outline-info {
    border-color: #17a2b8;
    color: #17a2b8;
}

.btn-outline-info:hover {
    background-color: #17a2b8;
    border-color: #17a2b8;
    color: white;
}

.btn-outline-primary {
    border-color: #007bff;
    color: #007bff;
}

.btn-outline-primary:hover {
    background-color: #007bff;
    border-color: #007bff;
    color: white;
}

/* Responsive para botones en móviles */
@media (max-width: 768px) {
    .btn-group {
        display: flex;
        flex-direction: column;
    }
    
    .btn-group .btn {
        border-radius: 0.5rem !important;
        margin-bottom: 0.25rem;
    }
    
    .btn-group .btn:last-child {
        margin-bottom: 0;
    }
}

/* Estilos para el select de estado */
.status-select {
    font-size: 0.75rem;
    padding: 0.25rem 0.5rem;
    border-radius: 0.5rem;
    border: 2px solid #ced4da;
    background-color: white;
    transition: all 0.3s ease;
    cursor: pointer;
    min-width: 120px;
    text-align: center;
    font-weight: 600;
}

.status-select:focus {
    border-color: #007bff;
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
    outline: none;
}

.status-select:disabled {
    background-color: #e9ecef;
    color: #6c757d;
    cursor: not-allowed;
    opacity: 0.8;
    border-color: #ced4da;
}

/* Estilos específicos para cada estado */
.status-select option[value="P"] {
    color: #856404;
    background-color: #fff3cd;
    font-weight: 600;
}

.status-select option[value="C"] {
    color: #155724;
    background-color: #d4edda;
    font-weight: 600;
}

.status-select option[value="A"] {
    color: #721c24;
    background-color: #f8d7da;
    font-weight: 600;
}

/* Indicadores visuales para cada estado */
.status-select[data-status="P"] {
    border-color: #ffc107;
    background-color: #fff3cd;
    color: #856404;
}

.status-select[data-status="C"] {
    border-color: #28a745;
    background-color: #d4edda;
    color: #155724;
}

.status-select[data-status="A"] {
    border-color: #dc3545;
    background-color: #f8d7da;
    color: #721c24;
}

/* Hover effects */
.status-select:not(:disabled):hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

/* Indicadores de estado */
.text-warning {
    color: #ffc107 !important;
}

.text-success {
    color: #28a745 !important;
}

.text-danger {
    color: #dc3545 !important;
}

/* Estilos para el contenedor del estado */
.d-flex.flex-column.align-items-center {
    min-width: 140px;
}

/* Responsive para el select de estado */
@media (max-width: 768px) {
    .status-select {
        font-size: 0.7rem;
        padding: 0.2rem 0.4rem;
        min-width: 100px;
    }
    
    .d-flex.flex-column.align-items-center {
        min-width: 120px;
    }
}

/* Estilos para el resumen de totales */
.card-header.bg-primary {
    background: linear-gradient(135deg, #007bff 0%, #0056b3 100%) !important;
}

.card-header h6 {
    font-weight: 600;
    letter-spacing: 0.5px;
}

.card-body h4 {
    margin-bottom: 0.5rem;
    font-weight: 700;
}

.card-body h6 {
    font-weight: 600;
    color: #6c757d;
}

.card-body small {
    font-size: 0.75rem;
    color: #6c757d;
}

/* Colores específicos para cada total */
.text-success.font-weight-bold {
    color: #28a745 !important;
}

.text-danger.font-weight-bold {
    color: #dc3545 !important;
}

.text-primary.font-weight-bold {
    color: #007bff !important;
}

.text-info.font-weight-bold {
    color: #17a2b8 !important;
}

/* Responsive para el resumen de totales */
@media (max-width: 768px) {
    .card-body .row > div {
        margin-bottom: 1rem;
    }
    
    .card-body h4 {
        font-size: 1.5rem;
    }
    
    .card-body h6 {
        font-size: 0.9rem;
    }
}
</style>

