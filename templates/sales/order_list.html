{% extends 'home.html' %}
{% load static %}

{% block title %}
    Gestión de Órdenes
{% endblock title %}

{% block body %}
    <div class="container-fluid pt-2 roboto-condensed-regular">
        <!-- Content Header (Page header) -->
        <div class="content-header">
            <div class="container-fluid">
                <div class="row mb-2">
                    <div class="col-sm-6">
                        <h1 class="m-0 text-dark">
                            <i class="fas fa-file-alt mr-2"></i>Gestión de Órdenes
                            <small class="d-block text-muted mt-1">
                                <i class="fas fa-calendar-day mr-1"></i>
                                <span id="date-indicator">Mostrando órdenes del día de hoy</span>
                            </small>
                        </h1>
                    </div>

                </div>
            </div>
        </div>

        <!-- Main content -->
        <div class="content">
            <div class="container-fluid">
                <!-- Filtros de búsqueda -->
                <div class="row">
                    <div class="col-12">
                        <div class="card card-secondary card-outline compact-filters">
                            <div class="card-header compact-header">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div class="d-flex align-items-center">
                                        <h6 class="card-title mb-0">
                                            <i class="fas fa-search mr-2"></i>Filtros de Búsqueda
                                        </h6>
                                        <button type="button" class="btn btn-success ml-3"
                                                onclick="openCreateOrderModal()">
                                            <i class="fas fa-plus mr-1"></i>Nueva Orden
                                        </button>
                                    </div>
                                    <div class="card-tools">
                                        <button type="button" class="btn btn-outline-secondary btn-sm"
                                                id="toggle-filters" title="Colapsar/Expandir filtros">
                                            <i class="fas fa-chevron-up" id="toggle-icon"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="card-body compact-body">
                                <!-- Mensaje informativo compacto -->
                                <div class="alert alert-info alert-sm mb-2" role="alert">
                                    <i class="fas fa-info-circle mr-1"></i>
                                    <small><strong>Por defecto se muestran las órdenes del día actual.</strong> Use los
                                        filtros para ver otros períodos. <strong>El filtro de cliente permite búsqueda
                                            por nombre o documento con autocompletado.</strong></small>
                                </div>

                                <form id="search-form">
                                    <div class="row g-2">
                                        <div class="col-md-2">
                                            <div class="form-group mb-1">
                                                <label for="date-from" class="form-label-sm">Fecha Desde</label>
                                                <input type="date" class="form-control form-control-sm"
                                                       value="{{ date_now }}"
                                                       id="date-from" name="date_from">
                                            </div>
                                        </div>
                                        <div class="col-md-2">
                                            <div class="form-group mb-1">
                                                <label for="date-to" class="form-label-sm">Fecha Hasta</label>
                                                <input type="date" class="form-control form-control-sm"
                                                       value="{{ date_now }}"
                                                       id="date-to" name="date_to">
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="form-group mb-1">
                                                <label for="client-search" class="form-label-sm">Buscar Cliente</label>
                                                <div class="input-group">
                                                    <input type="text" class="form-control form-control-sm"
                                                           id="client-search" name="client_search"
                                                           placeholder="Nombre o documento del cliente"
                                                           autocomplete="off">
                                                    <div class="input-group-append">
                                                        <button type="button" class="btn btn-outline-secondary btn-sm"
                                                                onclick="clearClientFilter()" title="Limpiar cliente">
                                                            <i class="fas fa-times"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                                <input type="hidden" id="client-id-filter" name="client_id_filter"
                                                       value="">
                                                <div id="client-suggestions" class="client-suggestions"
                                                     style="display: none;"></div>
                                            </div>
                                        </div>
                                        <div class="col-md-2">
                                            <div class="form-group mb-1">
                                                <label for="subsidiary-filter" class="form-label-sm">Sucursal</label>
                                                <select class="form-control form-control-sm" id="subsidiary-filter"
                                                        name="subsidiary">
                                                    <option value="0">Todas las sucursales</option>
                                                    {% for subsidiary in subsidiary_set %}
                                                        <option value="{{ subsidiary.id }}">{{ subsidiary.name }}</option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                        </div>
                                        <div class="col-md-2">
                                            <div class="form-group mb-1">
                                                <label for="user-filter" class="form-label-sm">Vendedor</label>
                                                <select class="form-control form-control-sm" id="user-filter"
                                                        name="user">
                                                    <option value="0">Todos los vendedores</option>
                                                    {% for user in user_set %}
                                                        <option value="{{ user.id }}">{{ user.first_name }}</option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                        </div>
                                        <div class="col-md-2">
                                            <div class="form-group mb-1">
                                                <label for="order-type-filter" class="form-label-sm">Tipo de
                                                    Orden</label>
                                                <select class="form-control form-control-sm" id="order-type-filter"
                                                        name="order_type">
                                                    <option value="0">Todos los tipos</option>
                                                    <option value="C">Cotización</option>
                                                    <option value="O">Orden de Servicio</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="col-md-2">
                                            <div class="form-group mb-1">
                                                <label for="status-filter" class="form-label-sm">Estado</label>
                                                <select class="form-control form-control-sm" id="status-filter"
                                                        name="status">
                                                    <option value="0">Todos los estados</option>
                                                    <option value="P">Pendiente</option>
                                                    <option value="C">Completado</option>
                                                    <option value="A">Anulado</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row mt-2">
                                        <div class="col-12 text-center">
                                            <button type="submit" class="btn btn-primary btn-sm mr-2">
                                                <i class="fas fa-search mr-1"></i>Buscar
                                            </button>
                                            <button type="button" class="btn btn-secondary btn-sm" id="clear-filters">
                                                <i class="fas fa-times mr-1"></i>Limpiar
                                            </button>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Resultados -->
                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <div class="d-flex justify-content-between align-items-center">
                                    <h3 class="card-title mb-0">
                                        <i class="fas fa-list mr-2"></i>Listado de Órdenes
                                        <small class="text-muted ml-2" id="orders-count">
                                            <i class="fas fa-info-circle mr-1"></i>
                                            <span id="orders-count-text">Cargando...</span>
                                        </small>
                                    </h3>
                                    <div class="card-tools">
                                        <button type="button" class="btn btn-outline-primary btn-sm"
                                                onclick="loadOrders()" title="Actualizar listado">
                                            <i class="fas fa-refresh"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="card-body p-0">
                                <div id="orders-grid" class="w-100">
                                    <!-- Aquí se cargará la grilla de órdenes -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para crear nueva orden -->
    <div class="modal fade" id="createOrderModal" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-xl" role="document">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-plus-circle mr-2"></i>Nueva Orden
                    </h5>
                    <button type="button" class="close text-white" data-dismiss="modal">
                        <span>&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="order-form">
                        <!-- Información General -->
                        <div class="row mb-3">
                            <div class="col-12">
                                <h6 class="text-primary border-bottom pb-2">
                                    <i class="fas fa-info-circle mr-2"></i>Información General
                                </h6>
                            </div>
                        </div>

                        <!-- Cliente en fila completa -->
                        <div class="row mb-3">
                            <div class="col-12">
                                <div class="form-group mb-0">
                                    <label for="client_id" class="form-label">
                                        <i class="fas fa-user-circle mr-1"></i>Cliente <span
                                            class="text-danger">*</span>
                                    </label>
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="client_search_input"
                                               placeholder="Escriba para buscar cliente..." autocomplete="off">
                                        <input type="hidden" id="client_id" name="client_id" required>
                                        <div class="input-group-append">
                                            <button type="button" class="btn btn-success"
                                                    onclick="openCreateClientModal()" title="Crear nuevo cliente">
                                                <i class="fas fa-plus"></i>
                                            </button>
                                            <button type="button" class="btn btn-outline-danger btn-clear-client"
                                                    onclick="clearClientSelection()"
                                                    title="Limpiar cliente seleccionado" style="display: none;">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div id="client_autocomplete_results" class="client-autocomplete-results"
                                         style="display: none;"></div>
                                    <small class="form-text text-muted">
                                        <i class="fas fa-info-circle mr-1"></i>
                                        Escriba el nombre o documento del cliente para buscar rápidamente
                                    </small>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-3">
                                <div class="form-group mb-3">
                                    <label for="order_type" class="form-label">
                                        <i class="fas fa-tag mr-1"></i>Tipo de Orden <span class="text-danger">*</span>
                                    </label>
                                    <select class="form-control" id="order_type" name="order_type" required>
                                        <option value="">Seleccione tipo</option>
                                        <option value="C">Cotización</option>
                                        <option selected value="O">Orden de Servicio</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label for="subsidiary_id" class="form-label">
                                        <i class="fas fa-building mr-1"></i>Sucursal <span class="text-danger">*</span>
                                    </label>
                                    <select class="form-control" id="subsidiary_id" name="subsidiary_id" required>
                                        <option value="">Seleccione sucursal</option>
                                        {% for subsidiary in subsidiary_set %}
                                            <option value="{{ subsidiary.id }}" data-serial="{{ subsidiary.serial }}">
                                                {{ subsidiary.name }}
                                            </option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group mb-3">
                                    <label for="serial" class="form-label">
                                        <i class="fas fa-hashtag mr-1"></i>Serie
                                    </label>
                                    <input type="text" class="form-control" id="serial" name="serial" readonly>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group mb-3">
                                    <label for="correlative" class="form-label">
                                        <i class="fas fa-sort-numeric-up mr-1"></i>Correlativo
                                    </label>
                                    <input type="text" class="form-control" id="correlative" name="correlative"
                                           readonly>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label for="user_id" class="form-label">
                                        <i class="fas fa-user-tie mr-1"></i>Vendedor <span class="text-danger">*</span>
                                    </label>
                                    <select class="form-control" id="user_id" name="user_id" required>
                                        <option value="">Seleccione vendedor</option>
                                        {% for user in user_set %}
                                            <option value="{{ user.id }}">{{ user.first_name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group mb-3">
                                    <label for="register_date" class="form-label">
                                        <i class="fas fa-calendar mr-1"></i>Fecha <span class="text-danger">*</span>
                                    </label>
                                    <input type="date" class="form-control" id="register_date" name="register_date"
                                           value="{{ date_now }}" required>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group mb-3">
                                    <label for="delivery_date" class="form-label">
                                        <i class="fas fa-calendar-check mr-1"></i>Fecha de Entrega
                                    </label>
                                    <input type="date" class="form-control" id="delivery_date" name="delivery_date">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group mb-3">
                                    <label for="voucher_type" class="form-label">
                                        <i class="fas fa-receipt mr-1"></i>Tipo de Comprobante
                                    </label>
                                    <select class="form-control" id="voucher_type" name="voucher_type">
                                        <option value="T">TICKET</option>
                                        <option value="B">BOLETA</option>
                                        <option value="F">FACTURA</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-3">
                                <div class="form-group mb-3">
                                    <label for="way_to_pay" class="form-label">
                                        <i class="fas fa-credit-card mr-1"></i>Forma de Pago
                                    </label>
                                    <select class="form-control" id="way_to_pay" name="way_to_pay">
                                        <option value="E">Efectivo</option>
                                        <option value="Y">Yape</option>
                                        <option value="D">Deposito y/o Transferencia</option>
                                        <option value="C">Crédito</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group mb-3">
                                    <label for="cash_account_id" class="form-label">
                                        <i class="fas fa-university mr-1"></i>Cuenta de Caja
                                    </label>
                                    <select class="form-control" id="cash_account_id" name="cash_account_id">
                                        <option value="">Seleccione cuenta</option>
                                        {% for cash in cash_accounts %}
                                            <option value="{{ cash.id }}">{{ cash.name }}
                                                - {{ cash.subsidiary.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <!-- Espacio para futuras expansiones -->
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-12">
                                <div class="form-group mb-0">
                                    <label for="observation" class="form-label">
                                        <i class="fas fa-comment mr-1"></i>Observaciones
                                    </label>
                                    <textarea class="form-control" id="observation" name="observation"
                                              rows="3"
                                              placeholder="Observaciones adicionales, notas especiales, instrucciones de entrega, etc."></textarea>
                                </div>
                            </div>
                        </div>

                        <!-- Detalles de Productos/Servicios -->
                        <div class="row mt-4">
                            <div class="col-12">
                                <h6 class="text-success border-bottom pb-2">
                                    <i class="fas fa-boxes mr-2"></i>Productos y Servicios
                                </h6>
                            </div>
                        </div>

                        <!-- Buscador de Productos -->
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <div class="form-group mb-0">
                                    <label for="product_search" class="form-label">
                                        <i class="fas fa-search mr-1"></i>Buscar Producto
                                    </label>
                                    <input type="text" class="form-control" id="product_search"
                                           placeholder="Nombre o código del producto">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group mb-0">
                                    <label for="product_category_filter" class="form-label">
                                        <i class="fas fa-filter mr-1"></i>Categoría
                                    </label>
                                    <select class="form-control" id="product_category_filter">
                                        <option value="0">Todas las categorías</option>
                                        {% for category in product_set|slice:":10" %}
                                            <option value="{{ category.product_category.id }}">{{ category.product_category.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group mb-0">
                                    <label for="product_type_filter" class="form-label">
                                        <i class="fas fa-tags mr-1"></i>Tipo
                                    </label>
                                    <select class="form-control" id="product_type_filter">
                                        <option value="">Todos los tipos</option>
                                        <option value="P">Producto</option>
                                        <option value="S">Servicio</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="form-group mb-0">
                                    <label class="form-label">&nbsp;</label>
                                    <button type="button" class="btn btn-primary btn-block" onclick="searchProducts()">
                                        <i class="fas fa-search"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Lista de Productos Encontrados -->
                        <div class="row mb-3" id="products_results" style="display: none;">
                            <div class="col-12">
                                <div class="card">
                                    <div class="card-header bg-light">
                                        <h6 class="mb-0">Productos Encontrados</h6>
                                    </div>
                                    <div class="card-body" style="max-height: 200px; overflow-y: auto;">
                                        <div id="products_list"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Tabla de Detalles -->
                        <div class="row">
                            <div class="col-12">
                                <!-- Explicación del cálculo -->
                                <div class="alert alert-info alert-sm mb-2" role="alert">
                                    <i class="fas fa-calculator mr-1"></i>
                                    <small><strong>Lógica de cálculo:</strong> El total se calcula como (cantidad ×
                                        precio), luego se extrae el IGV para obtener el subtotal sin impuestos. El
                                        adelanto se resta del total final.</small>
                                    {#                                    <br><small class="text-muted"><strong>Ejemplo:</strong> 9 × S/ 50 = S/ 450 (total) →#}
                                    {#                                    Subtotal: S/ 381.36, IGV: S/ 68.64</small>#}
                                </div>

                                <div class="table-responsive">
                                    <table class="table table-striped table-sm" id="order_details_table">
                                        <thead class="thead-dark">
                                        <tr>
                                            <th class="text-dark" style="width: 5%">#</th>
                                            <th class="text-dark" style="width: 55%">Producto/Servicio</th>
                                            {#                                            <th class="text-dark" style="width: 25%">Observación</th>#}
                                            <th class="text-dark" style="width: 10%">Cant.</th>
                                            <th class="text-dark" style="width: 15%">Precio</th>
                                            <th class="text-dark" style="width: 10%">Subtotal</th>
                                            <th class="text-dark text-center" style="width: 5%"><i
                                                    class="fas fa-trash fa-2xs"></i></th>
                                        </tr>
                                        </thead>
                                        <tbody id="order_details_body">
                                        <!-- Los detalles se agregarán dinámicamente aquí -->
                                        </tbody>
                                        <tfoot class="table-info">
                                        <tr>
                                            <td colspan="4" class="text-right font-weight-bold">Subtotal:</td>
                                            <td class="text-right font-weight-bold" id="subtotal_total">S/ 0.00</td>
                                            <td></td>
                                        </tr>
                                        <tr>
                                            <td colspan="4" class="text-right font-weight-bold">
                                                IGV (calculado al total):
                                                <small class="d-block text-muted">Total - Subtotal sin IGV</small>
                                            </td>
                                            <td class="text-right font-weight-bold" id="igv_total">S/ 0.00</td>
                                            <td></td>
                                        </tr>
                                        <tr class="table-warning">
                                            <td colspan="4" class="text-right font-weight-bold">Total (precio final):
                                            </td>
                                            <td class="text-right font-weight-bold" id="total_final">S/ 0.00</td>
                                            <td></td>
                                        </tr>
                                        <tr class="table-success">
                                            <td colspan="4" class="text-right font-weight-bold">
                                                Adelanto:
                                                <small class="d-block text-muted">Se resta del total final</small>
                                            </td>
                                            <td class="text-right">
                                                <input type="text" class="form-control form-control-sm text-right"
                                                       id="advance_input" name="advance_input"
                                                       value="0"
                                                       placeholder="0.00"
                                                       onkeyup="updateAdvance()">
                                            </td>
                                            <td></td>
                                        </tr>
                                        <tr class="table-danger">
                                            <td colspan="4" class="text-right font-weight-bold h6">Faltante:</td>
                                            <td class="text-right font-weight-bold h6" id="remaining_amount">S/ 0.00
                                            </td>
                                            <td></td>
                                        </tr>
                                        </tfoot>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <!-- Botón para agregar producto manualmente -->
                        <div class="row mt-2">
                            <div class="col-12 text-center">
                                <button type="button" class="btn btn-outline-success btn-sm"
                                        onclick="addEmptyProductRow()">
                                    <i class="fas fa-plus mr-1"></i>Agregar Producto Manualmente
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">
                        <i class="fas fa-times mr-1"></i>Cancelar
                    </button>
                    <button type="button" class="btn btn-primary" onclick="saveOrder()">
                        <i class="fas fa-save mr-1"></i>Guardar Orden
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para crear nuevo cliente -->
    <div class="modal fade" id="createClientModal" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-md" role="document">
            <div class="modal-content">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-user-plus mr-2"></i>Nuevo Cliente
                    </h5>
                    <button type="button" class="close text-white" data-dismiss="modal">
                        <span>&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="create-client-form">
                        <div class="form-group">
                            <label for="new_client_document" class="form-label">
                                <i class="fas fa-id-card mr-1"></i>Tipo de Documento
                            </label>
                            <select class="form-control" id="new_client_document" name="document">
                                <option value="">Sin documento</option>
                                <option value="01">DNI</option>
                                <option value="06">RUC</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="new_client_number" class="form-label">
                                <i class="fas fa-hashtag mr-1"></i>Número de Documento
                            </label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="new_client_number" name="number"
                                       placeholder="Opcional" autocomplete="off">
                                <div class="input-group-append">
                                    <button type="button" class="btn btn-outline-primary" onclick="searchClientInAPI()"
                                            title="Buscar en sistema externo">
                                        <i class="fas fa-search"></i>
                                    </button>
                                </div>
                            </div>
                            <small class="form-text text-info">
                                <i class="fas fa-info-circle mr-1"></i>
                                Presione <kbd>Enter</kbd> o haga clic en el botón de búsqueda para consultar
                                automáticamente
                            </small>
                        </div>

                        <!-- Indicador de cliente listo para seleccionar -->
                        {#                        <div id="client-ready-indicator" class="alert alert-success" style="display: none;">#}
                        {#                            <i class="fas fa-check-circle mr-2"></i>#}
                        {#                            <strong>Cliente listo para seleccionar:</strong>#}
                        {#                            <span id="ready-client-name"></span>#}
                        {#                            <button type="button" class="btn btn-sm btn-outline-success ml-2" onclick="selectClientFromModal()">#}
                        {#                                <i class="fas fa-check mr-1"></i>Seleccionar#}
                        {#                            </button>#}
                        {#                        </div>#}
                        <div class="form-group">
                            <label for="new_client_name" class="form-label">
                                <i class="fas fa-user mr-1"></i>Nombre Completo <span class="text-danger">*</span>
                            </label>
                            <input type="text" class="form-control" autocomplete="off"
                                   id="new_client_name" name="full_name" required>
                        </div>
                        <div class="form-group">
                            <label for="new_client_address" class="form-label">
                                <i class="fas fa-map-marker-alt mr-1"></i>Dirección
                            </label>
                            <textarea class="form-control" id="new_client_address" name="address" rows="2"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="new_client_phone" class="form-label">
                                <i class="fas fa-phone mr-1"></i>Teléfono
                            </label>
                            <input type="text" class="form-control" id="new_client_phone" name="phone">
                        </div>
                        <div class="form-group">
                            <label for="new_client_email" class="form-label">
                                <i class="fas fa-envelope mr-1"></i>Email
                            </label>
                            <input type="email" class="form-control" id="new_client_email" name="email">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">
                        <i class="fas fa-times mr-1"></i>Cancelar
                    </button>
                    <button type="button" class="btn btn-info" onclick="saveNewClient()">
                        <i class="fas fa-save mr-1"></i>Guardar Cliente
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para editar orden -->
    <div class="modal fade" id="editOrderModal" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-xl" role="document">
            <div class="modal-content">
                <div class="modal-header bg-warning text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-edit mr-2"></i>Editar Orden
                    </h5>
                    <button type="button" class="close text-white" data-dismiss="modal">
                        <span>&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="edit-order-form">
                        <input type="hidden" id="edit_order_id" name="order_id" value="">
                        <input type="hidden" id="edit_order_id_for_update" name="id">
                        <input type="hidden" id="edit_order_id_hidden" name="order_id_hidden" value="">

                        <!-- Información General -->
                        <div class="row mb-3">
                            <div class="col-12">
                                <h6 class="text-primary border-bottom pb-2">
                                    <i class="fas fa-info-circle mr-2"></i>Información General
                                </h6>
                            </div>
                        </div>

                        <!-- Cliente en fila completa -->
                        <div class="row mb-3">
                            <div class="col-12">
                                <div class="form-group">
                                    <label for="edit_client_id" class="form-label">
                                        <i class="fas fa-user-circle mr-1"></i>Cliente <span
                                            class="text-danger">*</span>
                                    </label>
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="edit_client_search_input"
                                               placeholder="Escriba para buscar cliente..." autocomplete="off">
                                        <input type="hidden" id="edit_client_id" name="client_id" required>
                                        <div class="input-group-append">
                                            <button type="button" class="btn btn-outline-success"
                                                    onclick="openCreateClientModal()" title="Crear nuevo cliente">
                                                <i class="fas fa-plus"></i>
                                            </button>
                                            <button type="button" class="btn btn-outline-danger btn-clear-client"
                                                    onclick="clearEditClientSelection()"
                                                    title="Limpiar cliente seleccionado" style="display: none;">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div id="edit_client_autocomplete_results" class="client-autocomplete-results"
                                         style="display: none;"></div>
                                    <small class="form-text text-muted">
                                        <i class="fas fa-info-circle mr-1"></i>
                                        Escriba el nombre o documento del cliente para buscar rápidamente
                                    </small>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label for="edit_order_type" class="form-label">
                                        <i class="fas fa-tag mr-1"></i>Tipo de Orden <span class="text-danger">*</span>
                                    </label>
                                    <select class="form-control" id="edit_order_type" name="order_type" required>
                                        <option value="">Seleccione tipo</option>
                                        <option value="C">Cotización</option>
                                        <option value="O">Orden de Servicio</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label for="edit_subsidiary_id" class="form-label">
                                        <i class="fas fa-building mr-1"></i>Sucursal <span class="text-danger">*</span>
                                    </label>
                                    <select class="form-control" id="edit_subsidiary_id" name="subsidiary_id" required>
                                        <option value="">Seleccione sucursal</option>
                                        {% for subsidiary in subsidiary_set %}
                                            <option value="{{ subsidiary.id }}" data-serial="{{ subsidiary.serial }}">
                                                {{ subsidiary.name }}
                                            </option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label for="edit_serial" class="form-label">
                                        <i class="fas fa-hashtag mr-1"></i>Serie
                                    </label>
                                    <input type="text" class="form-control" id="edit_serial" name="serial" readonly>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label for="edit_correlative" class="form-label">
                                        <i class="fas fa-sort-numeric-up mr-1"></i>Correlativo
                                    </label>
                                    <input type="text" class="form-control" id="edit_correlative" name="correlative"
                                           readonly>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label for="edit_user_id" class="form-label">
                                        <i class="fas fa-user-tie mr-1"></i>Vendedor <span class="text-danger">*</span>
                                    </label>
                                    <select class="form-control" id="edit_user_id" name="user_id" required>
                                        <option value="">Seleccione vendedor</option>
                                        {% for user in user_set %}
                                            <option value="{{ user.id }}">{{ user.first_name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label for="edit_register_date" class="form-label">
                                        <i class="fas fa-calendar mr-1"></i>Fecha <span class="text-danger">*</span>
                                    </label>
                                    <input type="date" class="form-control" id="edit_register_date" name="register_date"
                                           required>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label for="edit_delivery_date" class="form-label">
                                        <i class="fas fa-calendar-check mr-1"></i>Fecha de Entrega
                                    </label>
                                    <input type="date" class="form-control" id="edit_delivery_date"
                                           name="delivery_date">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label for="edit_voucher_type" class="form-label">
                                        <i class="fas fa-receipt mr-1"></i>Tipo de Comprobante
                                    </label>
                                    <select class="form-control" id="edit_voucher_type" name="voucher_type">
                                        <option value="T">TICKET</option>
                                        <option value="B">BOLETA</option>
                                        <option value="F">FACTURA</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label for="edit_way_to_pay" class="form-label">
                                        <i class="fas fa-credit-card mr-1"></i>Forma de Pago
                                    </label>
                                    <select class="form-control" id="edit_way_to_pay" name="way_to_pay">
                                        <option value="E">Efectivo</option>
                                        <option value="Y">Yape</option>
                                        <option value="D">Deposito y/o Transferencia</option>
                                        <option value="C">Crédito</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label for="edit_cash_advance" class="form-label">
                                        <i class="fas fa-money-bill-wave mr-1"></i>Adelanto
                                    </label>
                                    <input type="text" class="form-control" id="edit_cash_advance" name="cash_advance"
                                           onkeyup="updateEditAdvanceFromMain()">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <!-- Espacio para futuras expansiones -->
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-12">
                                <div class="form-group">
                                    <label for="edit_observation" class="form-label">
                                        <i class="fas fa-comment mr-1"></i>Observaciones
                                    </label>
                                    <textarea class="form-control" id="edit_observation" name="observation"
                                              rows="3"
                                              placeholder="Observaciones adicionales, notas especiales, instrucciones de entrega, etc."></textarea>
                                </div>
                            </div>
                        </div>

                        <!-- Detalles de Productos/Servicios -->
                        <div class="row mt-4">
                            <div class="col-12">
                                <h6 class="text-success border-bottom pb-2">
                                    <i class="fas fa-boxes mr-2"></i>Productos y Servicios
                                </h6>
                            </div>
                        </div>

                        <!-- Buscador de Productos -->
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="edit_product_search" class="form-label">
                                        <i class="fas fa-search mr-1"></i>Buscar Producto
                                    </label>
                                    <input type="text" class="form-control" id="edit_product_search"
                                           placeholder="Nombre o código del producto">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label for="edit_product_category_filter" class="form-label">
                                        <i class="fas fa-filter mr-1"></i>Categoría
                                    </label>
                                    <select class="form-control" id="edit_product_category_filter">
                                        <option value="0">Todas las categorías</option>
                                        {% for category in product_set|slice:":10" %}
                                            <option value="{{ category.product_category.id }}">{{ category.product_category.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label for="edit_product_type_filter" class="form-label">
                                        <i class="fas fa-tags mr-1"></i>Tipo
                                    </label>
                                    <select class="form-control" id="edit_product_type_filter">
                                        <option value="">Todos los tipos</option>
                                        <option value="P">Producto</option>
                                        <option value="S">Servicio</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="form-group">
                                    <label class="form-label">&nbsp;</label>
                                    <button type="button" class="btn btn-primary btn-block"
                                            onclick="searchEditProducts()">
                                        <i class="fas fa-search"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Lista de Productos Encontrados -->
                        <div class="row mb-3" id="edit_products_results" style="display: none;">
                            <div class="col-12">
                                <div class="card">
                                    <div class="card-header bg-light">
                                        <h6 class="mb-0">Productos Encontrados</h6>
                                    </div>
                                    <div class="card-body" style="max-height: 200px; overflow-y: auto;">
                                        <div id="edit_products_list"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Tabla de Detalles -->
                        <div class="row">
                            <div class="col-12">
                                <!-- Explicación del cálculo -->
                                <div class="alert alert-info alert-sm mb-2" role="alert">
                                    <i class="fas fa-calculator mr-1"></i>
                                    <small><strong>Lógica de cálculo:</strong> El total se calcula como (cantidad ×
                                        precio), luego se extrae el IGV para obtener el subtotal sin impuestos. El
                                        adelanto se resta del total final.</small>
                                    <br><small class="text-muted"><strong>Ejemplo:</strong> 9 × S/ 50 = S/ 450 (total) →
                                    Subtotal: S/ 381.36, IGV: S/ 68.64</small>
                                </div>

                                <div class="table-responsive">
                                    <table class="table table-striped table-sm" id="edit_order_details_table">
                                        <thead class="thead-dark">
                                        <tr>
                                            <th class="text-dark" style="width: 5%">#</th>
                                            <th class="text-dark" style="width: 55%">Producto/Servicio</th>
                                            {#                                            <th class="text-dark" style="width: 25%">Observación</th>#}
                                            <th class="text-dark" style="width: 10%">Cant.</th>
                                            <th class="text-dark" style="width: 15%">Precio</th>
                                            <th class="text-dark" style="width: 10%">Subtotal</th>
                                            <th class="text-dark text-center" style="width: 5%"><i
                                                    class="fas fa-trash fa-2xs"></i></th>
                                        </tr>
                                        </thead>
                                        <tbody id="edit_order_details_body">
                                        <!-- Los detalles se agregarán dinámicamente aquí -->
                                        </tbody>
                                        <tfoot class="table-info">
                                        <tr>
                                            <td colspan="4" class="text-right font-weight-bold">Subtotal:</td>
                                            <td class="text-right font-weight-bold" id="edit_subtotal_total">S/ 0.00
                                            </td>
                                            <td></td>
                                        </tr>
                                        <tr>
                                            <td colspan="4" class="text-right font-weight-bold">
                                                IGV (calculado al total):
                                                <small class="d-block text-muted">Total - Subtotal sin IGV</small>
                                            </td>
                                            <td class="text-right font-weight-bold" id="edit_igv_total">S/ 0.00</td>
                                            <td></td>
                                        </tr>
                                        <tr class="table-warning">
                                            <td colspan="4" class="text-right font-weight-bold">Total (precio final):
                                            </td>
                                            <td class="text-right font-weight-bold" id="edit_total_final">S/ 0.00</td>
                                            <td></td>
                                        </tr>
                                        <tr class="table-success">
                                            <td colspan="4" class="text-right font-weight-bold">
                                                Adelanto:
                                                <small class="d-block text-muted">Se resta del total final</small>
                                            </td>
                                            <td class="text-right">
                                                <input type="number" class="form-control form-control-sm text-right"
                                                       id="edit_advance_input" name="advance_input"
                                                       min="0" step="0.01" value="0"
                                                       placeholder="0.00"
                                                       onkeyup="updateEditAdvance()">
                                            </td>
                                            <td></td>
                                        </tr>
                                        <tr class="table-danger">
                                            <td colspan="4" class="text-right font-weight-bold h6">Faltante:</td>
                                            <td class="text-right font-weight-bold h6" id="edit_remaining_amount">S/
                                                0.00
                                            </td>
                                            <td></td>
                                        </tr>
                                        </tfoot>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <!-- Botón para agregar producto manualmente -->
                        <div class="row mt-2">
                            <div class="col-12 text-center">
                                <button type="button" class="btn btn-outline-success btn-sm"
                                        onclick="addEmptyEditProductRow()">
                                    <i class="fas fa-plus mr-1"></i>Agregar Producto Manualmente
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">
                        <i class="fas fa-times mr-1"></i>Cancelar
                    </button>
                    <button type="button" class="btn btn-warning" onclick="updateOrder()">
                        <i class="fas fa-save mr-1"></i>Actualizar Orden
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para completar orden -->
    <div class="modal fade" id="completeOrderModal" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-lg roboto-condensed-regular" role="document">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-check-circle mr-2"></i>Completar Orden
                    </h5>
                    <button type="button" class="close text-white" data-dismiss="modal">
                        <span>&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="complete-order-form">
                        <input type="hidden" id="complete_order_id" name="order_id" value="">
                        <input type="hidden" id="complete_order_balance" name="order_balance" value="">
                        <input type="hidden" id="complete_order_total" name="order_total" value="">
                        <input type="hidden" id="complete_client_document" name="client_document" value="">
                        <input type="hidden" id="complete_client_name" name="client_name" value="">

                        <!-- Información de la orden en dos columnas -->
                        <div class="row mb-3">
                            <div class="col-12">
                                <div class="alert alert-info mb-0 py-2">
                                    <div class="row">
                                        <div class="col-md-1 text-center">
                                            <i class="fas fa-info-circle fa-lg text-primary"></i>
                                        </div>
                                        <div class="col-md-11">
                                            <strong class="small">Información de la Orden:</strong>
                                            <div id="complete-order-info" class="mt-1 small"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Campos principales en dos columnas -->
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="complete_payment_amount" class="form-label">
                                        <i class="fas fa-money-bill-wave mr-1"></i>Saldo a Pagar
                                    </label>
                                    <div class="input-group">
                                        <div class="input-group-prepend">
                                            <span class="input-group-text">S/</span>
                                        </div>
                                        <input type="number" class="form-control" id="complete_payment_amount" name="payment_amount" readonly>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="complete_payment_date" class="form-label">
                                        <i class="fas fa-calendar mr-1"></i>Fecha del Pago <span class="text-danger">*</span>
                                    </label>
                                    <input type="date" class="form-control" id="complete_payment_date" name="payment_date" required>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="completed_by" class="form-label">
                                        <i class="fas fa-user mr-1"></i>Completado por <span class="text-danger">*</span>
                                    </label>
                                    <select class="form-control" id="completed_by" name="completed_by" required>
                                        <option value="">Seleccionar empleado...</option>
                                        {% for user in user_set %}
                                            <option value="{{ user.id }}" {% if user.id == request.user.id %}selected{% endif %}>
                                                {{ user.first_name }} {{ user.last_name }}
                                            </option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="complete_cash_account" class="form-label">
                                        <i class="fas fa-university mr-1"></i>Cuenta de Caja <span class="text-danger">*</span>
                                    </label>
                                    <select class="form-control" id="complete_cash_account" name="cash_account" required>
                                        <option value="">Seleccione una cuenta</option>
                                        {% for cash in cash_accounts %}
                                            <option value="{{ cash.id }}">{{ cash.name }} - {{ cash.subsidiary.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Totales de la orden -->
                        <div class="row mb-3">
                            <div class="col-12">
                                <div class="card">
                                    <div class="card-header bg-light py-2">
                                        <h6 class="mb-0"><i class="fas fa-calculator mr-2"></i>Totales de la Orden</h6>
                                    </div>
                                    <div class="card-body py-2">
                                        <div class="row">
                                            <div class="col-md-4">
                                                <div class="form-group mb-0">
                                                    <label class="form-label-sm text-muted">Subtotal</label>
                                                    <div class="input-group">
                                                        <div class="input-group-prepend">
                                                            <span class="input-group-text">S/</span>
                                                        </div>
                                                        <input type="text"
                                                               class="form-control text-right font-weight-bold"
                                                               id="complete_subtotal" readonly>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="form-group mb-0">
                                                    <label class="form-label-sm text-muted">IGV (18%)</label>
                                                    <div class="input-group">
                                                        <div class="input-group-prepend">
                                                            <span class="input-group-text">S/</span>
                                                        </div>
                                                        <input type="text"
                                                               class="form-control text-right font-weight-bold"
                                                               id="complete_igv" readonly>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="form-group mb-0">
                                                    <label class="form-label-sm text-muted">Total</label>
                                                    <div class="input-group">
                                                        <div class="input-group-prepend">
                                                            <span class="input-group-text">S/</span>
                                                        </div>
                                                        <input type="text"
                                                               class="form-control text-right font-weight-bold"
                                                               id="complete_total" readonly>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Checkbox para emitir comprobante electrónico -->
                        <div class="form-group">
                            <div class="custom-control custom-checkbox">
                                <input type="checkbox" class="custom-control-input" id="emit_electronic_document" name="emit_electronic_document">
                                <label class="custom-control-label" for="emit_electronic_document">
                                    <i class="fas fa-file-invoice mr-1"></i>Emitir Comprobante Electrónico
                                </label>
                            </div>
                        </div>

                        <!-- Panel de comprobante electrónico (inicialmente oculto) -->
                        <div id="electronic-document-panel" style="display: none;">
                            <div class="card">
                                <div class="card-header bg-primary text-white py-2">
                                    <h6 class="mb-0"><i class="fas fa-file-invoice mr-2"></i>Datos del Comprobante Electrónico</h6>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label for="document_type" class="form-label">
                                                    <i class="fas fa-tag mr-1"></i>Tipo de Comprobante <span class="text-danger">*</span>
                                                </label>
                                                <select class="form-control" id="document_type" name="document_type">
                                                    <option value="">Seleccione tipo</option>
                                                    <option value="B">BOLETA</option>
                                                    <option value="F">FACTURA</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label for="document_number" class="form-label">
                                                    <i class="fas fa-hashtag mr-1"></i>Número de Documento <span class="text-danger">*</span>
                                                </label>
                                                <div class="input-group">
                                                    <input type="text" class="form-control" id="document_number" name="document_number" placeholder="DNI o RUC del cliente">
                                                    <div class="input-group-append">
                                                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="searchClientInElectronicDocument()">
                                                            <i class="fas fa-search"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                                <small class="form-text text-muted">
                                                    <span id="document_help">Ingrese el documento del cliente</span>
                                                </small>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label for="client_full_name" class="form-label">
                                                    <i class="fas fa-user mr-1"></i>Nombre/Razón Social <span class="text-danger">*</span>
                                                </label>
                                                <input type="text" class="form-control" id="client_full_name" name="client_full_name" placeholder="Nombre completo o razón social">
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label for="client_address" class="form-label">
                                                    <i class="fas fa-map-marker-alt mr-1"></i>Dirección
                                                </label>
                                                <input type="text" class="form-control" id="client_address" name="client_address" placeholder="Dirección del cliente">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">
                        <i class="fas fa-times mr-1"></i>Cancelar
                    </button>
                    <button type="button" class="btn btn-success" onclick="confirmCompleteOrder()">
                        <i class="fas fa-check mr-1"></i>Completar Orden
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para cambiar estado de entrega -->
    <div class="modal fade" id="orderDeliveryStatusModal" tabindex="-1" role="dialog"
         aria-labelledby="orderDeliveryStatusModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content roboto-condensed-regular">
                <div class="modal-header">
                    <h5 class="modal-title" id="orderDeliveryStatusModalLabel">Cambiar Estado de Entrega</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="orderDeliveryStatusForm">
                        <input type="hidden" id="orderDeliveryStatusId" name="order_id">

                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="orderDeliveryCode">Código de Orden:</label>
                                    <input type="text" class="form-control" id="orderDeliveryCode" readonly>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="deliveryClientName">Cliente:</label>
                                    <input type="text" class="form-control" id="deliveryClientName" readonly>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="currentDeliveryStatus">Estado de Entrega Actual:</label>
                                    <input type="text" class="form-control" id="currentDeliveryStatus" readonly>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="newDeliveryStatus">Nuevo Estado de Entrega: <span
                                            class="text-danger">*</span></label>
                                    <select class="form-control" id="newDeliveryStatus" name="delivery_status" required>
                                        <option value="">Seleccionar estado...</option>
                                        <option value="P">PENDIENTE</option>
                                        <option value="E">ENTREGADO</option>
                                        <option value="C">CANCELADO</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-12">
                                <div class="form-group">
                                    <label for="deliveredBy">Entregado por: <span class="text-danger">*</span></label>
                                    <select class="form-control" id="deliveredBy" name="delivered_by" required>
                                        <option value="">Seleccionar empleado...</option>
                                        {% for user in user_set %}
                                            <option value="{{ user.id }}"
                                                    {% if user.id == request.user.id %}selected{% endif %}>
                                                {{ user.first_name }} {{ user.last_name }} ({{ user.username }})
                                            </option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="saveOrderDeliveryStatus">Guardar Cambios</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para anular orden -->
    <div class="modal fade" id="cancelOrderModal" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-md" role="document">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-ban mr-2"></i>Anular Orden
                    </h5>
                    <button type="button" class="close text-white" data-dismiss="modal">
                        <span>&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="cancel-order-form">
                        <input type="hidden" id="cancel_order_id" name="order_id" value="">
                        <input type="hidden" id="cancel_order_advance" name="order_advance" value="">

                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle mr-2"></i>
                            <strong>Información de la Orden:</strong>
                            <div id="cancel-order-info" class="mt-2"></div>
                        </div>

                        <div class="form-group">
                            <label for="cancellation_reason" class="form-label">
                                <i class="fas fa-comment-alt mr-1"></i>Motivo de Anulación <span
                                    class="text-danger">*</span>
                            </label>
                            <textarea class="form-control" id="cancellation_reason" name="cancellation_reason"
                                      rows="3" placeholder="Describa el motivo de la anulación..." required></textarea>
                        </div>

                        <div class="form-group">
                            <label for="refund_advance" class="form-label">
                                <i class="fas fa-undo mr-1"></i>Devolución del Adelanto
                            </label>
                            <div class="custom-control custom-checkbox">
                                <input type="checkbox" class="custom-control-input" id="refund_advance"
                                       name="refund_advance">
                                <label class="custom-control-label" for="refund_advance">
                                    Marcar si se debe devolver el adelanto al cliente
                                </label>
                            </div>
                            <small class="form-text text-muted">
                                Si marca esta opción, se registrará una salida de dinero por el monto del adelanto
                            </small>
                        </div>

                        <div id="refund-details" style="display: none;">
                            <div class="form-group">
                                <label for="refund_amount" class="form-label">
                                    <i class="fas fa-money-bill-wave mr-1"></i>Monto a Devolver
                                </label>
                                <div class="input-group">
                                    <div class="input-group-prepend">
                                        <span class="input-group-text">S/</span>
                                    </div>
                                    <input type="number" class="form-control" id="refund_amount"
                                           name="refund_amount" readonly>
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="refund_cash_account" class="form-label">
                                    <i class="fas fa-university mr-1"></i>Cuenta de Caja <span
                                        class="text-danger">*</span>
                                </label>
                                <select class="form-control" id="refund_cash_account" name="refund_cash_account">
                                    <option value="">Seleccione una cuenta</option>
                                    {% for cash in cash_accounts %}
                                        <option value="{{ cash.id }}">{{ cash.name }}
                                            - {{ cash.subsidiary.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">
                        <i class="fas fa-times mr-1"></i>Cancelar
                    </button>
                    <button type="button" class="btn btn-danger" onclick="confirmCancelOrder()">
                        <i class="fas fa-ban mr-1"></i>Anular Orden
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading overlay -->
    <div class="loading-overlay" id="loading-overlay" style="display: none;">
        <div class="spinner-border text-primary" role="status">
            <span class="sr-only">Cargando...</span>
        </div>
    </div>

    <!-- Modal para cambio de estado de entrega -->
    <div class="modal fade" id="orderDeliveryStatusModal" tabindex="-1" role="dialog" aria-labelledby="orderDeliveryStatusModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="orderDeliveryStatusModalLabel">Cambiar Estado de Entrega</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="orderDeliveryStatusForm">
                        <input type="hidden" id="orderDeliveryStatusId" name="order_id">
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="orderDeliveryCode">Código de Orden:</label>
                                    <input type="text" class="form-control" id="orderDeliveryCode" readonly>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="deliveryClientName">Cliente:</label>
                                    <input type="text" class="form-control" id="deliveryClientName" readonly>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="currentDeliveryStatus">Estado de Entrega Actual:</label>
                                    <input type="text" class="form-control" id="currentDeliveryStatus" readonly>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="newDeliveryStatus">Nuevo Estado de Entrega: <span class="text-danger">*</span></label>
                                    <select class="form-control" id="newDeliveryStatus" name="delivery_status" required>
                                        <option value="">Seleccionar estado...</option>
                                        <option value="P">PENDIENTE</option>
                                        <option value="E">ENTREGADO</option>
                                        <option value="C">CANCELADO</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-12">
                                <div class="form-group">
                                    <label for="deliveredBy">Entregado por: <span class="text-danger">*</span></label>
                                    <select class="form-control" id="deliveredBy" name="delivered_by" required>
                                        <option value="">Seleccionar empleado...</option>
                                        {% for user in user_set %}
                                            <option value="{{ user.id }}" {% if user.id == request.user.id %}selected{% endif %}>
                                                {{ user.first_name }} {{ user.last_name }} ({{ user.username }})
                                            </option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="saveOrderDeliveryStatus">Guardar Cambios</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para convertir orden a orden de servicio -->
    <div class="modal fade" id="convertOrderModal" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-xl" role="document">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-exchange-alt mr-2"></i>Convertir a Orden de Servicio
                    </h5>
                    <button type="button" class="close text-white" data-dismiss="modal">
                        <span>&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="convert-order-form">
                        <input type="hidden" id="convert_order_id" name="order_id" value="">
                        
                        <!-- Información General -->
                        <div class="row mb-3">
                            <div class="col-12">
                                <h6 class="text-success border-bottom pb-2">
                                    <i class="fas fa-info-circle mr-2"></i>Información de la Orden a Convertir
                                </h6>
                            </div>
                        </div>

                        <!-- Información de la orden actual -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="form-label">
                                        <i class="fas fa-hashtag mr-1"></i>Código Actual
                                    </label>
                                    <input type="text" class="form-control" id="convert_current_code" readonly>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="form-label">
                                        <i class="fas fa-user mr-1"></i>Cliente
                                    </label>
                                    <input type="text" class="form-control" id="convert_client_name" readonly>
                                </div>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="form-label">
                                        <i class="fas fa-calendar mr-1"></i>Fecha de Registro
                                    </label>
                                    <input type="text" class="form-control" id="convert_register_date" readonly>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="form-label">
                                        <i class="fas fa-money-bill-wave mr-1"></i>Total Actual
                                    </label>
                                    <input type="text" class="form-control" id="convert_current_total" readonly>
                                </div>
                            </div>
                        </div>

                        <!-- Separador -->
                        <div class="row mb-3">
                            <div class="col-12">
                                <h6 class="text-primary border-bottom pb-2">
                                    <i class="fas fa-cog mr-2"></i>Configuración de la Nueva Orden de Servicio
                                </h6>
                            </div>
                        </div>

                        <!-- Configuración de la nueva orden -->
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="convert_subsidiary_id" class="form-label">
                                        <i class="fas fa-building mr-1"></i>Sucursal <span class="text-danger">*</span>
                                    </label>
                                    <select class="form-control" id="convert_subsidiary_id" name="subsidiary_id" required>
                                        <option value="">Seleccione sucursal</option>
                                        {% for subsidiary in subsidiary_set %}
                                            <option value="{{ subsidiary.id }}" data-serial="{{ subsidiary.serial }}">
                                                {{ subsidiary.name }}
                                            </option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="convert_serial" class="form-label">
                                        <i class="fas fa-hashtag mr-1"></i>Serie
                                    </label>
                                    <input type="text" class="form-control" id="convert_serial" name="serial" readonly>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="convert_correlative" class="form-label">
                                        <i class="fas fa-sort-numeric-up mr-1"></i>Correlativo
                                    </label>
                                    <input type="text" class="form-control" id="convert_correlative" name="correlative" readonly>
                                </div>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="convert_register_date_new" class="form-label">
                                        <i class="fas fa-calendar mr-1"></i>Fecha de Registro <span class="text-danger">*</span>
                                    </label>
                                    <input type="date" class="form-control" id="convert_register_date_new" name="register_date" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="convert_delivery_date" class="form-label">
                                        <i class="fas fa-truck mr-1"></i>Fecha de Entrega
                                    </label>
                                    <input type="date" class="form-control" id="convert_delivery_date" name="delivery_date">
                                </div>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="convert_way_to_pay" class="form-label">
                                        <i class="fas fa-credit-card mr-1"></i>Forma de Pago <span class="text-danger">*</span>
                                    </label>
                                    <select class="form-control" id="convert_way_to_pay" name="way_to_pay" required>
                                        <option value="">Seleccione forma de pago</option>
                                        <option value="E">Efectivo</option>
                                        <option value="Y">Yape</option>
                                        <option value="D">Depósito y/o Transferencia</option>
                                        <option value="C">Crédito</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="convert_cash_advance" class="form-label">
                                        <i class="fas fa-money-bill-wave mr-1"></i>Adelanto (S/)
                                    </label>
                                    <input type="number" class="form-control" id="convert_cash_advance" name="cash_advance" 
                                           step="0.01" min="0" placeholder="0.00">
                                </div>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-12">
                                <div class="form-group">
                                    <label for="convert_observation" class="form-label">
                                        <i class="fas fa-comment mr-1"></i>Observaciones
                                    </label>
                                    <textarea class="form-control" id="convert_observation" name="observation" 
                                              rows="3" placeholder="Observaciones adicionales..."></textarea>
                                </div>
                            </div>
                        </div>

                        <!-- Productos/Servicios -->
                        <div class="row mb-3">
                            <div class="col-12">
                                <h6 class="text-info border-bottom pb-2">
                                    <i class="fas fa-list mr-2"></i>Productos/Servicios
                                </h6>
                            </div>
                        </div>

                        <div class="table-responsive">
                            <table class="table table-bordered" id="convert-products-table">
                                <thead class="thead-light">
                                    <tr>
                                        <th style="width: 5%;">#</th>
                                        <th style="width: 50%;">Descripción</th>
                                        <th style="width: 15%;">Cantidad</th>
                                        <th style="width: 15%;">Precio Unit.</th>
                                        <th style="width: 15%;">Total</th>
                                    </tr>
                                </thead>
                                <tbody id="convert-products-tbody">
                                    <!-- Los productos se cargarán dinámicamente -->
                                </tbody>
                            </table>
                        </div>

                        <!-- Totales -->
                        <div class="row">
                            <div class="col-md-8"></div>
                            <div class="col-md-4">
                                <div class="card">
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-6">
                                                <strong>Subtotal:</strong>
                                            </div>
                                            <div class="col-6 text-right">
                                                <span id="convert-subtotal">S/ 0.00</span>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-6">
                                                <strong>IGV (18%):</strong>
                                            </div>
                                            <div class="col-6 text-right">
                                                <span id="convert-igv">S/ 0.00</span>
                                            </div>
                                        </div>
                                        <hr>
                                        <div class="row">
                                            <div class="col-6">
                                                <strong>Total:</strong>
                                            </div>
                                            <div class="col-6 text-right">
                                                <span id="convert-total" class="font-weight-bold text-primary">S/ 0.00</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">
                        <i class="fas fa-times mr-1"></i>Cancelar
                    </button>
                    <button type="button" class="btn btn-success" onclick="convertToServiceOrder()">
                        <i class="fas fa-exchange-alt mr-1"></i>Convertir a Orden de Servicio
                    </button>
                </div>
            </div>
        </div>
    </div>

{% endblock body %}

{% block extrajs %}
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        // Función para obtener la fecha del servidor (zona horaria de Perú)
        // Esta función resuelve el problema de zona horaria usando la fecha
        // que viene del backend en lugar de calcularla en JavaScript
        
        // Función para actualizar el color del select según el estado
        function updateSelectColor(selectElement) {
            const value = selectElement.value;
            const isStatusSelect = selectElement.classList.contains('status-select');
            const isDeliverySelect = selectElement.classList.contains('delivery-select');
            
            // Remover clases de color anteriores
            selectElement.removeAttribute('data-status');
            selectElement.removeAttribute('data-delivery-status');
            
            if (isStatusSelect) {
                selectElement.setAttribute('data-status', value);
            } else if (isDeliverySelect) {
                selectElement.setAttribute('data-delivery-status', value);
            }
        }
        
        // Función para inicializar colores de todos los selects
        function initializeSelectColors() {
            // Inicializar colores de status-select
            $('.status-select').each(function() {
                updateSelectColor(this);
            });
            
            // Inicializar colores de delivery-select
            $('.delivery-select').each(function() {
                updateSelectColor(this);
            });
        }
        
        // Evento para el botón de guardar estado de entrega
        $(document).ready(function() {
            // Inicializar colores al cargar la página
            initializeSelectColors();
            
            // Evento para cambio de estado de pago
            $(document).on('change', '.status-select', function() {
                updateSelectColor(this);
            });
            
            // Evento para cambio de estado de entrega
            $(document).on('change', '.delivery-select', function() {
                updateSelectColor(this);
            });
            
            $('#saveOrderDeliveryStatus').click(function() {
                var form = $('#orderDeliveryStatusForm');
                var formData = form.serialize();
                
                // Validar que se haya seleccionado un estado
                if (!$('#newDeliveryStatus').val()) {
                    toastr.error('Debe seleccionar un nuevo estado de entrega');
                    return;
                }
                
                // Validar que se haya seleccionado un empleado
                if (!$('#deliveredBy').val()) {
                    toastr.error('Debe seleccionar un empleado');
                    return;
                }
                
                $.ajax({
                    url: '/sales/orders/update-delivery-status/',
                    type: 'POST',
                    data: formData,
                    headers: {
                        'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val()
                    },
                    success: function(response) {
                        if (response.success) {
                            toastr.success(response.message);
                            $('#orderDeliveryStatusModal').modal('hide');
                            // Recargar la tabla de órdenes
                            loadOrders();
                        } else {
                            toastr.error(response.message);
                        }
                    },
                    error: function(xhr, status, error) {
                        toastr.error('Error al actualizar el estado de entrega');
                        console.error('Error:', error);
                    }
                });
            });
        });
        function getServerDate() {
            // Usar la fecha que viene del backend ({{ date_now }})
            // que ya está en zona horaria de Perú (GMT-5)
            const serverDate = '{{ date_now }}';

            // Debug: Mostrar la fecha del servidor en consola
            console.log('Fecha del servidor (Perú):', serverDate);
            console.log('Fecha local del navegador:', new Date().toLocaleDateString());

            return serverDate;
        }

        // Función para convertir base64 a Blob
        function base64ToBlob(base64, mimeType) {
            const byteCharacters = atob(base64);
            const byteNumbers = new Array(byteCharacters.length);
            for (let i = 0; i < byteCharacters.length; i++) {
                byteNumbers[i] = byteCharacters.charCodeAt(i);
            }
            const byteArray = new Uint8Array(byteNumbers);
            return new Blob([byteArray], {type: mimeType});
        }

        // =============================================================================
        // FUNCIONES DE AUTOCOMPLETADO PARA CLIENTES EN MODALES DE ÓRDENES
        // ⚠️ IMPORTANTE: Estas funciones son SOLO para los modales de creación/edición
        // NO interfieren con los filtros de búsqueda en la página principal
        // =============================================================================

        // Función para buscar clientes en el modal de creación
        function searchClientsForOrder(searchTerm, isEdit = false) {
            if (searchTerm.length < 2) {
                const resultsId = isEdit ? '#edit_client_autocomplete_results' : '#client_autocomplete_results';
                $(resultsId).hide();
                return;
            }

            const resultsId = isEdit ? '#edit_client_autocomplete_results' : '#client_autocomplete_results';

            // Mostrar estado de carga
            $(resultsId).html(`
                <div class="client-autocomplete-loading">
                    <i class="fas fa-spinner fa-spin"></i> Buscando clientes...
                </div>
            `).show();

            $.ajax({
                url: '{% url "apps.sales:search_clients_autocomplete" %}',
                type: 'GET',
                data: {
                    'search': searchTerm
                },
                success: function (response) {
                    if (response.success && response.clients.length > 0) {
                        displayClientAutocompleteResults(response.clients, isEdit);
                        $(resultsId).show();
                    } else {
                        $(resultsId).html(`
                            <div class="client-autocomplete-no-results">
                                <i class="fas fa-search"></i> No se encontraron clientes
                            </div>
                        `).show();
                    }
                },
                error: function () {
                    $(resultsId).html(`
                        <div class="client-autocomplete-no-results">
                            <i class="fas fa-exclamation-triangle"></i> Error en la búsqueda
                        </div>
                    `).show();
                }
            });
        }

        // Función para mostrar resultados del autocompletado
        function displayClientAutocompleteResults(clients, isEdit = false) {
            let html = '';
            const resultsId = isEdit ? '#edit_client_autocomplete_results' : '#client_autocomplete_results';

            clients.forEach(client => {
                const documentType = client.document === '01' ? 'DNI' : 'RUC';
                const address = client.address || 'Sin dirección';
                const phone = client.phone || 'Sin teléfono';

                html += `
                    <div class="client-autocomplete-item"
                         onclick="selectClientFromAutocomplete(${client.id}, '${client.full_name}', '${documentType}: ${client.number}', '${address}', ${isEdit})">
                        <div class="client-info">
                            <div class="client-name">${client.full_name}</div>
                            <div class="client-document">${documentType}: ${client.number}</div>
                            <div class="client-address">${address}</div>
                        </div>
                        <div class="client-phone">${phone}</div>
                    </div>
                `;
            });

            $(resultsId).html(html);
        }

        // Función para seleccionar cliente desde el autocompletado
        function selectClientFromAutocomplete(clientId, clientName, clientDocument, clientAddress, isEdit = false) {
            const inputId = isEdit ? '#edit_client_search_input' : '#client_search_input';
            const hiddenId = isEdit ? '#edit_client_id' : '#client_id';
            const resultsId = isEdit ? '#edit_client_autocomplete_results' : '#client_autocomplete_results';
            const clearBtnClass = isEdit ? '.btn-clear-client' : '.btn-clear-client';

            // Establecer valores
            $(hiddenId).val(clientId);
            $(inputId).val(`${clientName} - ${clientDocument}`);

            // Ocultar resultados
            $(resultsId).hide();

            // Marcar como seleccionado
            $(inputId).addClass('client-selected');
            $(inputId).attr('readonly', true);

            // Mostrar botón de limpiar
            $(inputId).closest('.input-group').find(clearBtnClass).show();

            // Mostrar notificación
            showClientSelectedNotification(clientName, isEdit);
        }

        // Función para mostrar notificación de cliente seleccionado
        function showClientSelectedNotification(clientName, isEdit = false) {
            const inputId = isEdit ? '#edit_client_search_input' : '#client_search_input';
            const notificationId = isEdit ? '#edit-client-notification' : '#client-notification';

            // Crear o actualizar notificación
            let notification = $(notificationId);
            if (notification.length === 0) {
                notification = $(`
                    <div id="${notificationId.replace('#', '')}" class="alert alert-success alert-sm mt-1" role="alert">
                        <i class="fas fa-check-circle mr-1"></i>
                        <small>Cliente seleccionado: <strong>${clientName}</strong></small>
                    </div>
                `);
                $(inputId).closest('.form-group').append(notification);
            } else {
                notification.find('strong').text(clientName);
            }
        }

        // Función para limpiar selección de cliente en modal de creación
        function clearClientSelection() {
            $('#client_id').val('');
            $('#client_search_input').val('');
            $('#client_search_input').removeClass('client-selected');
            $('#client_search_input').removeAttr('readonly');
            $('.btn-clear-client').hide();
            $('#client-notification').remove();
            $('#client_autocomplete_results').hide();
        }

        // Función para limpiar selección de cliente en modal de edición
        function clearEditClientSelection() {
            $('#edit_client_id').val('');
            $('#edit_client_search_input').val('');
            $('#edit_client_search_input').removeClass('client-selected');
            $('#edit_client_search_input').removeAttr('readonly');
            $('.btn-clear-client').hide();
            $('#edit-client-notification').remove();
            $('#edit_client_autocomplete_results').hide();
        }

        // Función para manejar navegación con teclado en el autocompletado
        function handleClientAutocompleteKeyboard(e, isEdit = false) {
            const resultsId = isEdit ? '#edit_client_autocomplete_results' : '#client_autocomplete_results';
            const items = $(resultsId).find('.client-autocomplete-item');

            if (items.length === 0) return;

            let currentIndex = $(resultsId).find('.client-autocomplete-item.selected').index();

            switch (e.keyCode) {
                case 38: // Flecha arriba
                    e.preventDefault();
                    if (currentIndex > 0) {
                        items.removeClass('selected');
                        items.eq(currentIndex - 1).addClass('selected');
                    }
                    break;

                case 40: // Flecha abajo
                    e.preventDefault();
                    if (currentIndex < items.length - 1) {
                        items.removeClass('selected');
                        items.eq(currentIndex + 1).addClass('selected');
                    } else if (currentIndex === -1) {
                        items.first().addClass('selected');
                    }
                    break;

                case 13: // Enter
                    e.preventDefault();
                    const selectedItem = $(resultsId).find('.client-autocomplete-item.selected');
                    if (selectedItem.length > 0) {
                        selectedItem.click();
                    }
                    break;

                case 27: // Escape
                    $(resultsId).hide();
                    break;
            }
        }

        // Función para limpiar autocompletado al abrir modales
        function clearClientAutocompleteOnModalOpen() {
            clearClientSelection();
            clearEditClientSelection();
        }

        // =============================================================================
        // FUNCIONES DE AUTOCOMPLETADO PARA FILTROS (SEPARADO DE MODALES)
        // ⚠️ IMPORTANTE: Estas funciones son SOLO para los filtros de búsqueda
        // NO interfieren con los modales de creación/edición de órdenes
        // =============================================================================

        // Función para buscar clientes con autocompletado en filtros
        function searchClientsForFilters(searchTerm) {
            if (searchTerm.length < 2) {
                $('#client-suggestions').hide();
                return;
            }

            $.ajax({
                url: '{% url "apps.sales:search_clients_autocomplete" %}',
                type: 'GET',
                data: {
                    'search': searchTerm
                },
                success: function (response) {
                    if (response.success && response.clients.length > 0) {
                        displayClientSuggestionsForFilters(response.clients);
                        $('#client-suggestions').show();
                    } else {
                        $('#client-suggestions').hide();
                    }
                },
                error: function () {
                    $('#client-suggestions').hide();
                }
            });
        }

        // Función para mostrar sugerencias de clientes en filtros
        function displayClientSuggestionsForFilters(clients) {
            let html = '';
            clients.forEach(client => {
                const documentType = client.document === '01' ? 'DNI' : 'RUC';
                html += `
                    <div class="client-suggestion-item"
                         onclick="selectClientForFilters(${client.id}, '${client.full_name}', '${documentType}: ${client.number}')">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong class="text-primary">${client.full_name}</strong>
                                <br><small class="text-muted">${documentType}: ${client.number}</small>
                            </div>
                            <div class="text-right">
                                <small class="text-info">${client.address || 'Sin dirección'}</small>
                            </div>
                        </div>
                    </div>
                `;
            });
            $('#client-suggestions').html(html);
        }

        // Función para seleccionar un cliente en filtros
        function selectClientForFilters(clientId, clientName, clientDocument) {
            $('#client-id-filter').val(clientId);
            $('#client-search').val(`${clientName} - ${clientDocument}`);
            $('#client-suggestions').hide();

            // Agregar indicador visual de cliente seleccionado
            $('#client-search').addClass('is-valid');
            $('#client-search').removeClass('is-invalid');

            // Mostrar notificación de cliente seleccionado
            showClientSelectedNotificationForFilters(clientName);
        }

        // Función para mostrar notificación de cliente seleccionado en filtros
        function showClientSelectedNotificationForFilters(clientName) {
            // Crear o actualizar notificación
            let notification = $('#client-notification');
            if (notification.length === 0) {
                notification = $(`
                    <div id="client-notification" class="alert alert-success alert-sm mt-1" role="alert">
                        <i class="fas fa-check-circle mr-1"></i>
                        <small>Cliente seleccionado: <strong>${clientName}</strong></small>
                    </div>
                `);
                $('#client-search').closest('.form-group').append(notification);
            } else {
                notification.find('strong').text(clientName);
            }
        }

        // Función para limpiar el filtro de cliente
        function clearClientFilter() {
            $('#client-id-filter').val('');
            $('#client-search').val('');
            $('#client-suggestions').hide();

            // Remover indicadores visuales
            $('#client-search').removeClass('is-valid is-invalid');

            // Ocultar notificación
            $('#client-notification').remove();
        }

        // Función para limpiar filtros (mantener compatibilidad)
        function clearAllFilters() {
            $('#search-form')[0].reset();
            // Establecer fechas del día actual después de limpiar
            $('#date-from').val(getServerDate());
            $('#date-to').val(getServerDate());
            // Limpiar filtro de cliente
            clearClientFilter();
            loadOrders();
        }

        // =============================================================================
        // FUNCIÓN DE VERIFICACIÓN DE SEPARACIÓN (SOLO PARA DESARROLLO)
        // =============================================================================
        function verifyAutocompleteSeparation() {
            console.log('🔍 Verificando separación de autocompletado...');
            console.log('✅ Modal de creación:', $('#client_search_input').length > 0);
            console.log('✅ Modal de edición:', $('#edit_client_search_input').length > 0);
            console.log('✅ Filtro de búsqueda:', $('#client-search').length > 0);
            console.log('✅ Resultados de modal creación:', $('#client_autocomplete_results').length > 0);
            console.log('✅ Resultados de modal edición:', $('#edit_client_autocomplete_results').length > 0);
            console.log('✅ Sugerencias de filtros:', $('#client-suggestions').length > 0);
            console.log('🎯 Separación completada correctamente');
        }

        // =============================================================================
        // FUNCIÓN DE PRUEBA PARA VERIFICAR FUNCIONAMIENTO
        // =============================================================================
        function testAutocompleteFunctions() {
            console.log('🧪 Probando funciones de autocompletado...');

            // Verificar que las funciones estén definidas
            console.log('✅ searchClientsForOrder:', typeof searchClientsForOrder === 'function');
            console.log('✅ searchClientsForFilters:', typeof searchClientsForFilters === 'function');
            console.log('✅ displayClientAutocompleteResults:', typeof displayClientAutocompleteResults === 'function');
            console.log('✅ displayClientSuggestionsForFilters:', typeof displayClientSuggestionsForFilters === 'function');

            // Verificar que no haya conflictos
            console.log('❌ searchClients (debe ser undefined):', typeof searchClients === 'function');

            console.log('🎯 Prueba completada');
        }

        $(document).ready(function () {
            // Cargar órdenes del día al iniciar
            loadOrders();

            // Establecer fecha actual en los filtros si están vacíos
            if (!$('#date-from').val()) {
                $('#date-from').val(getServerDate());
            }
            if (!$('#date-to').val()) {
                $('#date-to').val(getServerDate());
            }

            // Inicializar estilos de los selects de entrega
            initializeDeliverySelects();

            // Manejar envío del formulario de búsqueda
            $('#search-form').on('submit', function (e) {
                e.preventDefault();
                loadOrders();
            });

            // Limpiar filtros
            $('#clear-filters').on('click', function () {
                clearAllFilters();
            });

            // Toggle para colapsar/expandir filtros
            $('#toggle-filters').on('click', function () {
                const filtersBody = $('.compact-body');
                const toggleIcon = $('#toggle-icon');

                if (filtersBody.is(':visible')) {
                    filtersBody.slideUp(300);
                    toggleIcon.removeClass('fa-chevron-up').addClass('fa-chevron-down');
                    $(this).attr('title', 'Expandir filtros');
                    // Guardar estado en localStorage
                    localStorage.setItem('filtersCollapsed', 'true');
                } else {
                    filtersBody.slideDown(300);
                    toggleIcon.removeClass('fa-chevron-down').addClass('fa-chevron-up');
                    $(this).attr('title', 'Colapsar filtros');
                    // Guardar estado en localStorage
                    localStorage.setItem('filtersCollapsed', 'false');
                }
            });

            // Restaurar estado de los filtros al cargar la página
            const filtersCollapsed = localStorage.getItem('filtersCollapsed');
            if (filtersCollapsed === 'true') {
                $('.compact-body').hide();
                $('#toggle-icon').removeClass('fa-chevron-up').addClass('fa-chevron-down');
                $('#toggle-filters').attr('title', 'Expandir filtros');
            }

            // Actualizar correlativo cuando cambie la sucursal o tipo
            $('#subsidiary_id, #order_type').on('change', updateCorrelative);

            // Actualizar serie cuando cambie la sucursal
            $('#subsidiary_id').on('change', updateSerial);

            // Inicializar serie si ya hay una sucursal seleccionada
            if ($('#subsidiary_id').val()) {
                updateSerial();
            }

            // Búsqueda de productos en tiempo real
            $('#product_search').on('input', function () {
                if ($(this).val().length >= 2) {
                    searchProducts();
                }
            });

            // Limpiar filtro de cliente al limpiar todos los filtros
            $('#clear-filters').on('click', function () {
                clearClientFilter();
            });

            // Filtrar productos por categoría
            $('#product_category_filter, #product_type_filter').on('change', function () {
                if ($('#product_search').val().length >= 2) {
                    searchProducts();
                }
            });

            // Validación en tiempo real para el número de documento
            $('#new_client_document, #new_client_number').on('change', function () {
                validateDocumentFormat();
            });

            // Limpiar campos cuando cambie el tipo de documento
            $('#new_client_document').on('change', function () {
                clearClientFields();
                $('#new_client_number').val('').focus();
            });

            // Auto-focus en el campo de nombre cuando se abre el modal
            $('#createClientModal').on('shown.bs.modal', function () {
                $('#new_client_name').focus();
                //$('#new_client_number').focus();
            });

            // Restaurar botón cuando se cierre el modal
            $('#createClientModal').on('hidden.bs.modal', function () {
                restoreOriginalButton();
            });

            // Event listener para buscar cliente en API cuando se presiona Enter
            $('#new_client_number').on('keypress', function (e) {
                if (e.which === 13) { // Código de tecla Enter
                    e.preventDefault();
                    searchClientInAPI();
                }
            });

            // Event listeners para el modal de edición
            $('#edit_subsidiary_id, #edit_order_type').on('change', updateEditCorrelative);
            $('#edit_subsidiary_id').on('change', updateEditSerial);

            // Búsqueda de productos en tiempo real para edición
            $('#edit_product_search').on('input', function () {
                if ($(this).val().length >= 2) {
                    searchEditProducts();
                }
            });

            // Filtrar productos por categoría para edición
            $('#edit_product_category_filter, #edit_product_type_filter').on('change', function () {
                if ($('#edit_product_search').val().length >= 2) {
                    searchEditProducts();
                }
            });

            // =============================================================================
            // EVENT LISTENERS PARA AUTOCOMPLETADO DE CLIENTES EN MODALES
            // ⚠️ IMPORTANTE: Solo para modales de creación/edición de órdenes
            // =============================================================================

            // Autocompletado para modal de creación
            $('#client_search_input').on('input', function () {
                const searchTerm = $(this).val();
                if (searchTerm.length >= 2) {
                    searchClientsForOrder(searchTerm, false);
                } else {
                    $('#client_autocomplete_results').hide();
                }
            });

            // Autocompletado para modal de edición
            $('#edit_client_search_input').on('input', function () {
                const searchTerm = $(this).val();
                if (searchTerm.length >= 2) {
                    searchClientsForOrder(searchTerm, true);
                } else {
                    $('#edit_client_autocomplete_results').hide();
                }
            });

            // Ocultar resultados al hacer clic fuera
            $(document).on('click', function (e) {
                if (!$(e.target).closest('#client_search_input, #client_autocomplete_results').length) {
                    $('#client_autocomplete_results').hide();
                }
                if (!$(e.target).closest('#edit_client_search_input, #edit_client_autocomplete_results').length) {
                    $('#edit_client_autocomplete_results').hide();
                }
            });

            // Navegación con teclado para modal de creación
            $('#client_search_input').on('keydown', function (e) {
                handleClientAutocompleteKeyboard(e, false);
            });

            // Navegación con teclado para modal de edición
            $('#edit_client_search_input').on('keydown', function (e) {
                handleClientAutocompleteKeyboard(e, true);
            });

            // =============================================================================
            // EVENT LISTENERS PARA FILTROS (SEPARADO DEL AUTOCOMPLETADO)
            // ⚠️ IMPORTANTE: Solo para filtros de búsqueda en la página principal
            // =============================================================================

            // Búsqueda de clientes en filtros (mantener funcionalidad original)
            $('#client-search').on('input', function () {
                const searchTerm = $(this).val();
                if (searchTerm.length >= 2) {
                    searchClientsForFilters(searchTerm);
                } else {
                    $('#client-suggestions').hide();
                    $('#client-id-filter').val('');
                }
            });

            // Ocultar sugerencias de filtros al hacer clic fuera
            $(document).on('click', function (e) {
                if (!$(e.target).closest('#client-search, #client-suggestions').length) {
                    $('#client-suggestions').hide();
                }
            });

            // =============================================================================
            // VERIFICACIÓN DE SEPARACIÓN (SOLO PARA DESARROLLO)
            // =============================================================================
            // Descomenta las siguientes líneas para verificar la separación en consola
            // verifyAutocompleteSeparation();
            // testAutocompleteFunctions();

            // =============================================================================
            // EVENT LISTENERS PARA MODALES DE ESTADO
            // =============================================================================

            // Manejar checkbox de devolución de adelanto
            $('#refund_advance').on('change', function () {
                if ($(this).is(':checked')) {
                    $('#refund-details').slideDown(300);
                    $('#refund_cash_account').prop('required', true);
                } else {
                    $('#refund-details').slideUp(300);
                    $('#refund_cash_account').prop('required', false);
                    $('#refund_cash_account').val('');
                }
            });

            // Establecer fecha actual en modal de completar orden
            $('#completeOrderModal').on('shown.bs.modal', function () {
                if (!$('#complete_payment_date').val()) {
                    $('#complete_payment_date').val(getServerDate());
                }
            });

            // Limpiar modales al cerrarlos
            $('#completeOrderModal').on('hidden.bs.modal', function () {
                $('#complete-order-form')[0].reset();
                $('#complete_order_id').val('');
                $('#complete_order_balance').val('');
                $('#complete_order_total').val('');
                $('#complete_client_document').val('');
                $('#complete_client_name').val('');
                resetElectronicDocumentFields();
            });

            $('#cancelOrderModal').on('hidden.bs.modal', function () {
                $('#cancel-order-form')[0].reset();
                $('#cancel_order_id').val('');
                $('#cancel_order_advance').val('');
                $('#refund-details').hide();
                $('#refund_cash_account').prop('required', false);
            });

            // Limpiar modal de entrega al cerrarlo y restaurar select original
            $('#orderDeliveryStatusModal').on('hidden.bs.modal', function () {
                // Obtener el ID de la orden del modal
                const orderId = $('#orderDeliveryStatusId').val();
                if (orderId) {
                    // Buscar el select de entrega correspondiente
                    const deliverySelect = document.querySelector(`select.delivery-select[data-order-id="${orderId}"]`);
                    if (deliverySelect) {
                        // Restaurar el valor original
                        const originalValue = deliverySelect.getAttribute('data-original-value');
                        deliverySelect.value = originalValue;
                        // Restaurar los estilos visuales
                        updateDeliverySelectStyles(deliverySelect, originalValue);
                    }
                }
                // Limpiar el formulario
                $('#orderDeliveryStatusForm')[0].reset();
            });

            // Event listeners para el modal de completar orden
            $('#emit_electronic_document').on('change', function () {
                if ($(this).is(':checked')) {
                    $('#electronic-document-panel').slideDown(300);
                    // Cargar datos del cliente automáticamente
                    loadClientDataForDocument();
                } else {
                    $('#electronic-document-panel').slideUp(300);
                }
            });

            // Event listener para cambio de tipo de comprobante
            $('#document_type').on('change', function () {
                const documentType = $(this).val();
                if (documentType) {
                    updateDocumentFields(documentType);
                }
            });

            // Event listener para cancelar el modal de completar orden
            $('#completeOrderModal').on('click', '.btn-secondary', function () {
                // Restaurar el estado de la orden a pendiente
                restoreOrderStatusToPending();
            });

            // Validación en tiempo real para el número de documento
            $('#document_number').on('input', function () {
                const documentType = $('#document_type').val();
                const documentNumber = $(this).val();

                if (documentType && documentNumber) {
                    if (documentType === 'B' && documentNumber.length !== 8) {
                        $(this).addClass('is-invalid');
                    } else if (documentType === 'F' && documentNumber.length !== 11) {
                        $(this).addClass('is-invalid');
                    } else {
                        $(this).removeClass('is-invalid');
                    }
                }
            });
        });

        // Variables globales
        let orderDetails = [];
        let detailCounter = 0;

        function openCreateOrderModal() {
            // Limpiar formulario
            $('#order-form')[0].reset();
            $('#register_date').val(getServerDate());

            // Limpiar serie y correlativo
            $('#serial').val('');
            $('#correlative').val('');

            // Limpiar detalles
            orderDetails = [];
            detailCounter = 0;
            updateOrderDetailsTable();
            updateTotals();

            // Inicializar adelanto
            $('#advance_input').val('');
            updateAdvance();

            // Ocultar resultados de productos
            $('#products_results').hide();

            // Limpiar autocompletado de cliente
            clearClientSelection();

            // Seleccionar automáticamente la sucursal del usuario
            selectUserSubsidiary();

            // Seleccionar automáticamente el vendedor (usuario actual)
            selectCurrentUser();

            // Mostrar modal
            $('#createOrderModal').modal('show');

            // Verificar si hay un cliente pendiente de selección
            checkPendingClientSelection();
        }

        function updateCorrelative() {
            const subsidiaryId = $('#subsidiary_id').val();
            const orderType = $('#order_type').val();

            if (subsidiaryId && orderType) {
                $.ajax({
                    url: '{% url "apps.sales:get_correlative_order" %}',
                    type: 'GET',
                    data: {
                        'doc_type': orderType,
                        'subsidiary': subsidiaryId
                    },
                    success: function (response) {
                        if (response.success) {
                            $('#correlative').val(response.correlative);
                            $('#serial').val(response.serial);
                        }
                    }
                });
            }
        }

        function updateSerial() {
            const subsidiaryId = $('#subsidiary_id').val();
            if (subsidiaryId) {
                const selectedOption = $(`#subsidiary_id option[value="${subsidiaryId}"]`);
                const serial = selectedOption.data('serial');
                if (serial) {
                    $('#serial').val(serial);
                }
            } else {
                $('#serial').val('');
            }
        }

        function updateEditCorrelative() {
            const subsidiaryId = $('#edit_subsidiary_id').val();
            const orderType = $('#edit_order_type').val();

            if (subsidiaryId && orderType) {
                $.ajax({
                    url: '{% url "apps.sales:get_correlative_order" %}',
                    type: 'GET',
                    data: {
                        'doc_type': orderType,
                        'subsidiary': subsidiaryId
                    },
                    success: function (response) {
                        if (response.success) {
                            $('#edit_correlative').val(response.correlative);
                            $('#edit_serial').val(response.serial);
                        }
                    }
                });
            }
        }

        function updateEditSerial() {
            const subsidiaryId = $('#edit_subsidiary_id').val();
            if (subsidiaryId) {
                const selectedOption = $(`#edit_subsidiary_id option[value="${subsidiaryId}"]`);
                const serial = selectedOption.data('serial');
                if (serial) {
                    $('#edit_serial').val(serial);
                }
            } else {
                $('#edit_serial').val('');
            }
        }

        function searchProducts() {
            const searchTerm = $('#product_search').val();
            const categoryId = $('#product_category_filter').val();
            const productType = $('#product_type_filter').val();

            if (!searchTerm || searchTerm.length < 2) {
                $('#products_results').hide();
                return;
            }

            $.ajax({
                url: '{% url "apps.sales:get_products_for_order" %}',
                type: 'GET',
                data: {
                    'search': searchTerm,
                    'category_id': categoryId,
                    'product_type': productType
                },
                success: function (response) {
                    if (response.success && response.products.length > 0) {
                        displayProducts(response.products);
                        $('#products_results').show();

                        // Agregar eventos de teclado para navegación
                        setupProductKeyboardNavigation();
                    } else {
                        $('#products_list').html('<p class="text-muted text-center">No se encontraron productos</p>');
                        $('#products_results').show();
                    }
                },
                error: function () {
                    toastr.error('Error al buscar productos', 'Error');
                }
            });
        }

        function setupProductKeyboardNavigation() {
            let selectedIndex = -1;
            const productItems = $('#products_list .product-item');

            // Limpiar selección anterior
            productItems.removeClass('selected');

            // Evento de teclado en el campo de búsqueda
            $('#product_search').off('keydown.products').on('keydown.products', function (e) {
                if (!$('#products_results').is(':visible')) return;

                switch (e.keyCode) {
                    case 38: // Flecha arriba
                        e.preventDefault();
                        if (selectedIndex > 0) {
                            selectedIndex--;
                        } else {
                            selectedIndex = productItems.length - 1;
                        }
                        updateProductSelection();
                        break;

                    case 40: // Flecha abajo
                        e.preventDefault();
                        if (selectedIndex < productItems.length - 1) {
                            selectedIndex++;
                        } else {
                            selectedIndex = 0;
                        }
                        updateProductSelection();
                        break;

                    case 13: // Enter
                        e.preventDefault();
                        if (selectedIndex >= 0 && selectedIndex < productItems.length) {
                            const selectedItem = productItems.eq(selectedIndex);
                            const productId = selectedItem.data('product-id');
                            const productName = selectedItem.data('product-name');
                            const productPrice = selectedItem.data('product-price');
                            const productUnit = selectedItem.data('product-unit');

                            addProductToOrder(productId, productName, productPrice, productUnit);
                            $('#products_results').hide();
                            $('#product_search').val('');
                        }
                        break;

                    case 27: // Escape
                        $('#products_results').hide();
                        break;
                }
            });

            function updateProductSelection() {
                productItems.removeClass('selected');
                if (selectedIndex >= 0 && selectedIndex < productItems.length) {
                    productItems.eq(selectedIndex).addClass('selected');
                    // Hacer scroll al elemento seleccionado
                    const selectedElement = productItems.eq(selectedIndex)[0];
                    if (selectedElement) {
                        selectedElement.scrollIntoView({behavior: 'smooth', block: 'nearest'});
                    }
                }
            }
        }

        function displayProducts(products) {
            let html = '';
            products.forEach(product => {
                html += `
            <div class="product-item border-bottom p-2 cursor-pointer"
                 data-product-id="${product.id}"
                 data-product-name="${product.name}"
                 data-product-price="${product.price_sale}"
                 data-product-unit="${product.unit}"
                 onclick="addProductToOrder(${product.id}, '${product.name}', ${product.price_sale}, '${product.unit}')">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <strong class="text-primary">${product.name}</strong>
                        <br><small class="text-muted">Código: ${product.code || 'N/A'}</small>
                        <br><small class="text-info">Categoría: ${product.category}</small>
                    </div>
                    <div class="text-right">
                        <span class="badge badge-success">S/ ${product.price_sale.toFixed(2)}</span>
                        <br><small class="text-muted">${product.unit}</small>
                    </div>
                </div>
            </div>
        `;
            });
            $('#products_list').html(html);
        }

        function addProductToOrder(productId, productName, price, unit) {
            // Verificar si el producto ya está en la orden
            const existingDetail = orderDetails.find(detail => detail.product_id === productId);
            if (existingDetail) {
                existingDetail.quantity += 1;
                updateDetailRow(existingDetail);
            } else {
                const fullProductName = `${productName}`;

                const newDetail = {
                    id: ++detailCounter,
                    product_id: productId,
                    product_name: fullProductName,
                    quantity: 1,
                    price_unit: price,
                    unit: unit,
                    observation: '',
                    subtotal: price
                };
                orderDetails.push(newDetail);
                addDetailRow(newDetail);
            }

            updateTotals();
            $('#products_results').hide();
            $('#product_search').val('');
        }

        function addEmptyProductRow() {
            const newDetail = {
                id: ++detailCounter,
                product_id: null,
                product_name: '',
                quantity: 1,
                price_unit: 0,
                unit: '',
                observation: '',
                subtotal: 0
            };
            orderDetails.push(newDetail);
            addDetailRow(newDetail);
        }

        /*<td>
                <input type="text" class="form-control form-control-sm"
                       value="${detail.observation || ''}"
                       placeholder="Observación"
                       onkeyup="updateDetailField(${detail.id}, 'observation', this.value)">
            </td>*/

        function addDetailRow(detail) {
            const row = `
        <tr id="detail-row-${detail.id}">
            <td class="text-center">${detail.id}</td>
            <td>
                <input type="text" class="form-control form-control-sm"
                       value="${detail.product_name}"
                       placeholder="Nombre del producto (editable)"
                       title="Puede editar este campo libremente para agregar especificaciones, notas o cualquier información adicional"
                       onkeyup="updateProductName(${detail.id}, this.value)"
                       onblur="updateProductName(${detail.id}, this.value)">
            </td>
            <td class="text-center">
                <input type="number" class="form-control form-control-sm"
                       value="${detail.quantity}"
                       min="0.01" step="0.01"
                       onkeyup="updateDetailField(${detail.id}, 'quantity', this.value)">
            </td>
            <td class="text-right">
                <input type="number" class="form-control form-control-sm"
                       value="${detail.price_unit}"
                       min="0" step="0.01"
                       onkeyup="updateDetailField(${detail.id}, 'price_unit', this.value)">
            </td>
            <td class="text-right font-weight-bold">
                S/ <span id="subtotal-${detail.id}">${detail.subtotal.toFixed(2)}</span>
            </td>
            <td class="text-center">
                <button type="button" class="btn btn-danger btn-sm" onclick="removeDetail(${detail.id})">
                    <i class="fas fa-trash fa-2xs"></i>
                </button>
            </td>
        </tr>
    `;
            $('#order_details_body').append(row);
        }

        function updateProductName(detailId, value) {
            const detail = orderDetails.find(d => d.id === detailId);
            if (detail) {
                // Guardar exactamente lo que el usuario escriba en el campo product_name
                // Esto permite al usuario agregar información adicional como:
                // - Especificaciones técnicas
                // - Notas de color, tamaño, material
                // - Códigos internos
                // - Cualquier texto descriptivo adicional
                detail.product_name = value;
                console.log(`Product name updated for detail ${detailId}: "${value}"`);
            }
        }

        function updateDetailField(detailId, field, value) {
            const detail = orderDetails.find(d => d.id === detailId);
            if (detail) {
                detail[field] = field === 'quantity' || field === 'price_unit' ? parseFloat(value) || 0 : value;
                detail.subtotal = detail.quantity * detail.price_unit;

                // Si se actualiza el precio o la cantidad, NO sobrescribir el product_name manual
                // Solo actualizar el subtotal, el usuario puede editar el nombre libremente
                if (field === 'price_unit' || field === 'quantity') {
                    // NO actualizar product_name automáticamente
                    // El usuario puede escribir cualquier texto en ese campo
                }

                // Actualizar subtotal en la fila
                $(`#subtotal-${detailId}`).text(detail.subtotal.toFixed(2));

                updateTotals();
            }
        }

        function updateDetailRow(detail) {
            const row = $(`#detail-row-${detail.id}`);
            row.find('input[placeholder="Nombre del producto (editable)"]').val(detail.product_name);
            row.find('input[placeholder="Observación"]').val(detail.observation || '');
            row.find('input[type="number"]').first().val(detail.quantity);
            row.find('input[type="number"]').last().val(detail.price_unit);
            $(`#subtotal-${detail.id}`).text(detail.subtotal.toFixed(2));
        }

        function removeDetail(detailId) {
            orderDetails = orderDetails.filter(d => d.id !== detailId);
            $(`#detail-row-${detailId}`).remove();
            updateTotals();
            reorderRows();
        }

        function reorderRows() {
            $('#order_details_body tr').each(function (index) {
                $(this).find('td:first').text(index + 1);
            });
        }

        function updateOrderDetailsTable() {
            $('#order_details_body').empty();
            orderDetails.forEach(detail => {
                addDetailRow(detail);
            });
        }

        function updateTotals() {
            const subtotal = orderDetails.reduce((sum, detail) => sum + detail.subtotal, 0);
            // El subtotal es el total sin IGV, el total es el subtotal + IGV
            // Pero en este caso, el subtotal ya incluye el IGV, así que calculamos el total real
            const total = subtotal; // El total es la suma de (cantidad * precio)
            const subtotalSinIGV = total / 1.18; // Calculamos el subtotal sin IGV
            const igv = total - subtotalSinIGV; // El IGV es la diferencia

            $('#subtotal_total').text(`S/ ${subtotalSinIGV.toFixed(2)}`);
            $('#igv_total').text(`S/ ${igv.toFixed(2)}`);
            $('#total_final').text(`S/ ${total.toFixed(2)}`);

            // Actualizar adelanto y faltante
            updateAdvance();
        }

        function updateAdvance() {
            const total = parseFloat($('#total_final').text().replace('S/ ', '').replace(',', '')) || 0;
            const advance = parseFloat($('#advance_input').val()) || 0;
            // El faltante se calcula desde el total (IGV incluido)
            const remaining = total - advance;

            // Actualizar faltante
            $('#remaining_amount').text(`S/ ${remaining.toFixed(2)}`);

            // Cambiar color del faltante según el valor
            const remainingRow = $('#remaining_amount').closest('tr');
            if (remaining < 0) {
                remainingRow.removeClass('table-danger table-success').addClass('table-warning');
                $('#remaining_amount').text(`S/ ${Math.abs(remaining).toFixed(2)} (Excedente)`);
            } else if (remaining === 0) {
                remainingRow.removeClass('table-danger table-warning').addClass('table-success');
                $('#remaining_amount').text('S/ 0.00 (Pagado)');
            } else {
                remainingRow.removeClass('table-success table-warning').addClass('table-danger');
                $('#remaining_amount').text(`S/ ${remaining.toFixed(2)}`);
            }
        }


        // Función para actualizar adelanto en edición
        function updateEditAdvance() {
            const total = parseFloat($('#edit_total_final').text().replace('S/ ', '').replace(',', '')) || 0;
            const advance = parseFloat($('#edit_advance_input').val()) || 0;
            const remaining = total - advance;

            // Actualizar faltante
            $('#edit_remaining_amount').text(`S/ ${remaining.toFixed(2)}`);

            // Cambiar color del faltante según el valor
            const remainingRow = $('#edit_remaining_amount').closest('tr');
            if (remaining < 0) {
                remainingRow.removeClass('table-danger table-success').addClass('table-warning');
                $('#edit_remaining_amount').text(`S/ ${Math.abs(remaining).toFixed(2)} (Excedente)`);
            } else if (remaining === 0) {
                remainingRow.removeClass('table-danger table-warning').addClass('table-success');
                $('#edit_remaining_amount').text('S/ 0.00 (Pagado)');
            } else {
                remainingRow.removeClass('table-success table-warning').addClass('table-danger');
                $('#edit_remaining_amount').text(`S/ ${remaining.toFixed(2)}`);
            }
        }

        // Sincronizar adelanto del formulario principal con el de la tabla
        /*$('#cash_advance').on('input', function () {
            updateAdvanceFromMain();
        });

        // Sincronizar adelanto del formulario principal de edición con el de la tabla
        $('#edit_cash_advance').on('input', function () {
            updateEditAdvanceFromMain();
        });*/

        // Función para calcular total al precio (IGV incluido)
        function calculateTotalWithIGV(subtotal) {
            return subtotal * 1.18; // Total con IGV incluido
        }

        // Función para calcular subtotal desde total con IGV
        function calculateSubtotalFromTotal(total) {
            return total / 1.18; // Subtotal sin IGV
        }

        // Función para calcular IGV desde total
        function calculateIGVFromTotal(total) {
            const subtotal = calculateSubtotalFromTotal(total);
            return total - subtotal; // IGV
        }

        function saveOrder() {
            // Validar formulario
            if (!validateForm()) {
                return;
            }

            // Validar que haya al menos un detalle
            if (orderDetails.length === 0) {
                toastr.error('Debe agregar al menos un producto o servicio', 'Error');
                return;
            }

            // Preparar datos
            const formData = new FormData($('#order-form')[0]);

            // Verificar si el adelanto es igual al total para marcar como completado
            const total = parseFloat($('#total_final').text().replace('S/ ', '').replace(',', '')) || 0;
            const advance = parseFloat($('#advance_input').val()) || 0;

            if (advance >= total && total > 0) {
                formData.append('auto_complete', 'true');
                console.log('Orden marcada como completada automáticamente - Adelanto cubre el total');
            }

            // Agregar detalles como JSON
            // Nota: product_name se guarda exactamente como lo escribió el usuario
            // incluyendo cualquier información adicional agregada manualmente
            const detailsJson = JSON.stringify(orderDetails);
            formData.append('details', detailsJson);

            // Enviar formulario
            $.ajax({
                url: '{% url "apps.sales:order_save" %}',
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                success: function (response) {
                    console.log(response)
                    if (response.success) {
                        // Si hay contenido del PDF, descargarlo automáticamente
                        if (response.pdf_content) {
                            toastr.success(response.message + '\n\nSe descargará el PDF del ticket automáticamente.', '¡Éxito!');
                            $('#createOrderModal').modal('hide');
                            loadOrders();

                            // Descargar PDF automáticamente desde base64
                            const pdfBlob = base64ToBlob(response.pdf_content, 'application/pdf');
                            const pdfUrl = URL.createObjectURL(pdfBlob);
                            
                            // Crear enlace de descarga temporal
                            const downloadLink = document.createElement('a');
                            downloadLink.href = pdfUrl;
                            downloadLink.download = response.pdf_filename || `ticket_${response.order_code}.pdf`;
                            
                            // Simular clic para descargar
                            document.body.appendChild(downloadLink);
                            downloadLink.click();
                            document.body.removeChild(downloadLink);
                            
                            // Limpiar el objeto URL después de un tiempo
                            setTimeout(() => URL.revokeObjectURL(pdfUrl), 1000);
                            
                            // Código comentado para apertura en nueva pestaña (por si se necesita en el futuro)
                            // window.open(pdfUrl, '_blank');
                        } else {
                            toastr.success(response.message, '¡Éxito!');
                            $('#createOrderModal').modal('hide');
                            loadOrders();
                        }
                    } else {
                        toastr.error(response.message, 'Error');
                    }
                },
                error: function (xhr) {
                    let msg = 'Error al guardar la orden';
                    if (xhr.responseJSON && xhr.responseJSON.message) {
                        msg = xhr.responseJSON.message;
                    }
                    toastr.error(msg, 'Error');
                }
            });
        }

        function validateForm() {
            const requiredFields = ['order_type', 'subsidiary_id', 'user_id', 'client_id', 'cash_account_id'];

            for (const field of requiredFields) {
                const value = $(`#${field}`).val();
                if (!value) {
                    toastr.error('Por favor complete todos los campos obligatorios', 'Error');
                    $(`#${field}`).focus();
                    return false;
                }
            }

            return true;
        }

        function loadOrders() {
            $('#loading-overlay').show();
            $('#orders-count-text').text('Cargando...');

            $.ajax({
                url: '{% url "apps.sales:order_list" %}',
                type: 'POST',
                data: $('#search-form').serialize(),
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                success: function (response) {
                    $('#orders-grid').html(response.grid);
                    $('#loading-overlay').hide();

                    // Actualizar indicador de fecha
                    updateDateIndicator();

                    // Actualizar conteo de órdenes
                    updateOrdersCount();
                    
                    // Inicializar colores de los selects después de cargar la tabla
                    setTimeout(function() {
                        initializeSelectColors();
                    }, 100);
                },
                error: function (xhr, status, error) {
                    $('#loading-overlay').hide();
                    $('#orders-count-text').text('Error al cargar');
                    // Quitar el SweetAlert de error inicial
                    console.error('Error al cargar las órdenes:', error);
                }
            });
        }

        function updateOrdersCount() {
            const ordersCount = $('#orders-grid .table tbody tr').length;
            const dateFrom = $('#date-from').val();
            const dateTo = $('#date-to').val();

            if (ordersCount === 0) {
                $('#orders-count-text').text('No hay órdenes');
            } else if (dateFrom && dateTo && dateFrom === dateTo) {
                const date = parseLocalDate(dateFrom);
                const formattedDate = date.toLocaleDateString('es-ES', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                $('#orders-count-text').text(`${ordersCount} orden${ordersCount !== 1 ? 'es' : ''} del ${formattedDate}`);
            } else if (dateFrom && dateTo) {
                const fromDate = new Date(dateFrom);
                const toDate = new Date(dateTo);
                const fromFormatted = fromDate.toLocaleDateString('es-ES', {
                    day: 'numeric',
                    month: 'numeric',
                    year: 'numeric'
                });
                const toFormatted = toDate.toLocaleDateString('es-ES', {
                    day: 'numeric',
                    month: 'numeric',
                    year: 'numeric'
                });
                $('#orders-count-text').text(`${ordersCount} orden${ordersCount !== 1 ? 'es' : ''} del ${fromFormatted} al ${toFormatted}`);
            } else {
                $('#orders-count-text').text(`${ordersCount} orden${ordersCount !== 1 ? 'es' : ''} del día de hoy`);
            }
        }

        function updateDateIndicator() {
            const dateFrom = $('#date-from').val();
            const dateTo = $('#date-to').val();
            const dateIndicator = $('#date-indicator');

            if (dateFrom && dateTo) {
                if (dateFrom === dateTo) {
                    const date = parseLocalDate(dateFrom);
                    const formattedDate = date.toLocaleDateString('es-ES', {
                        weekday: 'long',
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    });
                    dateIndicator.text(`Mostrando órdenes del ${formattedDate}`);
                } else {
                    const fromDate = parseLocalDate(dateFrom);
                    const toDate = parseLocalDate(dateTo);
                    const fromFormatted = fromDate.toLocaleDateString('es-ES', {
                        day: 'numeric',
                        month: 'numeric',
                        year: 'numeric'
                    });
                    const toFormatted = toDate.toLocaleDateString('es-ES', {
                        day: 'numeric',
                        month: 'numeric',
                        year: 'numeric'
                    });
                    dateIndicator.text(`Mostrando órdenes del ${fromFormatted} al ${toFormatted}`);
                }
            } else {
                dateIndicator.text('Mostrando órdenes del día de hoy');
            }
        }

        function parseLocalDate(input) {
            const [year, month, day] = input.split('-').map(Number);
            return new Date(year, month - 1, day);
        }

        function openCreateClientModal() {
            $('#create-client-form')[0].reset();
            clearClientFields();
            restoreOriginalButton();
            $('#createClientModal').modal('show');
        }

        function saveNewClient() {
            // Validar formulario
            const document = $('#new_client_document').val();
            const number = $('#new_client_number').val();
            const fullName = $('#new_client_name').val().trim();

            // Solo el nombre es obligatorio
            if (!fullName) {
                toastr.error('El campo Nombre Completo es obligatorio', 'Error');
                return;
            }

            // Validar formato del documento solo si se proporciona
            if (document && number && document === '06' && number.length !== 11) {
                toastr.error('El RUC debe tener 11 dígitos', 'Error');
                //$('#new_client_number').focus();
                $('#new_client_name').focus();
                return;
            }

            // Mostrar loading
            const saveButton = $('#createClientModal .btn-info');
            const originalText = saveButton.html();
            saveButton.html('<i class="fas fa-spinner fa-spin mr-1"></i>Guardando...');
            saveButton.prop('disabled', true);

            const formData = new FormData($('#create-client-form')[0]);

            $.ajax({
                url: '{% url "apps.sales:create_client" %}',
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                success: function (response) {
                    if (response.success) {
                        if (response.existing) {
                            // Cliente ya existe, mostrar mensaje y seleccionarlo
                            toastr.success(response.message, 'Cliente Existente');
                        } else {
                            // Cliente creado exitosamente
                            toastr.success(response.message, '¡Cliente Creado!');
                        }

                        // Cerrar modal de crear cliente
                        $('#createClientModal').modal('hide');

                        // Seleccionar el cliente en el modal de nueva orden
                        const clientSelected = selectClientInOrderModal(response.client);

                        // Mostrar confirmación solo si se seleccionó correctamente
                        if (clientSelected) {
                            toastr.success(`Cliente "${response.client.full_name}" seleccionado automáticamente`, 'Cliente Seleccionado');
                        }
                    } else {
                        toastr.error(response.message, 'Error');
                    }
                },
                error: function (xhr) {
                    let errorMessage = 'Error al crear el cliente';
                    if (xhr.responseJSON && xhr.responseJSON.message) {
                        errorMessage = xhr.responseJSON.message;
                    }
                    toastr.error(errorMessage, 'Error');
                },
                complete: function () {
                    // Restaurar botón
                    saveButton.html(originalText);
                    saveButton.prop('disabled', false);
                }
            });
        }


        function selectUserSubsidiary() {
            // Obtener la sucursal del usuario actual desde el contexto de Django
            // Esta información debe estar disponible en el template
            const userSubsidiaryId = '{{ request.user.subsidiary.id|default:"" }}';
            if (userSubsidiaryId) {
                $('#subsidiary_id').val(userSubsidiaryId);
                //$('#subsidiary_id').prop('disabled', true);
                //$('#subsidiary_id').addClass('disabled-field');

                // Actualizar serie y correlativo
                updateSerial();
                updateCorrelative();
            }
        }

        function selectCurrentUser() {
            // Obtener el ID del usuario actual desde el contexto de Django
            const currentUserId = '{{ request.user.id }}';
            if (currentUserId) {
                $('#user_id').val(currentUserId);
                //$('#user_id').prop('disabled', true);
                //$('#user_id').addClass('disabled-field');
            }
        }

        function checkPendingClientSelection() {
            // Verificar si hay un cliente pendiente de selección
            const pendingClient = sessionStorage.getItem('pendingClientSelection');
            if (pendingClient) {
                try {
                    const client = JSON.parse(pendingClient);
                    // Limpiar el cliente pendiente
                    sessionStorage.removeItem('pendingClientSelection');

                    // Seleccionar el cliente
                    selectClientInOrderModal(client);

                    // Mostrar mensaje de confirmación
                    toastr.success(`Cliente "${client.full_name}" seleccionado automáticamente`, 'Cliente Seleccionado');
                } catch (error) {
                    console.error('Error al procesar cliente pendiente:', error);
                    sessionStorage.removeItem('pendingClientSelection');
                }
            }
        }

        function selectClientInOrderModal(client) {
            // Verificar si el modal de nueva orden está abierto
            if ($('#createOrderModal').hasClass('show')) {
                // Seleccionar el cliente en el campo de búsqueda del modal de nueva orden
                const documentType = client.document === '01' ? 'DNI' :
                    client.document === '06' ? 'RUC' : 'S/D';
                const documentNumber = client.number || 'S/N';
                const clientDisplayText = `${client.full_name} - ${documentType}: ${documentNumber}`;

                // Establecer el valor en el campo de búsqueda
                $('#client_search_input').val(clientDisplayText);
                $('#client_search_input').addClass('client-selected');
                $('#client_search_input').attr('readonly', true);

                // Establecer el ID del cliente en el campo oculto
                $('#client_id').val(client.id);

                // Mostrar el botón de limpiar cliente
                $('.btn-clear-client').show();

                // Limpiar resultados de autocompletado si están visibles
                $('#client_autocomplete_results').hide();

                console.log('✅ Cliente seleccionado en modal de nueva orden:', client.full_name);
                return true;
            }
            // Verificar si el modal de edición está abierto
            else if ($('#editOrderModal').hasClass('show')) {
                // Seleccionar el cliente en el campo de búsqueda del modal de edición
                const documentType = client.document === '01' ? 'DNI' :
                    client.document === '06' ? 'RUC' : 'S/D';
                const documentNumber = client.number || 'S/N';
                const clientDisplayText = `${client.full_name} - ${documentType}: ${documentNumber}`;

                // Establecer el valor en el campo de búsqueda
                $('#edit_client_search_input').val(clientDisplayText);
                $('#edit_client_search_input').addClass('client-selected');
                $('#edit_client_search_input').attr('readonly', true);

                // Establecer el ID del cliente en el campo oculto
                $('#edit_client_id').val(client.id);

                // Mostrar el botón de limpiar cliente
                $('.btn-clear-client').show();

                // Limpiar resultados de autocompletado si están visibles
                $('#edit_client_autocomplete_results').hide();

                console.log('✅ Cliente seleccionado en modal de edición:', client.full_name);
                return true;
            } else {
                console.log('⚠️ Ningún modal de orden está abierto');
                // Si no hay modal abierto, mostrar mensaje informativo y guardar el cliente para selección posterior
                toastr.info('Abra el modal de nueva orden o edición para seleccionar el cliente', 'Modal no abierto');

                // Guardar el cliente en sessionStorage para selección posterior
                sessionStorage.setItem('pendingClientSelection', JSON.stringify(client));

                return false;
            }
        }


        function changeButtonToSelect(clientId, clientName) {
            // Cambiar el botón de "Guardar Cliente" a "Seleccionar Cliente"
            const saveButton = $('#createClientModal .btn-info');
            saveButton.html('<i class="fas fa-check mr-1"></i>Seleccionar Cliente');
            saveButton.removeClass('btn-info').addClass('btn-success');

            // Limpiar eventos anteriores y asignar el nuevo
            saveButton.off('click').on('click', function () {
                selectClientFromModal(clientId, clientName);
            });
            saveButton.attr('title', 'Seleccionar este cliente para la orden');

            // Agregar indicador visual
            $('#createClientModal .modal-header').addClass('bg-success').removeClass('bg-info');

            // Mostrar indicador de cliente listo
            $('#ready-client-name').text(clientName);
        }


        function selectClientFromModal(clientId, clientName) {
            // Si no se pasan parámetros, obtenerlos del indicador
            console.log("clientId", clientId)
            console.log("clientName", clientName)
            if (!clientId || !clientName) {
                const indicator = $('#client-ready-indicator');
                clientId = indicator.data('client-id');
                clientName = indicator.data('client-name');
            }

            if (!clientId || !clientName) {
                toastr.error('No hay cliente listo para seleccionar', 'Error de selección');
                return;
            }

            // Seleccionar el cliente en el modal de nueva orden
            if ($('#createOrderModal').hasClass('show')) {
                // Si el modal de nueva orden está abierto, seleccionar el cliente ahí
                $('#client_id').val(clientId);

                // Actualizar el texto del select
                const clientOption = $(`#client_id option[value="${clientId}"]`);
                if (clientOption.length) {
                    clientOption.prop('selected', true);
                } else {
                    // Si no existe la opción, agregarla
                    const documentType = $('#new_client_document').val() === '01' ? 'DNI' : 'RUC';
                    const documentNumber = $('#new_client_number').val();
                    const newOption = new Option(
                        `${clientName} - ${documentType}: ${documentNumber}`,
                        clientId,
                        true,
                        true
                    );
                    $('#client_id').append(newOption);
                }

                // Cerrar modal de cliente
                $('#createClientModal').modal('hide');

                // Mostrar confirmación
                toastr.success(`Cliente "${clientName}" seleccionado para la orden`, 'Cliente seleccionado');

                // Restaurar botón original
                restoreOriginalButton();

            } else {
                // Si no hay modal de orden abierto, mostrar mensaje
                toastr.info('Abra el modal de nueva orden para seleccionar el cliente', 'Modal no abierto');
            }
        }

        function restoreOriginalButton() {
            // Restaurar el botón a su estado original
            const saveButton = $('#createClientModal .btn-success');
            saveButton.html('<i class="fas fa-save mr-1"></i>Guardar Cliente');
            saveButton.removeClass('btn-success').addClass('btn-info');

            // Limpiar eventos anteriores y asignar el original
            saveButton.off('click').on('click', function () {
                saveNewClient();
            });
            saveButton.attr('title', 'Guardar nuevo cliente');

            // Restaurar header del modal
            $('#createClientModal .modal-header')
                .removeClass('bg-success')
                .addClass('bg-info');

            // Ocultar indicador de cliente listo
            $('#client-ready-indicator').hide();
        }


        function clearClientFields() {
            // Limpiar todos los campos del formulario de cliente
            $('#new_client_name').val('');
            $('#new_client_address').val('');
            $('#new_client_phone').val('');
            $('#new_client_email').val('');

            // Limpiar indicadores visuales
            $('#new_client_number').removeClass('is-valid is-invalid loading');
            $('.search-indicator').remove();

            // Limpiar tooltips
            if ($('#new_client_number').data('bs.tooltip')) {
                $('#new_client_number').tooltip('hide');
            }

            // Restaurar botón original
            restoreOriginalButton();
        }

        function searchClientInAPI() {
            const documentType = $('#new_client_document').val();
            const documentNumber = $('#new_client_number').val();

            if (!documentType || !documentNumber) {
                toastr.error('Debe seleccionar el tipo de documento y escribir el número', 'Error de validación');
                return;
            }

            // Validar formato del documento antes de consultar
            if (documentType === '01' && documentNumber.length !== 8) {
                toastr.error('El DNI debe tener exactamente 8 dígitos', 'Error de validación');
                return;
            } else if (documentType === '06' && documentNumber.length !== 11) {
                toastr.error('El RUC debe tener exactamente 11 dígitos', 'Error de validación');
                return;
            }

            // Mostrar loading
            const numberField = $('#new_client_number');
            const originalValue = numberField.val();
            numberField.prop('disabled', true);
            numberField.addClass('loading');

            // Agregar indicador visual de búsqueda
            if (!numberField.next('.search-indicator').length) {
                numberField.after('<span class="search-indicator ml-2"><i class="fas fa-spinner fa-spin text-primary"></i> Buscando...</span>');
            }

            $.ajax({
                url: '{% url "apps.sales:get_api_person" %}',
                type: 'GET',
                data: {
                    'nro_document': documentNumber,
                    'type': documentType
                },
                success: function (response) {
                    // Ocultar indicador de búsqueda
                    $('.search-indicator').remove();
                    numberField.prop('disabled', false);
                    numberField.removeClass('loading');

                    if (response.pk) {
                        // Cliente encontrado (en BD o API)
                        if (response.message === 'Cliente encontrado en BD') {
                            // Cliente ya existe en la base de datos
                            toastr.info('Este cliente ya está registrado en el sistema', 'Cliente existente');

                            if (documentType === '01') {
                                // DNI - Persona natural
                                $('#new_client_name').val(response.names || '');
                                $('#new_client_address').val(response.address || '');
                            } else if (documentType === '06') {
                                // RUC - Empresa (el tipo '06' es para RUC según la función get_api_person)
                                $('#new_client_name').val(response.names || '');
                                $('#new_client_address').val(response.address || '');
                            }
                            changeButtonToSelect(response.pk, response.names);
                            // Limpiar campos
                            //clearClientFields();

                        } else {
                            // Cliente encontrado en API externa
                            toastr.success('Cliente encontrado y registrado automáticamente', '¡Cliente encontrado!');

                            // Llenar campos con la información obtenida
                            if (documentType === '01') {
                                // DNI - Persona natural
                                $('#new_client_name').val(response.names || '');
                                $('#new_client_address').val(response.address || '');
                            } else if (documentType === '06') {
                                // RUC - Empresa (el tipo '06' es para RUC según la función get_api_person)
                                $('#new_client_name').val(response.names || '');
                                $('#new_client_address').val(response.address || '');
                            }

                            // Marcar como válido
                            numberField.addClass('is-valid');
                            numberField.removeClass('is-invalid');

                            // Cambiar botón a "Seleccionar" y guardar ID del cliente
                            changeButtonToSelect(response.pk, response.names);
                        }
                    } else {
                        // No se encontró el cliente
                        toastr.warning('Cliente no encontrado. Complete los datos manualmente.', 'Cliente no encontrado');

                        // Marcar como inválido
                        numberField.addClass('is-invalid');
                        numberField.removeClass('is-valid');

                        // Limpiar campos
                        clearClientFields();
                    }
                },
                error: function (xhr) {
                    // Ocultar indicador de búsqueda
                    $('.search-indicator').remove();
                    numberField.prop('disabled', false);
                    numberField.removeClass('loading');

                    let errorMessage = 'Error al consultar el documento';

                    if (xhr.responseJSON && xhr.responseJSON.error) {
                        errorMessage = xhr.responseJSON.error;
                    } else if (xhr.status === 500) {
                        errorMessage = 'Error interno del servidor';
                    } else if (xhr.status === 404) {
                        errorMessage = 'Servicio no disponible';
                    }

                    toastr.error(errorMessage, 'Error en la consulta');

                    // Marcar como inválido
                    numberField.addClass('is-invalid');
                    numberField.removeClass('is-valid');

                    // Limpiar campos
                    clearClientFields();
                }
            });
        }

        function validateDocumentFormat() {
            const documentType = $('#new_client_document').val();
            const number = $('#new_client_number').val();
            const numberField = $('#new_client_number');

            // Remover clases de validación previas
            numberField.removeClass('is-valid is-invalid');

            if (documentType && number) {
                let isValid = false;
                let message = '';

                if (documentType === '01') {
                    isValid = number.length === 8 && /^\d+$/.test(number);
                    message = 'El DNI debe tener exactamente 8 dígitos numéricos';
                } else if (documentType === '02') {
                    isValid = number.length === 11 && /^\d+$/.test(number);
                    message = 'El RUC debe tener exactamente 11 dígitos numéricos';
                }

                if (isValid) {
                    numberField.addClass('is-valid');
                    numberField.removeClass('is-invalid');
                } else {
                    numberField.addClass('is-invalid');
                    numberField.removeClass('is-valid');

                    // Mostrar tooltip de error
                    if (!numberField.data('bs.tooltip')) {
                        numberField.tooltip({
                            title: message,
                            placement: 'top',
                            trigger: 'manual'
                        });
                    }
                    numberField.tooltip('show');
                }
            }
        }

        // Funciones para las acciones de la tabla
        function showOrderDetail(orderId) {
            $.ajax({
                url: '{% url "apps.sales:order_detail_modal" %}',
                type: 'GET',
                data: {'order_id': orderId},
                success: function (response) {
                    console.log(response)
                    if (response.success) {
                        // Crear modal dinámicamente
                        const modalHtml = `
                    <div class="modal fade" id="orderDetailModal" tabindex="-1" role="dialog">
                        <div class="modal-dialog modal-lg" role="document">
                            <div class="modal-content">
                                <div class="modal-header bg-info text-white">
                                    <h5 class="modal-title">
                                        <i class="fas fa-eye mr-2"></i>Detalles de la Orden
                                    </h5>
                                    <button type="button" class="close text-white" data-dismiss="modal">
                                        <span>&times;</span>
                                    </button>
                                </div>
                                <div class="modal-body">
                                    ${response.form}
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-dismiss="modal">
                                        <i class="fas fa-times mr-1"></i>Cerrar
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                        // Remover modal anterior si existe
                        $('#orderDetailModal').remove();

                        // Agregar nuevo modal al body
                        $('body').append(modalHtml);

                        // Mostrar modal
                        $('#orderDetailModal').modal('show');
                    } else {
                        toastr.error(response.message, 'Error');
                    }
                },
                error: function () {
                    toastr.error('Error al cargar los detalles de la orden', 'Error');
                }
            });
        }

        function downloadTicketPDF(orderId) {
            // Mostrar indicador de descarga
            toastr.info('Generando PDF... Por favor espere mientras se genera el ticket', 'Generando PDF');

            // Crear un enlace temporal para descargar el PDF
            const downloadLink = document.createElement('a');
            downloadLink.href = `{% url "apps.sales:download_ticket_pdf" 0 %}`.replace('0', orderId);
            downloadLink.download = `ticket_${orderId}.pdf`;

            // Simular clic en el enlace
            document.body.appendChild(downloadLink);
            downloadLink.click();
            document.body.removeChild(downloadLink);

            // Mostrar confirmación
            setTimeout(() => {
                toastr.success('PDF generado y descargado exitosamente', 'Descarga Completada');
            }, 1000);
        }

        function editOrder(orderId) {
            // Cargar datos de la orden para edición
            loadOrderForEdit(orderId);
        }

        // Variables globales para edición
        let editOrderDetails = [];
        let editDetailCounter = 0;

        function loadOrderForEdit(orderId) {
            // Mostrar loading
            $('#loading-overlay').show();

            // Limpiar autocompletado de cliente
            clearEditClientSelection();

            // Cargar datos de la orden
            $.ajax({
                url: '{% url "apps.sales:get_order_for_edit" %}',
                type: 'GET',
                data: {'order_id': orderId},
                success: function (response) {
                    if (response.success) {
                        // Establecer el ID de la orden en todos los campos ocultos
                        $('#edit_order_id').val(orderId);
                        $('#edit_order_id_for_update').val(orderId);
                        $('#edit_order_id_hidden').val(orderId);

                        // Cargar datos en el formulario
                        populateEditFormWithData(response.order);

                        // Mostrar modal
                        $('#editOrderModal').modal('show');

                        // Verificar si hay un cliente pendiente de selección
                        checkPendingClientSelection();
                    } else {
                        toastr.error(response.message, 'Error');
                    }
                },
                error: function () {
                    toastr.error('Error al cargar los datos de la orden', 'Error');
                },
                complete: function () {
                    $('#loading-overlay').hide();
                }
            });
        }

        function populateEditFormWithData(orderData) {
            // Limpiar formulario
            $('#edit-order-form')[0].reset();

            // Establecer valores en los campos
            $('#edit_order_type').val(orderData.type);
            $('#edit_client_id').val(orderData.client_id);
            $('#edit_user_id').val(orderData.user_id);
            $('#edit_subsidiary_id').val(orderData.subsidiary_id);
            $('#edit_register_date').val(orderData.register_date);
            $('#edit_delivery_date').val(orderData.delivery_date);
            $('#edit_way_to_pay').val(orderData.way_to_pay);
            $('#edit_voucher_type').val(orderData.voucher_type);
            $('#edit_observation').val(orderData.observation);

            // Actualizar serie y correlativo
            updateEditSerial();
            updateEditCorrelative();

            // Cargar detalles
            editOrderDetails = [];
            editDetailCounter = 0;

            if (orderData.details && orderData.details.length > 0) {
                orderData.details.forEach(detail => {
                    const newDetail = {
                        id: ++editDetailCounter,
                        product_id: detail.product_id,
                        product_name: detail.product_name,
                        quantity: detail.quantity,
                        price_unit: detail.price_unit,
                        unit: detail.unit || '',
                        observation: detail.observation || '',
                        subtotal: detail.subtotal
                    };
                    editOrderDetails.push(newDetail);
                });
            }

            // Actualizar tabla de detalles y totales
            updateEditOrderDetailsTable();
            updateEditTotals();

            // Establecer adelanto
            $('#edit_advance_input').val(orderData.cash_advance.toFixed(2));
            updateEditAdvance();

            // Establecer cliente en el input de búsqueda
            if (orderData.client_id) {
                // Buscar información del cliente para mostrar en el input
                $.ajax({
                    url: '{% url "apps.sales:search_clients_autocomplete" %}',
                    type: 'GET',
                    data: {'search': orderData.client_id},
                    success: function (response) {
                        if (response.success && response.clients.length > 0) {
                            const client = response.clients[0];
                            const documentType = client.document === '01' ? 'DNI' :
                                client.document === '06' ? 'RUC' : 'S/D';
                            const documentNumber = client.number || 'S/N';
                            $('#edit_client_search_input').val(`${client.full_name} - ${documentType}: ${documentNumber}`);
                            $('#edit_client_search_input').addClass('client-selected');
                            $('#edit_client_search_input').attr('readonly', true);
                            $('.btn-clear-client').show();
                        }
                    }
                });
            }
        }

        function updateEditOrderDetailsTable() {
            $('#edit_order_details_body').empty();
            editOrderDetails.forEach(detail => {
                addEditDetailRow(detail);
            });
        }

        /*<td>
                <input type="text" class="form-control form-control-sm"
                       value="${detail.observation || ''}"
                       placeholder="Observación"
                       onkeyup="updateEditDetailField(${detail.id}, 'observation', this.value)">
            </td>*/

        function addEditDetailRow(detail) {
            const row = `
        <tr id="edit-detail-row-${detail.id}">
            <td class="text-center">${detail.id}</td>
            <td>
                <input type="text" class="form-control form-control-sm"
                       value="${detail.product_name}"
                       placeholder="Nombre del producto"
                       onkeyup="updateEditDetailField(${detail.id}, 'product_name', this.value)">
            </td>
            <td class="text-center">
                <input type="number" class="form-control form-control-sm"
                       value="${detail.quantity}"
                       min="0.01" step="0.01"
                       onkeyup="updateEditDetailField(${detail.id}, 'quantity', this.value)">
            </td>
            <td class="text-right">
                <input type="number" class="form-control form-control-sm"
                       value="${detail.price_unit}"
                       min="0" step="0.01"
                       onkeyup="updateEditDetailField(${detail.id}, 'price_unit', this.value)">
            </td>
            <td class="text-right font-weight-bold">
                S/ <span id="edit-subtotal-${detail.id}">${detail.subtotal.toFixed(2)}</span>
            </td>
            <td class="text-center">
                <button type="button" class="btn btn-danger btn-sm" onclick="removeEditDetail(${detail.id})">
                    <i class="fas fa-trash fa-2xs"></i>
                </button>
            </td>
        </tr>
    `;
            $('#edit_order_details_body').append(row);
        }

        function updateEditDetailField(detailId, field, value) {
            const detail = editOrderDetails.find(d => d.id === detailId);
            if (detail) {
                detail[field] = field === 'quantity' || field === 'price_unit' ? parseFloat(value) || 0 : value;
                detail.subtotal = detail.quantity * detail.price_unit;

                // Actualizar subtotal en la fila
                $(`#edit-subtotal-${detailId}`).text(detail.subtotal.toFixed(2));

                updateEditTotals();
            }
        }

        function removeEditDetail(detailId) {
            editOrderDetails = editOrderDetails.filter(d => d.id !== detailId);
            $(`#edit-detail-row-${detailId}`).remove();
            updateEditTotals();
            reorderEditRows();
        }

        function reorderEditRows() {
            $('#edit_order_details_body tr').each(function (index) {
                $(this).find('td:first').text(index + 1);
            });
        }

        function updateEditTotals() {
            const subtotal = editOrderDetails.reduce((sum, detail) => sum + detail.subtotal, 0);
            // El subtotal es el total sin IGV, el total es el subtotal + IGV
            // Pero en este caso, el subtotal ya incluye el IGV, así que calculamos el total real
            const total = subtotal; // El total es la suma de (cantidad * precio)
            const subtotalSinIGV = total / 1.18; // Calculamos el subtotal sin IGV
            const igv = total - subtotalSinIGV; // El IGV es la diferencia

            $('#edit_subtotal_total').text(`S/ ${subtotalSinIGV.toFixed(2)}`);
            $('#edit_igv_total').text(`S/ ${igv.toFixed(2)}`);
            $('#edit_total_final').text(`S/ ${total.toFixed(2)}`);

            // Actualizar adelanto y faltante
            updateEditAdvance();
        }

        function updateEditAdvance() {
            const total = parseFloat($('#edit_total_final').text().replace('S/ ', '').replace(',', '')) || 0;
            const advance = parseFloat($('#edit_advance_input').val()) || 0;
            // El faltante se calcula desde el total (IGV incluido)
            const remaining = total - advance;

            // Actualizar faltante
            $('#edit_remaining_amount').text(`S/ ${remaining.toFixed(2)}`);

            // Cambiar color del faltante según el valor
            const remainingRow = $('#edit_remaining_amount').closest('tr');
            if (remaining < 0) {
                remainingRow.removeClass('table-danger table-success').addClass('table-warning');
                $('#edit_remaining_amount').text(`S/ ${Math.abs(remaining).toFixed(2)} (Excedente)`);
            } else if (remaining === 0) {
                remainingRow.removeClass('table-danger table-warning').addClass('table-success');
                $('#edit_remaining_amount').text('S/ 0.00 (Pagado)');
            } else {
                remainingRow.removeClass('table-success table-warning').addClass('table-danger');
                $('#edit_remaining_amount').text(`S/ ${remaining.toFixed(2)}`);
            }
        }

        function searchEditProducts() {
            const searchTerm = $('#edit_product_search').val();
            const categoryId = $('#edit_product_category_filter').val();
            const productType = $('#edit_product_type_filter').val();

            if (!searchTerm || searchTerm.length < 2) {
                $('#edit_products_results').hide();
                return;
            }

            $.ajax({
                url: '{% url "apps.sales:get_products_for_order" %}',
                type: 'GET',
                data: {
                    'search': searchTerm,
                    'category_id': categoryId,
                    'product_type': productType
                },
                success: function (response) {
                    if (response.success && response.products.length > 0) {
                        displayEditProducts(response.products);
                        $('#edit_products_results').show();
                    } else {
                        $('#edit_products_list').html('<p class="text-muted text-center">No se encontraron productos</p>');
                        $('#edit_products_results').show();
                    }
                },
                error: function () {
                    toastr.error('Error al buscar productos', 'Error');
                }
            });
        }

        function displayEditProducts(products) {
            let html = '';
            products.forEach(product => {
                html += `
            <div class="product-item border-bottom p-2 cursor-pointer"
                 onclick="addEditProductToOrder(${product.id}, '${product.name}', ${product.price_sale}, '${product.unit}')">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <strong class="text-primary">${product.name}</strong>
                        <br><small class="text-muted">Código: ${product.code || 'N/A'}</small>
                        <br><small class="text-info">Categoría: ${product.category}</small>
                    </div>
                    <div class="text-right">
                        <span class="badge badge-success">S/ ${product.price_sale.toFixed(2)}</span>
                        <br><small class="text-muted">${product.unit}</small>
                    </div>
                </div>
            </div>
        `;
            });
            $('#edit_products_list').html(html);
        }

        function addEditProductToOrder(productId, productName, price, unit) {
            // Verificar si el producto ya está en la orden
            const existingDetail = editOrderDetails.find(detail => detail.product_id === productId);
            if (existingDetail) {
                existingDetail.quantity += 1;
                updateEditDetailRow(existingDetail);
            } else {
                const newDetail = {
                    id: ++editDetailCounter,
                    product_id: productId,
                    product_name: productName,
                    quantity: 1,
                    price_unit: price,
                    unit: unit,
                    observation: '',
                    subtotal: price
                };
                editOrderDetails.push(newDetail);
                addEditDetailRow(newDetail);
            }

            updateEditTotals();
            $('#edit_products_results').hide();
            $('#edit_product_search').val('');
        }

        function addEmptyEditProductRow() {
            const newDetail = {
                id: ++editDetailCounter,
                product_id: null,
                product_name: '',
                quantity: 1,
                price_unit: 0,
                unit: '',
                observation: '',
                subtotal: 0
            };
            editOrderDetails.push(newDetail);
            addEditDetailRow(newDetail);
        }

        function updateEditDetailRow(detail) {
            const row = $(`#edit-detail-row-${detail.id}`);
            row.find('input[placeholder="Nombre del producto"]').val(detail.product_name);
            row.find('input[type="number"]').first().val(detail.quantity);
            row.find('input[type="number"]').last().val(detail.price_unit);
            $(`#edit-subtotal-${detail.id}`).text(detail.subtotal.toFixed(2));
        }

        function updateOrder() {
            // Validar formulario
            if (!validateEditForm()) {
                return;
            }

            // Validar que haya al menos un detalle
            if (editOrderDetails.length === 0) {
                toastr.error('Debe agregar al menos un producto o servicio', 'Error');
                return;
            }

            // Preparar datos
            const formData = new FormData();

            // Agregar campos del formulario
            formData.append('order_id', $('#edit_order_id').val());
            formData.append('order_type', $('#edit_order_type').val());
            formData.append('client_id', $('#edit_client_id').val());
            formData.append('user_id', $('#edit_user_id').val());
            formData.append('subsidiary_id', $('#edit_subsidiary_id').val());
            formData.append('register_date', $('#edit_register_date').val());
            formData.append('delivery_date', $('#edit_delivery_date').val());
            formData.append('way_to_pay', $('#edit_way_to_pay').val());
            formData.append('cash_advance', $('#edit_advance_input').val());
            formData.append('voucher_type', $('#edit_voucher_type').val());
            formData.append('observation', $('#edit_observation').val());

            // Agregar detalles como JSON
            const detailsJson = JSON.stringify(editOrderDetails);
            formData.append('details', detailsJson);

            // Mostrar loading
            $('#loading-overlay').show();

            // Enviar formulario
            $.ajax({
                url: '{% url "apps.sales:order_update" %}',
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                success: function (response) {
                    if (response.success) {
                        toastr.success(response.message, '¡Éxito!');
                        $('#editOrderModal').modal('hide');
                        loadOrders();
                    } else {
                        toastr.error(response.message, 'Error');
                    }
                },
                error: function (xhr) {
                    let errorMessage = 'Error al actualizar la orden';
                    if (xhr.responseJSON && xhr.responseJSON.message) {
                        errorMessage = xhr.responseJSON.message;
                    }
                    toastr.error(errorMessage, 'Error');
                },
                complete: function () {
                    $('#loading-overlay').hide();
                }
            });
        }

        function validateEditForm() {
            const requiredFields = ['edit_order_type', 'edit_subsidiary_id', 'edit_user_id', 'edit_client_id'];

            for (const field of requiredFields) {
                const value = $(`#${field}`).val();
                if (!value) {
                    toastr.error('Por favor complete todos los campos obligatorios', 'Error');
                    $(`#${field}`).focus();
                    return false;
                }
            }

            return true;
        }

        $(document).on('change', '.status-select', function () {
            let order = $(this).attr('data-order-id');
            let status = $(this).val();
            updateOrderStatus(order, status)
        });

        function updateOrderStatus(orderId, newStatus) {
            const selectElement = $(`.status-select[data-order-id="${orderId}"]`);
            const originalValue = selectElement.attr('data-order-status');

            // Si no hay cambio de estado, no hacer nada
            if (newStatus === originalValue) {
                return;
            }

            // Manejar diferentes estados
            if (newStatus === 'C') {
                // Abrir modal para completar orden
                openCompleteOrderModal(orderId);
                // Restaurar valor original en el select
                selectElement.val(originalValue);
            } else if (newStatus === 'A') {
                // Abrir modal para anular orden
                openCancelOrderModal(orderId);
                // Restaurar valor original en el select
                selectElement.val(originalValue);
            } else if (newStatus === 'P') {
                // Cambiar a pendiente (confirmación simple)
                confirmStatusChange(orderId, newStatus, selectElement, originalValue);
            }
        }

        // Función para confirmar cambio de estado simple
        function confirmStatusChange(orderId, newStatus, selectElement, originalValue) {
            const statusMessages = {
                'P': 'PENDIENTE'
            };

            if (confirm(`¿Está seguro que desea cambiar el estado de la orden a ${statusMessages[newStatus]}?`)) {
                processStatusUpdate(orderId, newStatus, selectElement, originalValue);
            } else {
                // Restaurar valor original si se cancela
                selectElement.val(originalValue);
            }
        }

        // Función para procesar la actualización de estado
        function processStatusUpdate(orderId, newStatus, selectElement, originalValue) {
            // Deshabilitar temporalmente el select
            selectElement.prop('disabled', true);

            $.ajax({
                url: '{% url "apps.sales:update_order_status" %}',
                type: 'POST',
                data: {
                    'order_id': orderId,
                    'status': newStatus
                },
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                success: function (response) {
                    if (response.success) {
                        toastr.success(response.message, '¡Estado Actualizado!');

                        // Recargar la lista de órdenes
                        loadOrders();
                    } else {
                        toastr.error(response.message, 'Error');
                        selectElement.val(originalValue);
                        selectElement.prop('disabled', false);
                    }
                },
                error: function (xhr) {
                    let errorMessage = 'Error al actualizar el estado';
                    if (xhr.responseJSON && xhr.responseJSON.message) {
                        errorMessage = xhr.responseJSON.message;
                    }
                    toastr.error(errorMessage, 'Error');
                    selectElement.val(originalValue);
                    selectElement.prop('disabled', false);
                }
            });
        }

        // Función para abrir modal de completar orden
        function openCompleteOrderModal(orderId) {
            // Obtener información de la orden
            $.ajax({
                url: '{% url "apps.sales:get_order_for_completion" %}',
                type: 'GET',
                data: {'order_id': orderId},
                success: function (response) {
                    if (response.success) {
                        const order = response.order;

                        // Llenar información del modal
                        $('#complete_order_id').val(orderId);
                        $('#complete_order_balance').val(order.balance);
                        $('#complete_order_total').val(order.total);
                        $('#complete_payment_amount').val(order.balance);
                        $('#complete_payment_date').val(getServerDate());

                        // Guardar información del cliente
                        $('#complete_client_document').val(order.client.document);
                        $('#complete_client_name').val(order.client.full_name);

                        // Calcular y mostrar totales
                        calculateOrderTotals(order.total);

                        // Mostrar información de la orden
                        const orderInfo = `
                            <strong>Orden:</strong> ${order.serial}-${order.correlative.toString().padStart(3, '0')}<br>
                            <strong>Cliente:</strong> ${order.client.full_name}<br>
                            <strong>Total:</strong> S/ ${order.total}<br>
                            <strong>Adelanto:</strong> S/ ${order.cash_advance}<br>
                            <strong>Saldo:</strong> S/ ${order.balance}
                        `;
                        $('#complete-order-info').html(orderInfo);

                        // Limpiar campos del comprobante electrónico
                        resetElectronicDocumentFields();

                        // Mostrar modal
                        $('#completeOrderModal').modal('show');
                    } else {
                        toastr.error(response.message, 'Error');
                    }
                },
                error: function () {
                    toastr.error('Error al cargar la información de la orden', 'Error');
                }
            });
        }

        // Función para abrir modal de anular orden
        function openCancelOrderModal(orderId) {
            // Obtener información de la orden
            $.ajax({
                url: '{% url "apps.sales:get_order_for_cancellation" %}',
                type: 'GET',
                data: {'order_id': orderId},
                success: function (response) {
                    if (response.success) {
                        const order = response.order;

                        // Llenar información del modal
                        $('#cancel_order_id').val(orderId);
                        $('#cancel_order_advance').val(order.cash_advance);
                        $('#refund_amount').val(order.cash_advance);

                        // Mostrar información de la orden
                        const orderInfo = `
                            <strong>Orden:</strong> ${order.serial}-${order.correlative.toString().padStart(3, '0')}<br>
                            <strong>Cliente:</strong> ${order.client.full_name}<br>
                            <strong>Total:</strong> S/ ${order.total}<br>
                            <strong>Adelanto:</strong> S/ ${order.cash_advance}
                        `;
                        $('#cancel-order-info').html(orderInfo);

                        // Limpiar campos
                        $('#cancellation_reason').val('');
                        $('#refund_advance').prop('checked', false);
                        $('#refund_cash_account').val('');
                        $('#refund-details').hide();

                        // Mostrar modal
                        $('#cancelOrderModal').modal('show');
                    } else {
                        toastr.error(response.message, 'Error');
                    }
                },
                error: function () {
                    toastr.error('Error al cargar la información de la orden', 'Error');
                }
            });
        }

        // Función para calcular totales de la orden
        function calculateOrderTotals(total) {
            const totalAmount = parseFloat(total) || 0;
            const subtotal = totalAmount / 1.18; // Calcular subtotal sin IGV
            const igv = totalAmount - subtotal; // Calcular IGV

            // Mostrar totales en el modal
            $('#complete_subtotal').val(subtotal.toFixed(2));
            $('#complete_igv').val(igv.toFixed(2));
            $('#complete_total').val(totalAmount.toFixed(2));
        }

        // Función para resetear campos del comprobante electrónico
        function resetElectronicDocumentFields() {
            $('#emit_electronic_document').prop('checked', false);
            $('#document_type').val('');
            $('#document_number').val('');
            $('#client_full_name').val('');
            $('#client_address').val('');
            $('#electronic-document-panel').hide();

            // Limpiar validaciones
            $('#document_type').removeClass('is-invalid');
            $('#document_number').removeClass('is-invalid');
            $('#client_full_name').removeClass('is-invalid');
        }

        // Función para validar campos del comprobante electrónico
        function validateElectronicDocument() {
            const emitDocument = $('#emit_electronic_document').is(':checked');

            if (!emitDocument) {
                return true; // No es obligatorio si no se marca el checkbox
            }

            const documentType = $('#document_type').val();
            const documentNumber = $('#document_number').val();
            const clientName = $('#client_full_name').val();

            let isValid = true;

            // Validar tipo de documento
            if (!documentType) {
                $('#document_type').addClass('is-invalid');
                isValid = false;
            } else {
                $('#document_type').removeClass('is-invalid');
            }

            // Validar número de documento
            if (!documentNumber) {
                $('#document_number').addClass('is-invalid');
                isValid = false;
            } else {
                $('#document_number').removeClass('is-invalid');
            }

            // Validar nombre del cliente
            if (!clientName) {
                $('#client_full_name').addClass('is-invalid');
                isValid = false;
            } else {
                $('#client_full_name').removeClass('is-invalid');
            }

            return isValid;
        }

        // Función para confirmar la completación de la orden
        function confirmCompleteOrder() {
            const orderId = $('#complete_order_id').val();
            const paymentAmount = $('#complete_payment_amount').val();
            const paymentDate = $('#complete_payment_date').val();
            const cashAccountId = $('#complete_cash_account').val();
            const completedBy = $('#completed_by').val();

            if (!orderId || !paymentAmount || !paymentDate || !cashAccountId || !completedBy) {
                toastr.error('Por favor complete todos los campos obligatorios', 'Error');
                return;
            }

            // Validar campos del comprobante electrónico si está marcado
            if (!validateElectronicDocument()) {
                toastr.error('Por favor complete todos los campos del comprobante electrónico', 'Error');
                return;
            }

            if (confirm('¿Está seguro de completar la orden?\n\nSe registrará el pago del saldo faltante y se marcará la orden como completada')) {
                completeOrderWithPayment(orderId, paymentAmount, paymentDate, cashAccountId, completedBy);
            }
        }

        // Función para completar orden con pago
        function completeOrderWithPayment(orderId, paymentAmount, paymentDate, cashAccountId, completedBy) {
            // Mostrar loading
            const confirmButton = $('#completeOrderModal .btn-success');
            const originalText = confirmButton.html();
            confirmButton.html('<i class="fas fa-spinner fa-spin mr-1"></i>Procesando...');
            confirmButton.prop('disabled', true);

            // Preparar datos del comprobante electrónico si está marcado
            const emitDocument = $('#emit_electronic_document').is(':checked');
            const documentData = {};

            if (emitDocument) {
                documentData.emit_document = true;
                documentData.document_type = $('#document_type').val();
                documentData.document_number = $('#document_number').val();
                documentData.client_full_name = $('#client_full_name').val();
                documentData.client_address = $('#client_address').val();
            }

            $.ajax({
                url: '{% url "apps.sales:complete_order_with_payment" %}',
                type: 'POST',
                data: {
                    'order_id': orderId,
                    'payment_amount': paymentAmount,
                    'payment_date': paymentDate,
                    'cash_account_id': cashAccountId,
                    'completed_by': completedBy,
                    ...documentData
                },
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                success: function (response) {
                    if (response.success) {
                        let successMessage = response.message;

                        // Agregar información del comprobante si se generó
                        if (emitDocument && response.document_info) {
                            successMessage += `\n\nComprobante electrónico generado: ${response.document_info}`;
                        }

                        toastr.success(successMessage, '¡Orden Completada!');
                        $('#completeOrderModal').modal('hide');
                        loadOrders();
                    } else {
                        toastr.error(response.message, 'Error');
                    }
                },
                error: function (xhr) {
                    let errorMessage = 'Error al completar la orden';
                    if (xhr.responseJSON && xhr.responseJSON.message) {
                        errorMessage = xhr.responseJSON.message;
                    }
                    toastr.error(errorMessage, 'Error');
                },
                complete: function () {
                    // Restaurar botón
                    confirmButton.html(originalText);
                    confirmButton.prop('disabled', false);
                }
            });
        }

        // Función para confirmar la anulación de la orden
        function confirmCancelOrder() {
            const orderId = $('#cancel_order_id').val();
            const cancellationReason = $('#cancellation_reason').val();
            const refundAdvance = $('#refund_advance').is(':checked');
            const refundAmount = refundAdvance ? $('#refund_amount').val() : 0;
            const refundCashAccountId = $('#refund_cash_account').val();

            if (!orderId || !cancellationReason) {
                toastr.error('Por favor complete todos los campos', 'Error');
                return;
            }

            if (refundAdvance && !refundCashAccountId) {
                toastr.error('Debe seleccionar una cuenta de caja para la devolución', 'Error');
                return;
            }

            if (confirm('¿Está seguro de anular la orden?\n\nSe registrará el motivo de anulación y se marcará la orden como anulada')) {
                cancelOrderWithReason(orderId, cancellationReason, refundAdvance, refundAmount, refundCashAccountId);
            }
        }

        // Función para anular orden con motivo
        function cancelOrderWithReason(orderId, cancellationReason, refundAdvance, refundAmount, refundCashAccountId) {
            // Mostrar loading
            const confirmButton = $('#cancelOrderModal .btn-danger');
            const originalText = confirmButton.html();
            confirmButton.html('<i class="fas fa-spinner fa-spin mr-1"></i>Procesando...');
            confirmButton.prop('disabled', true);

            $.ajax({
                url: '{% url "apps.sales:cancel_order_with_reason" %}',
                type: 'POST',
                data: {
                    'order_id': orderId,
                    'cancellation_reason': cancellationReason,
                    'refund_advance': refundAdvance,
                    'refund_amount': refundAmount,
                    'refund_cash_account_id': refundCashAccountId
                },
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                success: function (response) {
                    if (response.success) {
                        toastr.success(response.message, '¡Orden Anulada!');
                        $('#cancelOrderModal').modal('hide');
                        loadOrders();
                    } else {
                        toastr.error(response.message, 'Error');
                    }
                },
                error: function (xhr) {
                    let errorMessage = 'Error al anular la orden';
                    if (xhr.responseJSON && xhr.responseJSON.message) {
                        errorMessage = xhr.responseJSON.message;
                    }
                    toastr.error(errorMessage, 'Error');
                },
                complete: function () {
                    // Restaurar botón
                    confirmButton.html(originalText);
                    confirmButton.prop('disabled', false);
                }
            });
        }

        // Función para cargar datos del cliente en el comprobante electrónico
        function loadClientDataForDocument() {
            // Los campos se mantienen vacíos para permitir búsqueda manual
            // $('#client_full_name').val('');
            // $('#document_number').val('');
        }

        // Función para buscar cliente en el comprobante electrónico
        function searchClientInElectronicDocument() {
            const documentType = $('#document_type').val();
            const documentNumber = $('#document_number').val();

            if (!documentType || !documentNumber) {
                toastr.error('Debe seleccionar el tipo de comprobante y escribir el número de documento', 'Error de validación');
                return;
            }

            // Determinar el tipo de documento según el tipo de comprobante
            let apiDocumentType = '';
            if (documentType === 'B') {
                // Para boleta, usar DNI (tipo 01)
                apiDocumentType = '01';
            } else if (documentType === 'F') {
                // Para factura, usar RUC (tipo 06)
                apiDocumentType = '06';
            }

            // Validar formato del documento antes de consultar
            if (apiDocumentType === '01' && documentNumber.length !== 8) {
                toastr.error('El DNI debe tener exactamente 8 dígitos', 'Error de validación');
                return;
            } else if (apiDocumentType === '06' && documentNumber.length !== 11) {
                toastr.error('El RUC debe tener exactamente 11 dígitos', 'Error de validación');
                return;
            }

            // Mostrar loading
            const numberField = $('#document_number');
            const searchButton = numberField.next('.input-group-append').find('button');
            const originalButtonContent = searchButton.html();
            
            numberField.prop('disabled', true);
            searchButton.prop('disabled', true);
            searchButton.html('<i class="fas fa-spinner fa-spin"></i>');

            $.ajax({
                url: '{% url "apps.sales:get_api_person" %}',
                type: 'GET',
                data: {
                    'nro_document': documentNumber,
                    'type': apiDocumentType
                },
                success: function (response) {
                    // Restaurar botón
                    numberField.prop('disabled', false);
                    searchButton.prop('disabled', false);
                    searchButton.html(originalButtonContent);

                    if (response.pk) {
                        // Cliente encontrado (en BD o API)
                        if (response.message === 'Cliente encontrado en BD') {
                            // Cliente ya existe en la base de datos
                            toastr.info('Cliente encontrado en la base de datos', 'Cliente existente');
                        } else {
                            // Cliente encontrado en API externa
                            toastr.success('Cliente encontrado y registrado automáticamente', '¡Cliente encontrado!');
                        }

                        // Llenar campos con la información obtenida
                        $('#client_full_name').val(response.names || '');
                        $('#client_address').val(response.address || '');

                        // Marcar como válido
                        numberField.addClass('is-valid');
                        numberField.removeClass('is-invalid');
                    } else {
                        // No se encontró el cliente
                        toastr.warning('Cliente no encontrado. Complete los datos manualmente.', 'Cliente no encontrado');

                        // Marcar como inválido
                        numberField.addClass('is-invalid');
                        numberField.removeClass('is-valid');

                        // Limpiar campos
                        $('#client_full_name').val('');
                        $('#client_address').val('');
                    }
                },
                error: function (xhr) {
                    // Restaurar botón
                    numberField.prop('disabled', false);
                    searchButton.prop('disabled', false);
                    searchButton.html(originalButtonContent);

                    let errorMessage = 'Error al consultar el documento';

                    if (xhr.responseJSON && xhr.responseJSON.error) {
                        errorMessage = xhr.responseJSON.error;
                    } else if (xhr.status === 500) {
                        errorMessage = 'Error interno del servidor';
                    } else if (xhr.status === 404) {
                        errorMessage = 'Servicio no disponible';
                    }

                    toastr.error(errorMessage, 'Error en la consulta');

                    // Marcar como inválido
                    numberField.addClass('is-invalid');
                    numberField.removeClass('is-valid');

                    // Limpiar campos
                    $('#client_full_name').val('');
                    $('#client_address').val('');
                }
            });
        }

        // Función para actualizar campos según el tipo de comprobante
        function updateDocumentFields(documentType) {
            const documentNumber = $('#document_number').val();
            const documentHelp = $('#document_help');

            if (documentType === 'B') {
                // BOLETA - DNI
                documentHelp.text('Ingrese el DNI del cliente (8 dígitos)');
                $('#document_number').attr('placeholder', 'DNI del cliente');
                $('#document_number').attr('maxlength', '8');

                // Validar formato DNI si ya hay un número
                if (documentNumber && documentNumber.length !== 8) {
                    $('#document_number').addClass('is-invalid');
                } else {
                    $('#document_number').removeClass('is-invalid');
                }

            } else if (documentType === 'F') {
                // FACTURA - RUC
                documentHelp.text('Ingrese el RUC del cliente (11 dígitos)');
                $('#document_number').attr('placeholder', 'RUC del cliente');
                $('#document_number').attr('maxlength', '11');

                // Validar formato RUC si ya hay un número
                if (documentNumber && documentNumber.length !== 11) {
                    $('#document_number').addClass('is-invalid');
                } else {
                    $('#document_number').removeClass('is-invalid');
                }
            }
        }

        // Función para restaurar el estado de la orden a pendiente
        function restoreOrderStatusToPending() {
            const orderId = $('#complete_order_id').val();
            if (orderId) {
                // Buscar el select de estado de la orden
                const statusSelect = document.querySelector(`select.status-select[data-order-id="${orderId}"]`);
                if (statusSelect) {
                    // Restaurar a pendiente silenciosamente
                    statusSelect.value = 'P';
                }
            }
        }

        // =============================================================================
        // FUNCIONES PARA EL ESTADO DE ENTREGA DE LAS ÓRDENES
        // =============================================================================

        /**
         * Función para actualizar el estado de entrega de una orden
         * @param {number} orderId - ID de la orden
         * @param {string} newDeliveryStatus - Nuevo estado de entrega
         */
        // Manejo centralizado: funciona con selects existentes y futuros (DOM dinámico)
        document.addEventListener('change', function (e) {
            const el = e.target;

            // Solo si es un delivery-select
            if (!el.classList || !el.classList.contains('delivery-select')) return;
            if (el.disabled) return;

            const orderId = el.getAttribute('data-order-id');
            const originalValue = el.getAttribute('data-original-value');
            const newDeliveryStatus = el.value;
            console.log("orderId",orderId)
            console.log("originalValue",originalValue)
            console.log("newDeliveryStatus",newDeliveryStatus)

            // Si no hubo cambio real, salir
            if (newDeliveryStatus === originalValue) return;

            // Seleccion relacionado por order-id
            const statusSelect = document.querySelector(`select.status-select[data-order-id="${orderId}"]`);

            // Regla: no permitir ENTREGADO si status está en P o A
            if (newDeliveryStatus === 'E' && statusSelect && ['P', 'A'].includes(statusSelect.value)) {
                showToast('warning', 'No se puede marcar como ENTREGADO una orden que está PENDIENTE o ANULADA. Primero debe completar la orden.');
                el.value = originalValue; // revertir visualmente
                // Revertir también los estilos visuales
                updateDeliverySelectStyles(el, originalValue);
                return;
            }

            // Abrir tu modal/flujo de confirmación
            openDeliveryStatusModal(orderId, newDeliveryStatus);

            // Mantener valor original hasta confirmar en el modal
            el.value = originalValue;
        });

        /*function updateOrderDeliveryStatus(orderId, newDeliveryStatus) {
            const deliverySelect = document.querySelector(`select.delivery-select[data-order-id="${orderId}"]`);
            const statusSelect = document.querySelector(`select.status-select[data-order-id="${orderId}"]`);
            const originalValue = deliverySelect.dataset.originalValue;

            console.log("deliverySelect", deliverySelect)
            console.log("statusSelect", statusSelect)
            console.log("originalValue", originalValue)
            // Si no hay cambio de estado, no hacer nada
            if (newDeliveryStatus === originalValue) {
                return;
            }

            // Validación del lado del cliente: No permitir ENTREGADO si el status es PENDIENTE o ANULADO
            if (newDeliveryStatus === 'E' && statusSelect && statusSelect.value in ['P', 'A']) {
                showToast('warning', 'No se puede marcar como ENTREGADO una orden que está PENDIENTE o ANULADA. Primero debe completar la orden.');
                deliverySelect.value = originalValue;
                return;
            }

            // Abrir modal para cambiar estado de entrega
            openDeliveryStatusModal(orderId, newDeliveryStatus);

            // Restaurar valor original en el select
            deliverySelect.value = originalValue;
        }*/

        /**
         * Función para abrir el modal de cambio de estado de entrega
         * @param {number} orderId - ID de la orden
         * @param {string} newDeliveryStatus - Nuevo estado de entrega
         */
        function openDeliveryStatusModal(orderId, newDeliveryStatus) {
            // Obtener información de la orden desde la tabla
            const orderRow = $(`#tbody-grid tr[order="${orderId}"]`);
            if (orderRow.length === 0) {
                toastr.error('No se pudo encontrar la información de la orden');
                return;
            }
            const orderCode = orderRow.find('td').eq(2).find('span').text().trim();
            const clientName = orderRow.find('td').eq(3).find('strong').text().trim();
            const currentDeliveryStatus = orderRow.find('.delivery-select option:selected').text().trim();

            /*console.log('Datos de la orden:', {
                orderId: orderId,
                orderCode: orderCode,
                clientName: clientName,
                currentDeliveryStatus: currentDeliveryStatus
            });*/

            // Llenar el modal con los datos
            $('#orderDeliveryStatusId').val(orderId);
            $('#orderDeliveryCode').val(orderCode);
            $('#deliveryClientName').val(clientName);
            $('#currentDeliveryStatus').val(currentDeliveryStatus);
            $('#newDeliveryStatus').val(newDeliveryStatus || '');
            $('#deliveredBy').val('');

            // Mostrar el modal
            $('#orderDeliveryStatusModal').modal('show');
        }

        /**
         * Función para guardar el cambio de estado de entrega
         * @param {number} orderId - ID de la orden
         */
        function saveDeliveryStatusChange(orderId) {
            const form = $('#orderDeliveryStatusForm');
            const formData = form.serialize();

            // Validar que se haya seleccionado un estado
            if (!$('#newDeliveryStatus').val()) {
                toastr.error('Debe seleccionar un nuevo estado de entrega');
                return;
            }

            // Validar que se haya seleccionado un empleado
            if (!$('#deliveredBy').val()) {
                toastr.error('Debe seleccionar un empleado');
                return;
            }

            $.ajax({
                url: '/sales/orders/update-delivery-status/',
                type: 'POST',
                data: formData,
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                success: function (response) {
                    if (response.success) {
                        toastr.success(response.message);
                        $('#orderDeliveryStatusModal').modal('hide');
                        // Recargar la tabla de órdenes
                        loadOrders();
                    } else {
                        toastr.error(response.message);
                    }
                },
                error: function (xhr, status, error) {
                    toastr.error('Error al actualizar el estado de entrega');
                    console.error('Error:', error);
                }
            });
        }

        /**
         * Función para actualizar los estilos visuales del select de entrega
         * @param {HTMLElement} selectElement - Elemento select
         * @param {string} newStatus - Nuevo estado
         */
        function updateDeliverySelectStyles(selectElement, newStatus) {
            // Remover clases de estado anteriores
            selectElement.classList.remove('delivery-select-pending', 'delivery-select-delivered', 'delivery-select-cancelled');

            // Agregar nueva clase de estado
            switch (newStatus) {
                case 'P':
                    selectElement.classList.add('delivery-select-pending');
                    break;
                case 'E':
                    selectElement.classList.add('delivery-select-delivered');
                    break;
                case 'C':
                    selectElement.classList.add('delivery-select-cancelled');
                    break;
            }
        }

        /**
         * Función para obtener el token CSRF de las cookies
         * @param {string} name - Nombre de la cookie
         * @returns {string} Token CSRF
         */
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        /**
         * Función para mostrar notificaciones toast
         * @param {string} type - Tipo de notificación (success, error, warning, info)
         * @param {string} message - Mensaje a mostrar
         */
        function showToast(type, message) {
            // Verificar si toastr está disponible
            if (typeof toastr !== 'undefined') {
                toastr[type](message);
            } else {
                // Fallback simple si toastr no está disponible
                const alertClass = type === 'success' ? 'alert-success' :
                    type === 'error' ? 'alert-danger' :
                        type === 'warning' ? 'alert-warning' : 'alert-info';

                const alertDiv = document.createElement('div');
                alertDiv.className = `alert ${alertClass} alert-dismissible fade show position-fixed`;
                alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
                alertDiv.innerHTML = `
                    ${message}
                    <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                `;

                document.body.appendChild(alertDiv);

                // Auto-remover después de 5 segundos
                setTimeout(() => {
                    if (alertDiv.parentNode) {
                        alertDiv.parentNode.removeChild(alertDiv);
                    }
                }, 5000);
            }
        }

        /**
         * Función para inicializar los estilos de los selects de entrega
         * Se ejecuta cuando se carga la página
         */
        function initializeDeliverySelects() {
            const deliverySelects = document.querySelectorAll('.delivery-select');

            deliverySelects.forEach(select => {
                const currentStatus = select.getAttribute('data-delivery-status');
                updateDeliverySelectStyles(select, currentStatus);
            });
        }


        $(document).on('click', '#saveOrderDeliveryStatus', function () {
            var form = $('#orderDeliveryStatusForm');
            var formData = form.serialize();

            // Validar que se haya seleccionado un estado
            if (!$('#newDeliveryStatus').val()) {
                toastr.error('Debe seleccionar un nuevo estado de entrega');
                return;
            }

            // Validar que se haya seleccionado un empleado
            if (!$('#deliveredBy').val()) {
                toastr.error('Debe seleccionar un empleado');
                return;
            }

            $.ajax({
                url: '/sales/orders/update-delivery-status/',
                type: 'POST',
                data: formData,
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                success: function (response) {
                    if (response.success) {
                        toastr.success(response.message);
                        $('#orderDeliveryStatusModal').modal('hide');
                        // Recargar la tabla de órdenes
                        loadOrders();
                    } else {
                        toastr.error(response.message);
                    }
                },
                error: function (xhr, status, error) {
                    toastr.error('Error al actualizar el estado de entrega');
                    console.error('Error:', error);
                }
            });
        });


    </script>

    <style>
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .card {
            box-shadow: 0 0 1px rgba(0, 0, 0, .125), 0 1px 3px rgba(0, 0, 0, .2);
            margin-bottom: 1rem;
        }

        .card-header {
            background-color: rgba(0, 0, 0, .03);
            border-bottom: 1px solid rgba(0, 0, 0, .125);
        }

        .btn {
            border-radius: 0.25rem;
            font-weight: 500;
        }

        .form-control {
            border-radius: 0.25rem;
        }

        .table th {
            border-top: none;
            font-weight: 600;
            color: #495057;
        }

        .form-label {
            font-weight: 600;
            color: #495057;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
        }

        .form-control {
            font-size: 0.875rem;
            padding: 0.375rem 0.75rem;
        }

        .modal-xl {
            max-width: 1200px;
        }

        .modal-header {
            border-bottom: 1px solid rgba(0, 0, 0, .125);
        }

        .modal-footer {
            border-top: 1px solid rgba(0, 0, 0, .125);
        }

        /* Estilos para productos */
        .product-item {
            cursor: pointer;
            transition: all 0.2s ease;
        }

        /* Estilos para la tabla de órdenes */
        #orders-grid {
            width: 100%;
            overflow-x: auto;
        }

        #orders-grid .table-responsive {
            border: none;
            box-shadow: none;
        }

        #orders-grid .card {
            border: none;
            box-shadow: none;
        }

        #orders-grid .card-body {
            padding: 0;
        }

        .product-item:hover {
            background-color: #f8f9fa;
            border-left: 3px solid #007bff;
        }

        .product-item.selected {
            background-color: #007bff !important;
            color: white !important;
            border-left: 3px solid #0056b3;
        }

        .product-item.selected strong,
        .product-item.selected small {
            color: white !important;
        }

        .product-item.selected .badge {
            background-color: white !important;
            color: #007bff !important;
        }

        /* Estilos para campos deshabilitados */
        .disabled-field {
            background-color: #e9ecef !important;
            color: #6c757d !important;
            cursor: not-allowed;
        }

        .disabled-field:focus {
            box-shadow: none !important;
            border-color: #ced4da !important;
        }

        .product-item:last-child {
            border-bottom: none !important;
        }

        /* Estilos para la tabla de detalles */
        #order_details_table, #edit_order_details_table {
            font-size: 0.875rem;
        }

        #order_details_table th, #edit_order_details_table th {
            font-size: 0.8rem;
            padding: 0.5rem;
            white-space: nowrap;
        }

        #order_details_table td, #edit_order_details_table td {
            padding: 0.5rem;
            vertical-align: middle;
        }

        /* Estilos responsive para las tablas de detalles */
        @media (max-width: 1200px) {
            #order_details_table, #edit_order_details_table {
                font-size: 0.8rem;
            }

            #order_details_table th, #edit_order_details_table th,
            #order_details_table td, #edit_order_details_table td {
                padding: 0.375rem;
            }
        }

        @media (max-width: 768px) {
            #order_details_table, #edit_order_details_table {
                font-size: 0.75rem;
            }

            #order_details_table th, #edit_order_details_table th,
            #order_details_table td, #edit_order_details_table td {
                padding: 0.25rem;
            }

            /* Ocultar columna de observación en móviles pequeños */
            #order_details_table th:nth-child(3),
            #order_details_table td:nth-child(3),
            #edit_order_details_table th:nth-child(3),
            #edit_order_details_table td:nth-child(3) {
                display: none;
            }

            /* Ajustar colspan en móviles */
            #order_details_table tfoot td[colspan="5"],
            #edit_order_details_table tfoot td[colspan="5"] {
                colspan: 4;
            }
        }

        @media (max-width: 576px) {
            #order_details_table, #edit_order_details_table {
                font-size: 0.7rem;
            }

            /* Ocultar más columnas en móviles muy pequeños */
            #order_details_table th:nth-child(3),
            #order_details_table td:nth-child(3),
            #edit_order_details_table th:nth-child(3),
            #edit_order_details_table td:nth-child(3) {
                display: none;
            }

            /* Ajustar colspan en móviles muy pequeños */
            #order_details_table tfoot td[colspan="5"],
            #edit_order_details_table tfoot td[colspan="5"] {
                colspan: 3;
            }
        }

        .form-control-sm {
            font-size: 0.8rem;
            padding: 0.25rem 0.5rem;
            height: auto;
        }

        /* Estilos para los totales */
        .table-info {
            background-color: #d1ecf1 !important;
        }

        .table-success {
            background-color: #d4edda !important;
        }

        /* Estilos para badges y elementos especiales */
        .badge {
            font-size: 0.75em;
            padding: 0.375em 0.75em;
        }

        .cursor-pointer {
            cursor: pointer;
        }

        /* Responsive adjustments */
        @media (max-width: 1200px) {
            .modal-xl {
                max-width: 95%;
                margin: 1.75rem auto;
            }
        }


        @media (max-width: 768px) {
            .col-md-3 {
                margin-bottom: 1rem;
            }

            .modal-xl {
                max-width: 98%;
                margin: 0.5rem auto;
            }
        }

        /* Animaciones */
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Estilos para el scroll de productos */
        #products_list {
            max-height: 200px;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: #007bff #f8f9fa;
        }

        #products_list::-webkit-scrollbar {
            width: 6px;
        }

        #products_list::-webkit-scrollbar-track {
            background: #f8f9fa;
        }

        #products_list::-webkit-scrollbar-thumb {
            background: #007bff;
            border-radius: 3px;
        }

        #products_list::-webkit-scrollbar-thumb:hover {
            background: #0056b3;
        }

        /* Estilos para el input group del cliente */
        .input-group-append .btn {
            border-left: 0;
            border-top-left-radius: 0;
            border-bottom-left-radius: 0;
        }

        .input-group-append .btn:hover {
            background-color: #28a745;
            border-color: #28a745;
            color: white;
        }

        /* Estilos para el modal de cliente */
        #createClientModal .modal-header {
            background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
        }

        #createClientModal .form-label {
            font-weight: 600;
            color: #495057;
            margin-bottom: 0.5rem;
        }

        #createClientModal .form-control {
            border-radius: 0.375rem;
            border: 1px solid #ced4da;
            transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        }

        #createClientModal .form-control:focus {
            border-color: #17a2b8;
            box-shadow: 0 0 0 0.2rem rgba(23, 162, 184, 0.25);
        }

        /* Estilos para el textarea de observaciones */
        #observation {
            resize: vertical;
            min-height: 80px;
            font-family: inherit;
            line-height: 1.5;
        }

        #observation:focus {
            border-color: #007bff;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        }

        /* Mejoras en el modal principal */
        #createOrderModal .modal-body {
            max-height: 80vh;
            overflow-y: auto;
        }

        /* Estilos para los campos de fecha */
        input[type="date"] {
            font-family: inherit;
        }

        /* Estilos para selects */
        select.form-control {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
        }

        /* Estilos para el botón de guardar cliente */
        #createClientModal .btn-info {
            background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
            border: none;
            font-weight: 600;
            padding: 0.5rem 1.5rem;
            transition: all 0.3s ease;
        }

        #createClientModal .btn-info:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(23, 162, 184, 0.3);
        }

        /* Estilos para el botón de cancelar */
        #createClientModal .btn-secondary {
            background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%);
            border: none;
            font-weight: 600;
            padding: 0.5rem 1.5rem;
            transition: all 0.3s ease;
        }

        #createClientModal .btn-secondary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(108, 117, 125, 0.3);
        }

        /* Estilos para el modal de edición */
        #editOrderModal .modal-header {
            background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%);
        }

        #editOrderModal .form-label {
            font-weight: 600;
            color: #495057;
            margin-bottom: 0.75rem;
        }

        #editOrderModal .form-control {
            border-radius: 0.75rem !important;
            border: 2px solid #ced4da;
            transition: all 0.3s ease;
        }

        #editOrderModal .form-control:focus {
            border-color: #ffc107;
            box-shadow: 0 0 0 0.2rem rgba(255, 193, 7, 0.25);
            transform: translateY(-1px);
        }

        #editOrderModal .btn-warning {
            background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%);
            border: none;
            font-weight: 600;
            padding: 0.5rem 1.5rem;
            transition: all 0.3s ease;
        }

        #editOrderModal .btn-warning:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(255, 193, 7, 0.3);
        }

        #editOrderModal .modal-body {
            max-height: 80vh;
            overflow-y: auto;
            padding: 1.5rem;
        }

        /* Estilos específicos para los campos de edición */
        #edit_observation {
            resize: vertical;
            min-height: 80px;
            font-family: inherit;
            line-height: 1.5;
        }

        #edit_advance_input {
            text-align: right;
            font-weight: 600;
            color: #28a745;
            background-color: #f8f9fa;
            border: 2px solid #28a745;
        }

        #edit_advance_input:focus {
            background-color: white;
            border-color: #28a745;
            box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25);
        }

        /* Estilos para la tabla de detalles de edición */
        #edit_order_details_table {
            font-size: 0.875rem;
        }

        #edit_order_details_table th {
            font-size: 0.8rem;
            padding: 0.5rem;
        }

        #edit_order_details_table td {
            padding: 0.5rem;
            vertical-align: middle;
        }

        /* Estilos para los totales de edición */
        #edit_subtotal_total, #edit_igv_total, #edit_total_final, #edit_remaining_amount {
            font-weight: 700;
        }

        /* Responsive adjustments para el modal de edición */
        @media (max-width: 1200px) {
            #editOrderModal .modal-xl {
                max-width: 95%;
                margin: 1.75rem auto;
            }
        }

        /* Estilos para dispositivos móviles y tablets */
        @media (max-width: 768px) {
            /* Ajustar modales en móviles */
            .modal-xl {
                max-width: 98% !important;
                margin: 0.5rem !important;
            }

            .modal-body {
                padding: 1rem !important;
            }

            /* Ajustar formularios en móviles */
            .form-group {
                margin-bottom: 1rem !important;
            }

            /* Ajustar botones en móviles */
            .btn {
                padding: 0.5rem 1rem !important;
                font-size: 0.9rem !important;
            }

            /* Ajustar inputs en móviles */
            .form-control {
                font-size: 16px !important; /* Evita zoom en iOS */
            }

            /* Mejorar visualización de tablas en móviles */
            .table-responsive {
                border-radius: 10px !important;
                margin-bottom: 1rem;
            }

            .table {
                font-size: 0.8rem !important;
            }

            .table th, .table td {
                padding: 0.375rem !important;
            }
        }

        @media (max-width: 576px) {
            /* Ajustes para móviles muy pequeños */
            .modal-xl {
                max-width: 100% !important;
                margin: 0 !important;
                border-radius: 0 !important;
            }

            .modal-header, .modal-footer {
                padding: 0.75rem !important;
            }

            .modal-body {
                padding: 0.75rem !important;
            }

            /* Ajustar grid de filtros */
            .col-md-2, .col-md-3 {
                margin-bottom: 0.5rem;
            }

            /* Ajustar botones de filtro */
            .btn-sm {
                padding: 0.5rem 1rem !important;
                font-size: 0.85rem !important;
            }
        }

        @media (max-width: 768px) {
            #editOrderModal .modal-xl {
                max-width: 98%;
                margin: 0.5rem auto;
            }

            #editOrderModal .form-control {
                border-radius: 0.5rem !important;
            }
        }

        @media (max-width: 576px) {
            #editOrderModal .modal-dialog {
                margin: 0.5rem;
                max-width: calc(100% - 1rem);
            }

            #editOrderModal .modal-body {
                padding: 1rem;
            }
        }

        /* Animaciones para el modal de cliente */
        #createClientModal .modal-content {
            animation: slideInUp 0.3s ease-out;
        }

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Estilos para el placeholder del textarea */
        #observation::placeholder {
            color: #6c757d;
            font-style: italic;
            opacity: 0.7;
        }

        /* Estilos para el input group del cliente */
        .input-group .form-control:focus {
            z-index: 3;
        }

        .input-group .form-control:focus + .input-group-append .btn {
            border-color: #007bff;
        }

        /* Responsive adjustments para el modal de cliente */
        @media (max-width: 576px) {
            #createClientModal .modal-dialog {
                margin: 0.5rem;
                max-width: calc(100% - 1rem);
            }

            #createClientModal .modal-body {
                padding: 1rem;
            }

            #createClientModal .form-group {
                margin-bottom: 1rem;
            }
        }

        /* Estilos para inputs más redondeados */
        .form-control {
            border-radius: 0.75rem !important;
            border: 2px solid #e9ecef;
            transition: all 0.3s ease;
            font-size: 0.875rem;
            padding: 0.5rem 0.75rem;
        }

        .form-control:focus {
            border-color: #007bff;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
            transform: translateY(-1px);
        }

        .form-control-sm {
            border-radius: 0.5rem !important;
            font-size: 0.8rem;
            padding: 0.375rem 0.75rem;
            height: auto;
            border: 1px solid #ced4da;
        }

        .form-control-sm:focus {
            border-color: #007bff;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        }

        /* Estilos para selects */
        select.form-control {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.75rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
        }

        /* Estilos para el textarea */
        textarea.form-control {
            border-radius: 0.75rem !important;
            resize: vertical;
            min-height: 80px;
            font-family: inherit;
            line-height: 1.5;
            border: 2px solid #e9ecef;
        }

        textarea.form-control:focus {
            border-color: #007bff;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
            transform: translateY(-1px);
        }

        /* Estilos para botones */
        .btn {
            border-radius: 0.75rem !important;
            font-weight: 500;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .btn-sm {
            border-radius: 0.5rem !important;
            padding: 0.25rem 0.75rem;
            font-size: 0.75rem;
        }

        /* Estilos para el input group */
        .input-group .form-control {
            border-radius: 0.75rem 0 0 0.75rem !important;
        }

        .input-group-append .btn {
            border-radius: 0 0.75rem 0.75rem 0 !important;
            border-left: 0;
            border-top-left-radius: 0 !important;
            border-bottom-left-radius: 0 !important;
        }

        /* Estilos para la tabla de totales */
        .table-info {
            background: linear-gradient(135deg, #d1ecf1 0%, #bee5eb 100%) !important;
        }

        .table-warning {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%) !important;
        }

        .table-success {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%) !important;
        }

        .table-danger {
            background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%) !important;
        }

        /* Estilos para el input de adelanto */
        #advance_input {
            text-align: right;
            font-weight: 600;
            color: #28a745;
            background-color: #f8f9fa;
            border: 2px solid #28a745;
        }

        #advance_input:focus {
            background-color: white;
            border-color: #28a745;
            box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25);
        }

        /* Estilos para el campo de observación en detalles */
        #order_details_table input[placeholder="Observación"],
        #edit_order_details_table input[placeholder="Observación"] {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 6px;
            border: 1px solid #ced4da;
            transition: all 0.2s ease;
        }

        #order_details_table input[placeholder="Observación"]:focus,
        #edit_order_details_table input[placeholder="Observación"]:focus {
            border-color: #007bff;
            box-shadow: 0 0 0 0.15rem rgba(0, 123, 255, 0.25);
            transform: translateY(-1px);
        }

        /* Estilos responsive para el campo de observación */
        @media (max-width: 768px) {
            #order_details_table input[placeholder="Observación"],
            #edit_order_details_table input[placeholder="Observación"] {
                font-size: 0.7rem;
                padding: 0.2rem 0.4rem;
            }
        }

        /* Estilos para campos de observación en móviles */
        @media (max-width: 576px) {
            #order_details_table input[placeholder="Observación"],
            #edit_order_details_table input[placeholder="Observación"] {
                font-size: 0.65rem;
                padding: 0.15rem 0.3rem;
                min-width: 80px;
            }
        }

        /* Estilos para campos de observación en tablets */
        @media (min-width: 769px) and (max-width: 1024px) {
            #order_details_table input[placeholder="Observación"],
            #edit_order_details_table input[placeholder="Observación"] {
                font-size: 0.8rem;
                padding: 0.3rem 0.6rem;
            }
        }

        /* Estilos para alineación de columnas en las tablas de detalles */
        #order_details_table td:nth-child(1),
        #edit_order_details_table td:nth-child(1) {
            text-align: center;
            font-weight: 600;
        }

        #order_details_table td:nth-child(4),
        #edit_order_details_table td:nth-child(4) {
            text-align: center;
        }

        #order_details_table td:nth-child(5),
        #edit_order_details_table td:nth-child(5) {
            text-align: right;
        }

        #order_details_table td:nth-child(6),
        #edit_order_details_table td:nth-child(6) {
            text-align: right;
        }

        #order_details_table td:nth-child(7),
        #edit_order_details_table td:nth-child(7) {
            text-align: center;
        }

        /* Estilos para inputs de cantidad */
        #order_details_table input[type="number"][min="0.01"],
        #edit_order_details_table input[type="number"][min="0.01"] {
            text-align: center;
            font-weight: 600;
        }

        /* Estilos para inputs de precio */
        #order_details_table input[type="number"][min="0"],
        #edit_order_details_table input[type="number"][min="0"] {
            text-align: right;
            font-weight: 600;
        }

        /* Estilos para el faltante */
        #remaining_amount {
            font-size: 1.1rem;
            font-weight: 700;
        }

        /* Mejoras en el modal principal */
        #createOrderModal .modal-body {
            max-height: 80vh;
            overflow-y: auto;
            padding: 1.5rem;
        }

        /* Estilos para los campos de fecha */
        input[type="date"] {
            font-family: inherit;
            border-radius: 0.75rem !important;
        }

        /* Estilos para labels */
        .form-label {
            font-weight: 600;
            color: #495057;
            margin-bottom: 0.75rem;
            font-size: 0.875rem;
            display: block;
        }

        /* Estilos para grupos de formulario */
        .form-group {
            margin-bottom: 1.25rem;
        }

        /* Estilos para el placeholder */
        .form-control::placeholder {
            color: #6c757d;
            opacity: 0.7;
            font-style: italic;
        }

        /* Estilos para el input group del cliente */
        .input-group-append .btn {
            border-left: 0;
            border-top-left-radius: 0 !important;
            border-bottom-left-radius: 0 !important;
        }

        .input-group-append .btn:hover {
            background-color: #28a745;
            border-color: #28a745;
            color: white;
            transform: translateY(-2px);
        }

        /* Estilos para el modal de cliente */
        #createClientModal .modal-header {
            background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
        }

        #createClientModal .form-label {
            font-weight: 600;
            color: #495057;
            margin-bottom: 0.75rem;
        }

        #createClientModal .form-control {
            border-radius: 0.75rem !important;
            border: 2px solid #ced4da;
            transition: all 0.3s ease;
        }

        #createClientModal .form-control:focus {
            border-color: #17a2b8;
            box-shadow: 0 0 0 0.2rem rgba(23, 162, 184, 0.25);
            transform: translateY(-1px);
        }

        /* Estilos para el botón de guardar cliente */
        #createClientModal .btn-info {
            background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
            border: none;
            font-weight: 600;
            padding: 0.5rem 1.5rem;
            transition: all 0.3s ease;
        }

        #createClientModal .btn-info:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(23, 162, 184, 0.3);
        }

        /* Estilos para el botón de cancelar */
        #createClientModal .btn-secondary {
            background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%);
            border: none;
            font-weight: 600;
            padding: 0.5rem 1.5rem;
            transition: all 0.3s ease;
        }

        #createClientModal .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(108, 117, 125, 0.3);
        }

        /* Animaciones para el modal de cliente */
        #createClientModal .modal-content {
            animation: slideInUp 0.3s ease-out;
        }

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Responsive adjustments */
        @media (max-width: 1200px) {
            .modal-xl {
                max-width: 95%;
                margin: 1.75rem auto;
            }
        }

        @media (max-width: 768px) {
            .col-md-3 {
                margin-bottom: 1rem;
            }

            .modal-xl {
                max-width: 98%;
                margin: 0.5rem auto;
            }

            .form-control {
                border-radius: 0.5rem !important;
            }
        }

        @media (max-width: 576px) {
            #createClientModal .modal-dialog {
                margin: 0.5rem;
                max-width: calc(100% - 1rem);
            }

            #createClientModal .modal-body {
                padding: 1rem;
            }

            #createClientModal .form-group {
                margin-bottom: 1rem;
            }
        }

        /* Estilos para cards redondeadas */
        .card {
            border-radius: 15px !important;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1), 0 1px 3px rgba(0, 0, 0, 0.08);
            border: none;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.15), 0 3px 6px rgba(0, 0, 0, 0.1);
        }

        .card-header {
            border-radius: 15px 15px 0 0 !important;
            border-bottom: 1px solid rgba(0, 0, 0, 0.125);
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        }

        .card-body {
            border-radius: 0 0 15px 15px !important;
        }

        /* Estilos para botones redondeados */
        .btn {
            border-radius: 25px !important;
            font-weight: 500;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .btn-sm {
            border-radius: 20px !important;
            padding: 0.375rem 1rem;
        }

        /* Estilos para inputs redondeados */
        .form-control {
            border-radius: 10px !important;
            border: 2px solid #e9ecef;
            transition: all 0.3s ease;
        }

        .form-control:focus {
            border-color: #007bff;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
            transform: translateY(-1px);
        }

        /* Estilos para selects redondeados */
        select.form-control {
            border-radius: 10px !important;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.75rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
        }

        /* Estilos para badges redondeados */
        .badge {
            border-radius: 20px !important;
            font-weight: 500;
            padding: 0.5rem 1rem;
        }

        /* Estilos para la tabla redondeada */
        .table-responsive {
            border-radius: 15px !important;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .table {
            border-radius: 15px !important;
            overflow: hidden;
        }

        /* Estilos para tablas responsive */
        .table-responsive {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            position: relative;
        }

        /* Indicador de scroll horizontal */
        .table-responsive::after {
            content: '← Deslizar →';
            position: absolute;
            bottom: -25px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 123, 255, 0.1);
            color: #007bff;
            padding: 5px 15px;
            border-radius: 15px;
            font-size: 0.75rem;
            font-weight: 500;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }

        .table-responsive:hover::after {
            opacity: 1;
        }

        /* Ocultar indicador en dispositivos que no necesitan scroll */
        @media (min-width: 1200px) {
            .table-responsive::after {
                display: none;
            }
        }

        /* Scrollbar personalizado para tablas */
        .table-responsive::-webkit-scrollbar {
            height: 8px;
        }

        .table-responsive::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .table-responsive::-webkit-scrollbar-thumb {
            background: #007bff;
            border-radius: 4px;
        }

        .table-responsive::-webkit-scrollbar-thumb:hover {
            background: #0056b3;
        }

        /* Indicador de scroll horizontal */
        .table-responsive::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, #007bff, transparent);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .table-responsive:hover::after {
            opacity: 1;
        }

        .table thead th {
            border-radius: 15px 15px 0 0 !important;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        }

        /* Estilos para modales redondeados */
        .modal-content {
            border-radius: 20px !important;
            border: none;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .modal-header {
            border-radius: 20px 20px 0 0 !important;
            border-bottom: 1px solid rgba(0, 0, 0, 0.125);
        }

        .modal-footer {
            border-radius: 0 0 20px 20px !important;
            border-top: 1px solid rgba(0, 0, 0, 0.125);
        }

        /* Estilos para alertas redondeadas */
        .alert {
            border-radius: 15px !important;
            border: none;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        /* Estilos para el loading overlay redondeado */
        .loading-overlay {
            border-radius: 20px !important;
        }

        /* Estilos para tooltips redondeados */
        .tooltip .tooltip-inner {
            border-radius: 10px !important;
        }

        /* Estilos para popovers redondeados */
        .popover {
            border-radius: 15px !important;
            border: none;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        /* Estilos para dropdowns redondeados */
        .dropdown-menu {
            border-radius: 15px !important;
            border: none;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        /* Estilos para paginación redondeada */
        .pagination .page-link {
            border-radius: 10px !important;
            margin: 0 2px;
            border: none;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .pagination .page-item.active .page-link {
            border-radius: 10px !important;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        /* Estilos para tabs redondeados */
        .nav-tabs .nav-link {
            border-radius: 15px 15px 0 0 !important;
            border: none;
            margin-right: 5px;
        }

        .nav-tabs .nav-link.active {
            border-radius: 15px 15px 0 0 !important;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        /* Estilos para list groups redondeados */
        .list-group-item {
            border-radius: 10px !important;
            margin-bottom: 5px;
            border: none;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        /* Estilos para breadcrumbs redondeados */
        .breadcrumb {
            border-radius: 15px !important;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border: none;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .breadcrumb-item + .breadcrumb-item::before {
            border-radius: 50%;
        }

        /* Estilos para progress bars redondeados */
        .progress {
            border-radius: 15px !important;
            height: 10px;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .progress-bar {
            border-radius: 15px !important;
        }

        /* Estilos para jumbotron redondeado */
        .jumbotron {
            border-radius: 20px !important;
            border: none;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        /* Estilos para wells redondeados */
        .well {
            border-radius: 15px !important;
            border: none;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        /* Estilos para panels redondeados */
        .panel {
            border-radius: 15px !important;
            border: none;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .panel-heading {
            border-radius: 15px 15px 0 0 !important;
        }

        .panel-body {
            border-radius: 0 0 15px 15px !important;
        }

        /* Estilos para thumbnails redondeados */
        .thumbnail {
            border-radius: 15px !important;
            border: none;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        /* Estilos para media objects redondeados */
        .media {
            border-radius: 15px !important;
            padding: 15px;
            background: white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        /* Estilos para responsive */
        @media (max-width: 768px) {
            .card {
                border-radius: 10px !important;
            }

            .btn {
                border-radius: 20px !important;
            }

            .form-control {
                border-radius: 8px !important;
            }

            .modal-content {
                border-radius: 15px !important;
            }
        }

        /* Estilos para mensajes informativos */
        .alert-info {
            background: linear-gradient(135deg, #d1ecf1 0%, #bee5eb 100%);
            border: none;
            color: #0c5460;
            font-weight: 500;
        }

        .alert-info .fas {
            color: #17a2b8;
        }

        /* Estilos para alertas de responsividad */
        .alert-warning {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            border: none;
            color: #856404;
            font-weight: 500;
        }

        .alert-warning .fas {
            color: #ffc107;
        }

        /* Ocultar alertas de responsividad en móviles */
        @media (max-width: 768px) {
            .d-none.d-md-block {
                display: none !important;
            }
        }

        /* Estilos para el mensaje de no hay órdenes */
        .text-muted .fas.fa-calendar-day {
            color: #17a2b8 !important;
            opacity: 0.8;
        }

        .gap-2 {
            gap: 0.5rem !important;
        }

        /* Estilos para botones de acción en mensajes */
        .btn-outline-info {
            border-color: #17a2b8;
            color: #17a2b8;
            background-color: transparent;
        }

        .btn-outline-info:hover {
            background-color: #17a2b8;
            border-color: #17a2b8;
            color: white;
        }

        /* Estilos para responsive */
        @media (max-width: 768px) {
            .card {
                border-radius: 10px !important;
            }

            .btn {
                border-radius: 20px !important;
            }

            .form-control {
                border-radius: 8px !important;
            }

            .modal-content {
                border-radius: 15px !important;
            }

            .d-flex.justify-content-center.gap-2 {
                flex-direction: column;
                align-items: center;
            }

            .gap-2 .btn {
                margin-bottom: 0.5rem;
                width: 100%;
                max-width: 250px;
            }
        }

        /* Estilos para el indicador de fecha */
        #date-indicator {
            font-size: 0.9rem;
            font-weight: 500;
            color: #6c757d;
            transition: all 0.3s ease;
        }

        #date-indicator:hover {
            color: #495057;
            transform: translateX(5px);
        }

        /* Estilos para el título principal */
        .content-header h1 {
            transition: all 0.3s ease;
        }

        .content-header h1:hover {
            transform: translateY(-2px);
        }

        .content-header h1 small {
            transition: all 0.3s ease;
        }

        .content-header h1:hover small {
            color: #007bff !important;
        }

        /* Estilos para mensajes informativos */
        .alert-info {
            background: linear-gradient(135deg, #d1ecf1 0%, #bee5eb 100%);
            border: none;
            color: #0c5460;
            font-weight: 500;
        }

        .alert-info .fas {
            color: #17a2b8;
        }

        /* Estilos para filtros compactos */
        .compact-filters {
            margin-bottom: 1rem !important;
            border-radius: 12px !important;
        }

        .compact-header {
            padding: 0.75rem 1rem !important;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-bottom: 1px solid rgba(0, 0, 0, 0.125);
        }

        .compact-header h6 {
            font-size: 0.95rem;
            font-weight: 600;
            color: #495057;
            margin: 0;
        }

        .compact-body {
            padding: 0.75rem 1rem !important;
        }

        /* Estilos para labels compactos */
        .form-label-sm {
            font-size: 0.75rem !important;
            font-weight: 600;
            color: #6c757d;
            margin-bottom: 0.25rem !important;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Estilos para inputs compactos */
        .form-control-sm {
            height: 32px !important;
            padding: 0.25rem 0.5rem !important;
            font-size: 0.8rem !important;
            border-radius: 8px !important;
            border: 1px solid #ced4da;
        }

        .form-control-sm:focus {
            border-color: #007bff;
            box-shadow: 0 0 0 0.15rem rgba(0, 123, 255, 0.25);
            transform: translateY(-1px);
        }

        /* Estilos para selects compactos */
        select.form-control-sm {
            padding-right: 1.5rem !important;
            background-size: 1em !important;
            background-position: right 0.5rem center !important;
        }

        /* Estilos para grupos de formulario compactos */
        .form-group.mb-1 {
            margin-bottom: 0.5rem !important;
        }

        /* Estilos para botones compactos */
        .btn-sm {
            padding: 0.375rem 0.75rem !important;
            font-size: 0.8rem !important;
            border-radius: 20px !important;
            font-weight: 500;
        }

        /* Estilos para alertas compactas */
        .alert-sm {
            padding: 0.5rem 0.75rem !important;
            margin-bottom: 0.5rem !important;
            border-radius: 8px !important;
            font-size: 0.8rem !important;
        }

        .alert-sm .fas {
            font-size: 0.75rem !important;
        }

        .alert-sm small {
            font-size: 0.75rem !important;
            line-height: 1.2;
        }

        /* Estilos para el grid de filtros */
        .g-2 {
            --bs-gutter-x: 0.5rem;
            --bs-gutter-y: 0.5rem;
        }

        .g-2 > * {
            padding-right: calc(var(--bs-gutter-x) * 0.5);
            padding-left: calc(var(--bs-gutter-x) * 0.5);
            margin-top: calc(var(--bs-gutter-y) * 0.5);
            margin-bottom: calc(var(--bs-gutter-y) * 0.5);
        }

        /* Estilos para el contenedor de botones */
        .row.mt-2 {
            margin-top: 0.5rem !important;
        }

        /* Estilos para responsive en filtros compactos */
        @media (max-width: 768px) {
            .compact-body {
                padding: 0.5rem !important;
            }

            .compact-header {
                padding: 0.5rem !important;
            }

            .form-control-sm {
                height: 36px !important;
                font-size: 0.85rem !important;
            }

            .form-label-sm {
                font-size: 0.8rem !important;
            }

            .alert-sm {
                padding: 0.75rem !important;
                font-size: 0.85rem !important;
            }
        }

        @media (max-width: 576px) {
            .compact-filters {
                margin-bottom: 0.5rem !important;
            }

            .compact-body {
                padding: 0.5rem !important;
            }

            .form-group.mb-1 {
                margin-bottom: 0.75rem !important;
            }

            .col-md-2 {
                margin-bottom: 0.5rem;
            }
        }

        /* Estilos para el botón de toggle */
        #toggle-filters {
            border-radius: 20px !important;
            padding: 0.375rem 0.75rem !important;
            font-size: 0.8rem !important;
            transition: all 0.3s ease;
            border: 1px solid #6c757d;
            color: #6c757d;
        }

        #toggle-filters:hover {
            background-color: #6c757d;
            border-color: #6c757d;
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        #toggle-filters:focus {
            box-shadow: 0 0 0 0.2rem rgba(108, 117, 125, 0.25);
        }

        /* Estilos para la transición de colapsar/expandir */
        .compact-body {
            transition: all 0.3s ease;
        }

        .compact-body.sliding {
            overflow: hidden;
        }

        /* Estilos para el icono de toggle */
        #toggle-icon {
            transition: transform 0.3s ease;
        }

        #toggle-filters:hover #toggle-icon {
            transform: scale(1.1);
        }

        /* Estilos para filtros compactos */
        .compact-filters {
            margin-bottom: 1rem !important;
            border-radius: 12px !important;
        }

        /* Estilos para el contador de órdenes */
        #orders-count {
            font-size: 0.85rem;
            font-weight: 500;
            color: #6c757d;
            transition: all 0.3s ease;
        }

        #orders-count:hover {
            color: #007bff;
            transform: translateX(5px);
        }

        #orders-count .fas {
            color: #17a2b8;
            font-size: 0.8rem;
        }

        #orders-count-text {
            font-style: italic;
        }

        /* Estilos para el botón de actualizar */
        .card-tools .btn-outline-primary {
            border-radius: 20px !important;
            padding: 0.375rem 0.75rem !important;
            font-size: 0.8rem !important;
            transition: all 0.3s ease;
            border: 1px solid #007bff;
            color: #007bff;
        }

        .card-tools .btn-outline-primary:hover {
            background-color: #007bff;
            border-color: #007bff;
            color: white;
            transform: translateY(-1px) rotate(180deg);
            box-shadow: 0 2px 4px rgba(0, 123, 255, 0.2);
        }

        .card-tools .btn-outline-primary:focus {
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        }

        /* Estilos para el botón de toggle */
        #toggle-filters {
            border-radius: 20px !important;
            padding: 0.375rem 0.75rem !important;
            font-size: 0.8rem !important;
            transition: all 0.3s ease;
            border: 1px solid #6c757d;
            color: #6c757d;
        }

        /* Estilos para el botón de nueva orden */
        .btn-success.ml-3 {
            margin-left: 1rem !important;
            padding: 0.5rem 1.25rem !important;
            font-size: 0.9rem !important;
            font-weight: 600 !important;
            border-radius: 25px !important;
            transition: all 0.3s ease;
            border: 2px solid #28a745;
            box-shadow: 0 2px 4px rgba(40, 167, 69, 0.2);
        }

        .btn-success.ml-3:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(40, 167, 69, 0.3);
            background-color: #218838;
            border-color: #1e7e34;
        }

        .btn-success.ml-3:focus {
            box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25);
        }

        /* Estilos para el contador de órdenes */

        /* Estilos para campos de adelanto */
        #cash_advance, #edit_cash_advance {
            border: 2px solid #28a745 !important;
            background-color: #f8f9fa;
            color: #28a745;
            font-weight: 600;
            text-align: center;
            transition: all 0.3s ease;
        }

        #cash_advance:focus, #edit_cash_advance:focus {
            background-color: white;
            border-color: #28a745;
            box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25);
            transform: translateY(-1px);
        }

        #cash_advance:hover, #edit_cash_advance:hover {
            background-color: white;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(40, 167, 69, 0.2);
        }

        /* Estilos para el botón de nueva orden */

        /* Estilos para el autocompletado de clientes */
        .client-autocomplete-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ced4da;
            border-top: none;
            border-radius: 0 0 8px 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            max-height: 200px;
            overflow-y: auto;
            z-index: 1050;
            margin-top: -1px;
        }

        .client-autocomplete-item {
            padding: 0.75rem;
            border-bottom: 1px solid #f1f3f4;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .client-autocomplete-item:hover {
            background-color: #f8f9fa;
            border-left: 3px solid #007bff;
        }

        .client-autocomplete-item:last-child {
            border-bottom: none;
        }

        .client-autocomplete-item .client-info {
            flex: 1;
        }

        .client-autocomplete-item .client-name {
            color: #007bff;
            font-weight: 600;
            font-size: 0.9rem;
            margin-bottom: 0.25rem;
        }

        .client-autocomplete-item .client-document {
            color: #6c757d;
            font-size: 0.8rem;
        }

        .client-autocomplete-item .client-address {
            color: #17a2b8;
            font-size: 0.75rem;
            font-style: italic;
        }

        .client-autocomplete-item .client-phone {
            color: #28a745;
            font-size: 0.75rem;
            text-align: right;
        }

        .client-autocomplete-item.selected {
            background-color: #e3f2fd;
            border-left: 3px solid #2196f3;
        }

        /* Estilos para el input de búsqueda de cliente */
        #client_search_input, #edit_client_search_input {
            border-radius: 0.5rem 0 0 0.5rem !important;
            transition: all 0.3s ease;
        }

        #client_search_input:focus, #edit_client_search_input:focus {
            border-color: #007bff;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
            transform: translateY(-1px);
        }

        /* Estilos para el indicador de cliente seleccionado */
        .client-selected {
            background-color: #f8fff9 !important;
            border-color: #28a745 !important;
            color: #155724 !important;
        }

        .client-selected::placeholder {
            color: #155724 !important;
            font-weight: 600;
        }

        /* Estilos para el botón de limpiar cliente */
        .btn-clear-client {
            border-radius: 0 0.5rem 0.5rem 0 !important;
            border-left: 0;
            padding: 0.375rem 0.75rem;
            font-size: 0.8rem;
            transition: all 0.3s ease;
        }

        .btn-clear-client:hover {
            background-color: #dc3545;
            border-color: #dc3545;
            color: white;
            transform: translateY(-1px);
        }

        /* Estilos para el estado de carga del autocompletado */
        .client-autocomplete-loading {
            text-align: center;
            padding: 1rem;
            color: #6c757d;
            font-style: italic;
        }

        .client-autocomplete-loading .fas {
            margin-right: 0.5rem;
            color: #007bff;
        }

        /* Estilos para mensaje de no hay resultados */
        .client-autocomplete-no-results {
            text-align: center;
            padding: 1rem;
            color: #6c757d;
            font-style: italic;
            background-color: #f8f9fa;
        }

        /* Estilos para el indicador de cliente seleccionado */
        .client-selected-indicator {
            position: absolute;
            top: 0.25rem;
            right: 0.5rem;
            color: #28a745;
            font-size: 0.8rem;
        }

        /* Responsive para el autocompletado */
        @media (max-width: 768px) {
            .client-autocomplete-results {
                max-height: 150px;
                font-size: 0.8rem;
            }

            .client-autocomplete-item {
                padding: 0.5rem;
            }

            .client-autocomplete-item .client-name {
                font-size: 0.8rem;
            }

            .client-autocomplete-item .client-document,
            .client-autocomplete-item .client-address,
            .client-autocomplete-item .client-phone {
                font-size: 0.7rem;
            }
        }

        .client-suggestion-item {
            padding: 0.75rem;
            border-bottom: 1px solid #f1f3f4;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .client-suggestion-item:hover {
            background-color: #f8f9fa;
            border-left: 3px solid #007bff;
        }

        .client-suggestion-item:last-child {
            border-bottom: none;
        }

        .client-suggestion-item .text-primary {
            color: #007bff !important;
            font-weight: 600;
        }

        .client-suggestion-item .text-muted {
            color: #6c757d !important;
            font-size: 0.8rem;
        }

        .client-suggestion-item .text-info {
            color: #17a2b8 !important;
            font-size: 0.75rem;
        }

        /* Responsive para el filtro de cliente */
        @media (max-width: 768px) {
            .col-md-3 {
                margin-bottom: 0.5rem;
            }

            .client-suggestions {
                max-height: 150px;
            }
        }

        /* Estilos para el input group del filtro de cliente */
        .input-group .form-control-sm {
            border-radius: 0.5rem 0 0 0.5rem !important;
        }

        .input-group-append .btn-sm {
            border-radius: 0 0.5rem 0.5rem 0 !important;
            border-left: 0;
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
        }

        .input-group-append .btn-outline-secondary:hover {
            background-color: #6c757d;
            border-color: #6c757d;
            color: white;
        }

        /* Estilos para la notificación de cliente seleccionado */
        #client-notification {
            margin-bottom: 0;
            padding: 0.5rem 0.75rem;
            border-radius: 8px;
            font-size: 0.75rem;
        }

        #client-notification .fas {
            font-size: 0.7rem;
        }

        /* Estilos para el campo de cliente cuando es válido */
        #client-search.is-valid {
            border-color: #28a745;
            background-color: #f8fff9;
        }

        #client-search.is-valid:focus {
            border-color: #28a745;
            box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25);
        }

        /* Estilos para el indicador de búsqueda en API */
        .search-indicator {
            font-size: 0.8rem;
            color: #007bff;
            font-weight: 500;
        }

        .search-indicator .fas {
            margin-right: 0.25rem;
        }

        /* Estilos para los modales de estado */
        #completeOrderModal .modal-header {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%) !important;
        }

        #cancelOrderModal .modal-header {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%) !important;
        }

        /* Estilos para el checkbox personalizado */
        .custom-control-input:checked ~ .custom-control-label::before {
            background-color: #dc3545;
            border-color: #dc3545;
        }

        .custom-control-input:focus ~ .custom-control-label::before {
            box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
        }

        /* Estilos para los campos de devolución */
        #refund-details {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
        }

        /* Estilos para los campos de pago */
        #complete_payment_amount {
            background-color: #f8fff9;
            border-color: #28a745;
            color: #155724;
            font-weight: 600;
        }

        #refund_amount {
            background-color: #fff8f8;
            border-color: #dc3545;
            color: #721c24;
            font-weight: 600;
        }

        /* Estilos para las alertas informativas */
        #completeOrderModal .alert-info {
            background: linear-gradient(135deg, #d1ecf1 0%, #bee5eb 100%);
            border: none;
            border-left: 4px solid #17a2b8;
        }

        #cancelOrderModal .alert-warning {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            border: none;
            border-left: 4px solid #ffc107;
        }

        /* Estilos para los botones de los modales */
        #completeOrderModal .btn-success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            border: none;
            font-weight: 600;
            padding: 0.5rem 1.5rem;
            transition: all 0.3s ease;
        }

        #completeOrderModal .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(40, 167, 69, 0.3);
        }

        #cancelOrderModal .btn-danger {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            border: none;
            font-weight: 600;
            padding: 0.5rem 1.5rem;
            transition: all 0.3s ease;
        }

        #cancelOrderModal .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(220, 53, 69, 0.3);
        }

        /* Responsive para los modales */
        @media (max-width: 768px) {
            #completeOrderModal .modal-dialog,
            #cancelOrderModal .modal-dialog {
                margin: 0.5rem;
                max-width: calc(100% - 1rem);
            }

            #completeOrderModal .modal-body,
            #cancelOrderModal .modal-body {
                padding: 1rem;
            }

            #refund-details {
                padding: 0.75rem;
            }
        }

        /* Estilos para el campo de número cuando está cargando */
        #new_client_number.loading {
            background-color: #f8f9fa;
            border-color: #007bff;
        }

        /* Estilos para campos de cliente cuando son válidos */
        #new_client_number.is-valid {
            border-color: #28a745;
            background-color: #f8fff9;
        }

        #new_client_number.is-valid:focus {
            border-color: #28a745;
            box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25);
        }

        /* Estilos para campos de cliente cuando son inválidos */
        #new_client_number.is-invalid {
            border-color: #dc3545;
            background-color: #fff8f8;
        }

        #new_client_number.is-invalid:focus {
            border-color: #dc3545;
            box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
        }

        /* Estilos para el elemento kbd */
        kbd {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 0.25rem;
            color: #495057;
            font-size: 0.75em;
            font-weight: 600;
            padding: 0.125rem 0.25rem;
            box-shadow: inset 0 -1px 0 #dee2e6;
        }

        /* =============================================================================
         * ESTILOS PARA EL SELECT DE ESTADO DE ENTREGA DE LAS ÓRDENES
         * ============================================================================= */

        /* Estilos base para el select de entrega */
        .delivery-select {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 0.5rem;
            border: 2px solid #ced4da;
            background-color: white;
            transition: all 0.3s ease;
            cursor: pointer;
            min-width: 120px;
            text-align: center;
            font-weight: 600;
        }

        .delivery-select:focus {
            border-color: #007bff;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
            outline: none;
        }

        .delivery-select:disabled {
            background-color: #e9ecef;
            color: #6c757d;
            cursor: not-allowed;
            opacity: 0.8;
            border-color: #ced4da;
        }

        /* Estilos específicos para cada estado */
        .delivery-select option[value="P"] {
            color: #856404;
            background-color: #fff3cd;
            font-weight: 600;
        }

        .delivery-select option[value="E"] {
            color: #155724;
            background-color: #d4edda;
            font-weight: 600;
        }

        .delivery-select option[value="C"] {
            color: #721c24;
            background-color: #f8d7da;
            font-weight: 600;
        }

        /* Indicadores visuales para cada estado usando clases CSS */
        .delivery-select-pending {
            border-color: #ffc107 !important;
            background-color: #fff3cd !important;
            color: #856404 !important;
        }

        .delivery-select-delivered {
            border-color: #28a745 !important;
            background-color: #d4edda !important;
            color: #155724 !important;
        }

        .delivery-select-cancelled {
            border-color: #dc3545 !important;
            background-color: #f8d7da !important;
            color: #721c24 !important;
        }

        /* Hover effects */
        .delivery-select:not(:disabled):hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        /* Estilos para el contenedor del estado de entrega */
        .d-flex.flex-column.align-items-center {
            min-width: 140px;
        }

        /* Responsive para el select de entrega */
        @media (max-width: 768px) {
            .delivery-select {
                font-size: 0.7rem;
                padding: 0.2rem 0.4rem;
                min-width: 100px;
            }

            .d-flex.flex-column.align-items-center {
                min-width: 120px;
            }
        }

        /* Estilos para estados bloqueados */
        .delivery-select.delivery-select-delivered,
        .delivery-select.delivery-select-cancelled {
            opacity: 0.8;
            cursor: not-allowed;
        }

        /* Estilos para validación de estado */
        .delivery-select.validation-error {
            border-color: #dc3545;
            background-color: #f8d7da;
            color: #721c24;
            animation: shake 0.5s ease-in-out;
        }

        @keyframes shake {
            0%, 100% {
                transform: translateX(0);
            }
            25% {
                transform: translateX(-5px);
            }
            75% {
                transform: translateX(5px);
            }
        }

        /* Animaciones de transición */
        .delivery-select {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .delivery-select:not(:disabled):active {
            transform: translateY(0);
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        /* Estilos para estados deshabilitados específicos */
        .delivery-select:disabled.delivery-select-delivered {
            background-color: #d4edda !important;
            color: #155724 !important;
            border-color: #28a745 !important;
        }

        .delivery-select:disabled.delivery-select-cancelled {
            background-color: #f8d7da !important;
            color: #721c24 !important;
            border-color: #dc3545 !important;
        }

        /* Estilos para el texto informativo */
        .form-text.text-info {
            font-size: 0.8rem;
            margin-top: 0.25rem;
        }

        .form-text.text-info .fas {
            color: #17a2b8;
        }

        /* Estilos para el botón de búsqueda en el input group */
        #new_client_number + .input-group-append .btn {
            border-left: 0;
            border-top-left-radius: 0;
            border-bottom-left-radius: 0;
            transition: all 0.3s ease;
        }

        #new_client_number + .input-group-append .btn:hover {
            background-color: #007bff;
            border-color: #007bff;
            color: white;
            transform: translateY(-1px);
        }

        #new_client_number + .input-group-append .btn:focus {
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        }


        /* Estilos para el modal cuando cambia a modo selección */
        #createClientModal .modal-header.bg-success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%) !important;
        }

        /* Estilos para el botón de selección */
        #createClientModal .btn-success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%) !important;
            border: none;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        #createClientModal .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(40, 167, 69, 0.3);
        }

        /* Estilos para el panel de comprobante electrónico */
        #electronic-document-panel {
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        #electronic-document-panel .card-header {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%) !important;
            border: none;
        }

        #electronic-document-panel .card-header h6 {
            color: white;
            font-weight: 600;
            margin: 0;
        }

        /* Estilos para los campos del comprobante electrónico */
        #document_type, #document_number, #client_full_name, #client_address {
            border-radius: 10px;
            border: 2px solid #e9ecef;
            transition: all 0.3s ease;
        }

        #document_type:focus, #document_number:focus, #client_full_name:focus, #client_address:focus {
            border-color: #007bff;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
            transform: translateY(-1px);
        }

        /* Estilos para campos válidos */
        #document_type.is-valid, #document_number.is-valid, #client_full_name.is-valid {
            border-color: #28a745;
            background-color: #f8fff9;
        }

        /* Estilos para campos inválidos */
        #document_type.is-invalid, #document_number.is-invalid, #client_full_name.is-invalid {
            border-color: #dc3545;
            background-color: #fff8f8;
        }

        /* Estilos para el checkbox personalizado */
        .custom-control-input:checked ~ .custom-control-label::before {
            background-color: #007bff;
            border-color: #007bff;
        }

        .custom-control-input:focus ~ .custom-control-label::before {
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        }

        /* Estilos para los totales en el modal */
        #complete_subtotal, #complete_igv, #complete_total {
            background-color: #f8f9fa;
            border: 2px solid #e9ecef;
            font-weight: 700;
            color: #495057;
        }

        #complete_subtotal:focus, #complete_igv:focus, #complete_total:focus {
            background-color: white;
            border-color: #007bff;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        }

        /* Estilos para el modal de completar orden */
        #completeOrderModal .modal-lg {
            max-width: 800px;
        }

        #completeOrderModal .card {
            border: none;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        #completeOrderModal .card-header {
            border-bottom: 1px solid rgba(0, 0, 0, 0.125);
        }

        /* Responsive para el modal de completar orden */
        @media (max-width: 768px) {
            #completeOrderModal .modal-lg {
                max-width: 95%;
                margin: 0.5rem auto;
            }

            #electronic-document-panel .card-body {
                padding: 1rem;
            }

            .col-md-4, .col-md-6 {
                margin-bottom: 1rem;
            }
        }

        /* Estilos para el indicador de cliente listo */
        #client-ready-indicator {
            border: none;
            border-radius: 10px;
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
            color: #155724;
            border-left: 4px solid #28a745;
            animation: slideInDown 0.5s ease-out;
        }

        #client-ready-indicator .fas {
            color: #28a745;
        }

        #client-ready-indicator .btn-outline-success {
            border-color: #28a745;
            color: #28a745;
            border-radius: 20px;
            font-size: 0.8rem;
            padding: 0.25rem 0.75rem;
            transition: all 0.3s ease;
        }

        #client-ready-indicator .btn-outline-success:hover {
            background-color: #28a745;
            border-color: #28a745;
            color: white;
            transform: translateY(-1px);
        }

        @keyframes slideInDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>

    <script>
        // =============================================================================
        // FUNCIONES PARA CONVERTIR ÓRDENES A ÓRDENES DE SERVICIO
        // =============================================================================

        /**
         * Función para abrir el modal de conversión de orden
         * @param {number} orderId - ID de la orden a convertir
         */
        function openConvertOrderModal(orderId) {
            // Limpiar formulario
            $('#convert-order-form')[0].reset();
            $('#convert_order_id').val(orderId);
            
            // Obtener datos de la orden
            $.ajax({
                url: '{% url "apps.sales:get_order_for_conversion" %}',
                type: 'GET',
                data: {
                    'order_id': orderId
                },
                success: function(response) {
                    if (response.success) {
                        const order = response.order;
                        
                        // Llenar información de la orden actual
                        $('#convert_current_code').val(order.code);
                        $('#convert_client_name').val(order.client_name);
                        $('#convert_register_date').val(order.register_date);
                        $('#convert_current_total').val('S/ ' + order.total.toFixed(2));
                        
                        // Llenar configuración de la nueva orden
                        $('#convert_register_date_new').val(order.register_date);
                        $('#convert_delivery_date').val(order.delivery_date);
                        $('#convert_way_to_pay').val(order.way_to_pay);
                        $('#convert_cash_advance').val(order.cash_advance);
                        $('#convert_observation').val(order.observation);
                        
                        // Seleccionar sucursal si existe
                        if (order.subsidiary_id) {
                            $('#convert_subsidiary_id').val(order.subsidiary_id);
                            updateConvertCorrelative();
                        }
                        
                        // Cargar productos/servicios
                        loadConvertOrderDetails(order.details);
                        
                        // Mostrar modal
                        $('#convertOrderModal').modal('show');
                    } else {
                        showToast('error', response.message);
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error al obtener datos de la orden:', error);
                    showToast('error', 'Error al cargar los datos de la orden');
                }
            });
        }

        /**
         * Función para actualizar el correlativo cuando se selecciona una sucursal
         */
        function updateConvertCorrelative() {
            const subsidiaryId = $('#convert_subsidiary_id').val();
            
            if (subsidiaryId) {
                const selectedOption = $('#convert_subsidiary_id option:selected');
                const serial = selectedOption.data('serial');
                
                $('#convert_serial').val(serial);
                
                // Obtener correlativo para orden de servicio
                $.ajax({
                    url: '{% url "apps.sales:get_correlative_order" %}',
                    type: 'GET',
                    data: {
                        'doc_type': 'O',
                        'subsidiary_id': subsidiaryId
                    },
                    success: function(response) {
                        if (response.success) {
                            $('#convert_correlative').val(response.correlative);
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('Error al obtener correlativo:', error);
                    }
                });
            } else {
                $('#convert_serial').val('');
                $('#convert_correlative').val('');
            }
        }

        /**
         * Función para cargar los detalles de la orden en la tabla
         * @param {Array} details - Array de detalles de la orden
         */
        function loadConvertOrderDetails(details) {
            const tbody = $('#convert-products-tbody');
            tbody.empty();
            
            let subtotal = 0;
            
            details.forEach((detail, index) => {
                const row = `
                    <tr>
                        <td class="text-center">${index + 1}</td>
                        <td>${detail.product_name}</td>
                        <td class="text-center">${detail.quantity}</td>
                        <td class="text-right">S/ ${detail.price_unit.toFixed(2)}</td>
                        <td class="text-right">S/ ${detail.total.toFixed(2)}</td>
                    </tr>
                `;
                tbody.append(row);
                subtotal += detail.total;
            });
            
            // Calcular totales
            const igv = subtotal * 0.18;
            const total = subtotal;
            
            $('#convert-subtotal').text('S/ ' + (subtotal / 1.18).toFixed(2));
            $('#convert-igv').text('S/ ' + igv.toFixed(2));
            $('#convert-total').text('S/ ' + total.toFixed(2));
        }

        /**
         * Función para convertir la orden a orden de servicio
         */
        function convertToServiceOrder() {
            // Validar formulario
            const form = $('#convert-order-form')[0];
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }
            
            // Mostrar confirmación
            Swal.fire({
                title: '¿Confirmar conversión?',
                text: '¿Está seguro que desea convertir esta cotización a Orden de Servicio?',
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#28a745',
                cancelButtonColor: '#6c757d',
                confirmButtonText: 'Sí, convertir',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    // Enviar datos
                    const formData = new FormData($('#convert-order-form')[0]);
                    
                    $.ajax({
                        url: '{% url "apps.sales:convert_order_to_service" %}',
                        type: 'POST',
                        data: formData,
                        processData: false,
                        contentType: false,
                        success: function(response) {
                            if (response.success) {
                                showToast('success', response.message);
                                $('#convertOrderModal').modal('hide');
                                
                                // Recargar la lista de órdenes
                                loadOrders();
                                
                                // Mostrar mensaje de éxito con el nuevo código
                                Swal.fire({
                                    title: '¡Conversión exitosa!',
                                    text: `La orden ha sido convertida exitosamente. Nuevo código: ${response.new_code}`,
                                    icon: 'success',
                                    confirmButtonColor: '#28a745'
                                });
                            } else {
                                showToast('error', response.message);
                            }
                        },
                        error: function(xhr, status, error) {
                            console.error('Error al convertir orden:', error);
                            showToast('error', 'Error al convertir la orden');
                        }
                    });
                }
            });
        }

        // Event listener para el cambio de sucursal en el modal de conversión
        $(document).on('change', '#convert_subsidiary_id', function() {
            updateConvertCorrelative();
        });
    </script>


{% endblock extrajs %}
